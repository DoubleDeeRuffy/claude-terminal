---
phase: 06-resume-claude-sessions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/events/index.js
  - src/renderer/services/TerminalSessionService.js
  - src/renderer/ui/components/TerminalManager.js
autonomous: true
requirements:
  - SESS-01
  - SESS-02
  - SESS-03
  - SESS-04

must_haves:
  truths:
    - "SESSION_START events from hooks provider capture session IDs and store them on the correct terminal's termData"
    - "TerminalSessionService serializes claudeSessionId per tab in terminal-sessions.json"
    - "Only hooks-sourced SESSION_START events with truthy sessionId update the stored value (scraping events are ignored)"
    - "resumeSession() termData includes mode: 'terminal' and cwd: project.path so it is included in session persistence"
    - "Terminal ID correlation uses the latest-terminal-ID heuristic for the given projectId"
  artifacts:
    - path: "src/renderer/events/index.js"
      provides: "wireSessionIdCapture consumer and findClaudeTerminalForProject helper"
      contains: "wireSessionIdCapture"
    - path: "src/renderer/services/TerminalSessionService.js"
      provides: "claudeSessionId field in serialized tab data"
      contains: "claudeSessionId"
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "resumeSession termData with mode and cwd fields"
      contains: "mode: 'terminal'"
  key_links:
    - from: "src/renderer/events/index.js"
      to: "src/renderer/state/terminals.state.js"
      via: "updateTerminal(terminalId, { claudeSessionId }) on SESSION_START"
      pattern: "updateTerminal.*claudeSessionId"
    - from: "src/renderer/events/index.js"
      to: "src/renderer/services/TerminalSessionService.js"
      via: "saveTerminalSessions() triggered after session ID capture"
      pattern: "saveTerminalSessions"
    - from: "src/renderer/services/TerminalSessionService.js"
      to: "~/.claude-terminal/terminal-sessions.json"
      via: "claudeSessionId added to each tab object during serialization"
      pattern: "claudeSessionId"
---

<objective>
Capture Claude session IDs from hooks events and persist them per-terminal in terminal-sessions.json. Also fix resumeSession() termData to include mode and cwd so resumed sessions are tracked for future restarts.

Purpose: This plan creates the session ID capture and persistence infrastructure. Plan 06-02 wires the resume path into the startup restore loop and adds failure detection.
Output: SESSION_START events update termData.claudeSessionId, TerminalSessionService serializes it, resumeSession() termData is complete.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-resume-claude-sessions/06-RESEARCH.md
@src/renderer/events/index.js
@src/renderer/services/TerminalSessionService.js
@src/renderer/ui/components/TerminalManager.js
@src/renderer/state/terminals.state.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wireSessionIdCapture consumer and findClaudeTerminalForProject helper to events/index.js</name>
  <files>src/renderer/events/index.js</files>
  <action>
Add two new functions and wire the consumer into initClaudeEvents:

**1. Add `findClaudeTerminalForProject(projectId)` helper** (place after `resolveTerminalId` function, around line 150):
```js
/**
 * Find the most recently created Claude terminal for a project.
 * Uses latest-terminal-ID heuristic (IDs are monotonically incrementing integers).
 * When a project has only one Claude terminal, this is unambiguous.
 * TODO: improve correlation for multi-terminal same-project edge case
 * @param {string} projectId
 * @returns {number|null} terminal ID or null
 */
function findClaudeTerminalForProject(projectId) {
  try {
    const { terminalsState } = require('../state/terminals.state');
    const terminals = terminalsState.get().terminals;
    let bestId = null;
    let bestNumericId = -1;
    for (const [id, td] of terminals) {
      if (td.project?.id !== projectId) continue;
      if (td.mode !== 'terminal') continue;
      if (td.isBasic) continue;
      if (id > bestNumericId) { bestNumericId = id; bestId = id; }
    }
    return bestId;
  } catch (e) { return null; }
}
```

**2. Add `wireSessionIdCapture()` consumer function** (place after `wireTerminalStatusConsumer`, before `wireDebugListener`):
```js
// ── Consumer: Session ID Capture (hooks-only — captures Claude session IDs for restart resume) ──
function wireSessionIdCapture() {
  consumerUnsubscribers.push(
    eventBus.on(EVENT_TYPES.SESSION_START, (e) => {
      // Only hooks provide real session IDs; scraping emits sessionId: null
      if (e.source !== 'hooks') return;
      if (!e.data?.sessionId) return;
      if (!e.projectId) return;

      // Find the terminal for this project (latest terminal ID heuristic)
      const terminalId = findClaudeTerminalForProject(e.projectId);
      if (!terminalId) return;

      // Update in-memory termData with the captured session ID
      const { updateTerminal } = require('../state/terminals.state');
      updateTerminal(terminalId, { claudeSessionId: e.data.sessionId });

      // Trigger debounced save to persist the session ID to disk
      const TerminalSessionService = require('../services/TerminalSessionService');
      TerminalSessionService.saveTerminalSessions();

      console.debug(`[Events] Captured session ID ${e.data.sessionId} for terminal ${terminalId}`);
    })
  );
}
```

**3. Wire the consumer in `initClaudeEvents()`** — add `wireSessionIdCapture();` after the `wireTerminalStatusConsumer();` call (before `wireDebugListener();`):
```js
  wireTimeTrackingConsumer();
  wireNotificationConsumer();
  wireAttentionConsumer();
  wireDashboardStatsConsumer();
  wireTerminalStatusConsumer();
  wireSessionIdCapture();        // ADD THIS LINE
  wireDebugListener();
```
  </action>
  <verify>
    <automated>npm run build:renderer 2>&1 | tail -5</automated>
    <manual>Check that wireSessionIdCapture and findClaudeTerminalForProject are defined, and wireSessionIdCapture is called in initClaudeEvents</manual>
  </verify>
  <done>events/index.js has wireSessionIdCapture consumer that captures session IDs from hooks SESSION_START events, correlates to the correct terminal via findClaudeTerminalForProject, updates termData, and triggers a save</done>
</task>

<task type="auto">
  <name>Task 2: Extend TerminalSessionService to serialize claudeSessionId per tab</name>
  <files>src/renderer/services/TerminalSessionService.js</files>
  <action>
Modify the `saveTerminalSessionsImmediate()` function to include `claudeSessionId` in the serialized tab data.

**In the `terminals.forEach()` loop** (around line 87-100), after `const isBasic = termData.isBasic === true;`, add:
```js
const claudeSessionId = termData.claudeSessionId || null;
```

**Then modify the `tabs.push()` call** from:
```js
projectsMap[projectId].tabs.push({ cwd, isBasic });
```
to:
```js
projectsMap[projectId].tabs.push({ cwd, isBasic, claudeSessionId });
```

This is a minimal change. The `claudeSessionId` field will be:
- A valid UUID string when SESSION_START was captured via hooks
- `null` when no session ID was ever captured (basic terminals, or hooks disabled)
- On restore (Plan 06-02), `null` values are ignored (no `--resume` passed)
  </action>
  <verify>
    <automated>npm run build:renderer 2>&1 | tail -5</automated>
    <manual>Verify that saveTerminalSessionsImmediate includes claudeSessionId in the tab push</manual>
  </verify>
  <done>TerminalSessionService serializes claudeSessionId alongside cwd and isBasic for each terminal tab in terminal-sessions.json</done>
</task>

<task type="auto">
  <name>Task 3: Fix resumeSession() termData to include mode and cwd for session persistence</name>
  <files>src/renderer/ui/components/TerminalManager.js</files>
  <action>
In the `resumeSession()` function (around line 2683), the `termData` object is missing `mode` and `cwd` fields. Without these, the `saveTerminalSessionsImmediate` filter (`if (termData.mode !== 'terminal') return;`) excludes these terminals from persistence.

**Modify the termData object** from:
```js
const termData = {
  terminal,
  fitAddon,
  project,
  projectIndex,
  name: t('terminals.resuming'),
  status: 'working',
  inputBuffer: '',
  isBasic: false
};
```

to:
```js
const termData = {
  terminal,
  fitAddon,
  project,
  projectIndex,
  name: t('terminals.resuming'),
  status: 'working',
  inputBuffer: '',
  isBasic: false,
  mode: 'terminal',
  cwd: project.path
};
```

This ensures that terminals opened via the sessions panel "Resume" button are also persisted to `terminal-sessions.json` and can be restored after a future app restart.
  </action>
  <verify>
    <automated>npm run build:renderer 2>&1 | tail -5</automated>
    <manual>Verify that termData in resumeSession includes mode: 'terminal' and cwd: project.path</manual>
  </verify>
  <done>resumeSession() termData includes mode: 'terminal' and cwd: project.path, ensuring resumed sessions are tracked by TerminalSessionService</done>
</task>

</tasks>

<verification>
1. `npm run build:renderer` completes without errors
2. `npm test` passes all existing tests (no regressions)
3. `grep -n "wireSessionIdCapture\|findClaudeTerminalForProject" src/renderer/events/index.js` shows both functions defined and wireSessionIdCapture called
4. `grep -n "claudeSessionId" src/renderer/services/TerminalSessionService.js` shows the field in the tab push
5. `grep -n "mode: 'terminal'" src/renderer/ui/components/TerminalManager.js` shows the field in resumeSession's termData
6. `grep -n "cwd: project.path" src/renderer/ui/components/TerminalManager.js` shows cwd added to resumeSession's termData
</verification>

<success_criteria>
- SESSION_START events from hooks capture session IDs and update the correct terminal's termData
- TerminalSessionService serializes claudeSessionId per tab in terminal-sessions.json
- Only hooks-sourced events with truthy sessionId are captured (scraping ignored)
- resumeSession() termData includes mode and cwd for persistence
- Build and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-resume-claude-sessions/06-01-SUMMARY.md`
</output>
