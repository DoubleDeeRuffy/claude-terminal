---
phase: 06-resume-claude-sessions
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - src/renderer/ui/components/TerminalManager.js
  - renderer.js
autonomous: true
requirements:
  - SESS-01
  - SESS-02
  - SESS-03
  - SESS-04

must_haves:
  truths:
    - "createTerminal() accepts and threads resumeSessionId through to api.terminal.create()"
    - "The startup restore loop passes tab.claudeSessionId as resumeSessionId for non-basic tabs"
    - "A 5-second watchdog timer detects failed resume attempts (PTY exits quickly with no data received)"
    - "On resume failure, a fresh Claude session starts automatically in a new terminal for the same project"
    - "The watchdog does not fire for user-initiated terminal closes (checks terminalsState)"
  artifacts:
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "resumeSessionId threading in createTerminal and resume failure watchdog"
      contains: "resumeSessionId"
    - path: "renderer.js"
      provides: "resumeSessionId passed in restore loop from saved tab data"
      contains: "resumeSessionId"
  key_links:
    - from: "renderer.js"
      to: "src/renderer/ui/components/TerminalManager.js"
      via: "createTerminal({ resumeSessionId: tab.claudeSessionId })"
      pattern: "resumeSessionId.*claudeSessionId"
    - from: "src/renderer/ui/components/TerminalManager.js"
      to: "src/main/ipc/terminal.ipc.js"
      via: "api.terminal.create({ resumeSessionId }) IPC call"
      pattern: "resumeSessionId"
---

<objective>
Thread resumeSessionId through createTerminal() to enable Claude session resume on startup, and add a watchdog timer to detect and recover from stale session resume failures.

Purpose: This plan completes the resume flow by connecting the persisted session IDs (from Plan 06-01) to the PTY spawn path and adding failure resilience.
Output: Terminals with saved Claude session IDs resume automatically on app restart; failed resumes fall back to fresh Claude sessions within 5 seconds.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-resume-claude-sessions/06-RESEARCH.md
@.planning/phases/06-resume-claude-sessions/06-01-PLAN.md
@src/renderer/ui/components/TerminalManager.js
@renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread resumeSessionId through createTerminal() and add resume failure watchdog</name>
  <files>src/renderer/ui/components/TerminalManager.js</files>
  <action>
Two changes to createTerminal() in TerminalManager.js:

**Change A — Add resumeSessionId to destructured options (line ~1184):**

Change the destructuring line from:
```js
const { skipPermissions = false, runClaude = true, name: customName = null, mode: explicitMode = null, cwd: overrideCwd = null, initialPrompt = null, initialImages = null, initialModel = null, initialEffort = null, onSessionStart = null } = options;
```
to:
```js
const { skipPermissions = false, runClaude = true, name: customName = null, mode: explicitMode = null, cwd: overrideCwd = null, initialPrompt = null, initialImages = null, initialModel = null, initialEffort = null, onSessionStart = null, resumeSessionId = null } = options;
```

**Change B — Pass resumeSessionId to api.terminal.create() (line ~1195-1199):**

Change from:
```js
const result = await api.terminal.create({
  cwd: overrideCwd || project.path,
  runClaude,
  skipPermissions
});
```
to:
```js
const result = await api.terminal.create({
  cwd: overrideCwd || project.path,
  runClaude,
  skipPermissions,
  ...(resumeSessionId ? { resumeSessionId } : {})
});
```

Using spread with conditional avoids sending `resumeSessionId: null` which would cause the main process to attempt `--resume null`.

**Change C — Add resume failure watchdog after PTY data handler setup:**

After the `registerTerminalHandler(id, ...)` call (around line 1341-1349) and before the input handling section, add the watchdog logic. The watchdog only activates when `resumeSessionId` is provided:

```js
// Resume failure watchdog — detects stale session IDs
if (resumeSessionId) {
  const RESUME_WATCHDOG_MS = 5000;
  let resumeDataReceived = false;

  // Track whether any PTY data arrives (cancels watchdog)
  const origDataHandler = getTerminal(id)?.handlers?.unregister;
  const checkDataInterval = setInterval(() => {
    const td = getTerminal(id);
    if (!td) { clearInterval(checkDataInterval); return; }
    // terminal.buffer.active.cursorY > 0 means data was written
    if (td.terminal.buffer.active.length > 1) {
      resumeDataReceived = true;
      clearInterval(checkDataInterval);
    }
  }, 500);

  setTimeout(() => {
    clearInterval(checkDataInterval);
    const td = getTerminal(id);
    // Terminal was already removed (user closed it, or PTY exited and closeTerminal ran) — ignore
    if (!td) return;
    // Data arrived before timeout — resume succeeded
    if (resumeDataReceived) return;
    // Resume likely failed — close this terminal and start a fresh Claude session
    console.warn(`[TerminalManager] Resume watchdog fired for terminal ${id} (session ${resumeSessionId}) — starting fresh`);
    closeTerminal(id);
    createTerminal(project, {
      runClaude: true,
      cwd: overrideCwd || project.path,
      skipPermissions
    });
  }, RESUME_WATCHDOG_MS);
}
```

**Important implementation notes:**
- The watchdog checks `getTerminal(id)` before acting. If the terminal was already cleaned up by `closeTerminal()` (because the PTY exited), the watchdog does nothing (avoids Pitfall 5).
- The buffer length check (`terminal.buffer.active.length > 1`) detects whether xterm received any output lines. A valid resume shows output almost immediately; a failed resume exits with a short error then the PTY closes.
- The fallback `createTerminal` call does NOT pass `resumeSessionId` — it starts a fresh Claude session. The new session will get a new session ID captured by the Phase 6 consumer (from Plan 06-01).
  </action>
  <verify>
    <automated>npm run build:renderer 2>&1 | tail -5</automated>
    <manual>Verify resumeSessionId is destructured from options and passed to api.terminal.create, and watchdog logic exists</manual>
  </verify>
  <done>createTerminal() threads resumeSessionId to api.terminal.create() and includes a 5-second watchdog that detects stale resume failures and falls back to a fresh Claude session</done>
</task>

<task type="auto">
  <name>Task 2: Pass resumeSessionId from saved tab data in the startup restore loop</name>
  <files>renderer.js</files>
  <action>
In the startup restore loop (around line 174-181), modify the `createTerminal` call to include `resumeSessionId` from the saved tab data.

**Change the createTerminal call** from:
```js
await TerminalManager.createTerminal(project, {
  runClaude: !tab.isBasic,
  cwd,
  skipPermissions: settingsState.get().skipPermissions,
});
```
to:
```js
await TerminalManager.createTerminal(project, {
  runClaude: !tab.isBasic,
  cwd,
  skipPermissions: settingsState.get().skipPermissions,
  resumeSessionId: (!tab.isBasic && tab.claudeSessionId) ? tab.claudeSessionId : null,
});
```

**Logic:**
- `tab.isBasic === true` → plain shell terminal → no resume (null)
- `tab.claudeSessionId` is falsy (null/undefined) → no session was captured → no resume (null)
- `tab.isBasic === false` AND `tab.claudeSessionId` is truthy → pass the session ID for resume

The `createTerminal` function (modified in Task 1) will then pass this to `api.terminal.create()`, which triggers `claude --resume <id>` in the PTY. If the session is stale, the watchdog (also from Task 1) detects the failure and starts a fresh session.
  </action>
  <verify>
    <automated>npm run build:renderer 2>&1 | tail -5</automated>
    <manual>Verify the restore loop passes resumeSessionId from tab.claudeSessionId</manual>
  </verify>
  <done>The startup restore loop passes tab.claudeSessionId as resumeSessionId to createTerminal, enabling automatic Claude session resume after app restart</done>
</task>

</tasks>

<verification>
1. `npm run build:renderer` completes without errors
2. `npm test` passes all existing tests (no regressions)
3. `grep -n "resumeSessionId" src/renderer/ui/components/TerminalManager.js` shows: destructuring in options, passing to api.terminal.create, and watchdog logic
4. `grep -n "resumeSessionId\|claudeSessionId" renderer.js` shows the session ID being passed in the restore loop
5. `grep -n "RESUME_WATCHDOG_MS" src/renderer/ui/components/TerminalManager.js` shows the watchdog constant
6. `grep -c "resumeSessionId" src/renderer/ui/components/TerminalManager.js` shows at least 4 occurrences (destructuring, api call, watchdog log, condition check)
</verification>

<success_criteria>
- createTerminal() destructures resumeSessionId from options and passes it to api.terminal.create()
- The startup restore loop reads tab.claudeSessionId and passes it as resumeSessionId
- A 5-second watchdog detects resume failures (no data received + terminal still alive)
- On resume failure, a fresh Claude session starts automatically
- The watchdog ignores user-initiated terminal closes
- Build and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-resume-claude-sessions/06-02-SUMMARY.md`
</output>
