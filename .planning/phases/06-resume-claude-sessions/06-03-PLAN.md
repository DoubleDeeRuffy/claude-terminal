---
phase: 06-resume-claude-sessions
plan: 03
type: execute
wave: 1
depends_on: ["06-01", "06-02"]
files_modified:
  - src/renderer/ui/components/TerminalManager.js
  - src/renderer/services/TerminalSessionService.js
  - renderer.js
autonomous: true
requirements: [SESS-01, SESS-02, SESS-03, SESS-04]
gap_closure: true

must_haves:
  truths:
    - "Terminal reconnects to previous Claude session with prior conversation context loaded after app restart"
    - "Chat-mode terminals resume via resumeSessionId just like terminal-mode terminals"
    - "Saved tab mode is restored on restart, not derived from current defaultTerminalMode setting"
    - "initClaudeEvents runs before terminal restore so new session IDs are captured on resumed sessions"
  artifacts:
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "resumeSessionId forwarded to createChatTerminal in chat mode branch"
      contains: "resumeSessionId"
    - path: "src/renderer/services/TerminalSessionService.js"
      provides: "Tab mode persisted in serialized tab data"
      contains: "mode:"
    - path: "renderer.js"
      provides: "Tab mode passed on restore, initClaudeEvents before restore block"
  key_links:
    - from: "renderer.js"
      to: "TerminalManager.createTerminal"
      via: "mode: tab.mode passed in restore options"
      pattern: "mode:\\s*tab\\.mode"
    - from: "TerminalManager.createTerminal"
      to: "createChatTerminal"
      via: "resumeSessionId forwarded in chat branch"
      pattern: "resumeSessionId"
---

<objective>
Fix three interconnected bugs preventing Claude session resume from working end-to-end.

Purpose: UAT test 3 failed — "it doesnt., there are no errors either". Debug session identified three root causes: (1) chat mode branch drops resumeSessionId, (2) tab mode not saved/restored, (3) initClaudeEvents runs after terminal restore. All three must be fixed together for session resume to work reliably.

Output: Three targeted code fixes across three files, closing the UAT gap.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-resume-claude-sessions/06-01-SUMMARY.md
@.planning/phases/06-resume-claude-sessions/06-02-SUMMARY.md
@.planning/debug/session-resume-not-working.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Forward resumeSessionId in chat mode branch and save/restore tab mode</name>
  <files>
    src/renderer/ui/components/TerminalManager.js
    src/renderer/services/TerminalSessionService.js
  </files>
  <action>
**Fix 1 — TerminalManager.js line ~1305 (chat mode branch in createTerminal):**

Add `resumeSessionId` to the options object passed to `createChatTerminal`. The current line is:

```javascript
return createChatTerminal(chatProject, { skipPermissions, name: customName, parentProjectId: overrideCwd ? project.id : null, initialPrompt, initialImages, initialModel, initialEffort, onSessionStart });
```

Change to include `resumeSessionId`:

```javascript
return createChatTerminal(chatProject, { skipPermissions, name: customName, parentProjectId: overrideCwd ? project.id : null, resumeSessionId, initialPrompt, initialImages, initialModel, initialEffort, onSessionStart });
```

`createChatTerminal` already destructures `resumeSessionId` at line ~3361 and passes it to the chat service at line ~3414, so no other changes needed in that function.

**Fix 2 — TerminalSessionService.js `saveTerminalSessionsImmediate` function:**

At line ~100, the `tabs.push` call currently saves `{ cwd, isBasic, claudeSessionId }`. Add `mode` to the saved object:

```javascript
projectsMap[projectId].tabs.push({ cwd, isBasic, claudeSessionId, mode: termData.mode || 'terminal' });
```

Also, at line ~88, the early return `if (termData.mode !== 'terminal') return;` MUST be removed or changed to also save chat-mode tabs. Change it to skip only non-claude modes (basic shell tabs without mode are fine). The condition should become:

```javascript
if (termData.mode !== 'terminal' && termData.mode !== 'chat') return;
```

This ensures chat-mode tabs with session IDs are also persisted.
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && node -e "const src=require('fs').readFileSync('src/renderer/ui/components/TerminalManager.js','utf8'); const chatBranch=src.match(/createChatTerminal\(chatProject,\s*\{[^}]+\}/); if(!chatBranch||!chatBranch[0].includes('resumeSessionId')){process.exit(1);} console.log('PASS: resumeSessionId in chat branch');" && node -e "const src=require('fs').readFileSync('src/renderer/services/TerminalSessionService.js','utf8'); if(!src.includes('mode: termData.mode')){process.exit(1);} console.log('PASS: mode saved in TerminalSessionService');"</automated>
  </verify>
  <done>
    - createTerminal chat-mode branch passes resumeSessionId to createChatTerminal
    - TerminalSessionService saves tab mode in serialized data
    - Both terminal and chat mode tabs are persisted (not just terminal mode)
  </done>
</task>

<task type="auto">
  <name>Task 2: Pass saved tab mode on restore and move initClaudeEvents before restore block</name>
  <files>renderer.js</files>
  <action>
**Fix 3 — renderer.js restore loop (line ~190-195):**

Add `mode: tab.mode || 'terminal'` to the createTerminal options so the saved mode is restored instead of defaulting to the current `defaultTerminalMode` setting:

```javascript
await TerminalManager.createTerminal(project, {
  runClaude: !tab.isBasic,
  cwd,
  skipPermissions: settingsState.get().skipPermissions,
  resumeSessionId: (!tab.isBasic && tab.claudeSessionId) ? tab.claudeSessionId : null,
  mode: tab.mode || 'terminal',
});
```

**Fix 4 — renderer.js initialization order (line ~229):**

Move the `initClaudeEvents();` call from its current position (line ~229, after terminal restore) to BEFORE the terminal restore block (before line ~175 `// Restore terminal sessions from previous run`). This ensures the HooksProvider is already listening when resumed sessions emit SESSION_START events, so new session IDs are captured.

The moved line should go right before the `// Restore terminal sessions from previous run` comment, after the Ctrl+Tab settings subscriber block (after line ~173).

Before:
```javascript
  // (Ctrl+Tab subscriber block ends ~line 173)

  // Restore terminal sessions from previous run
  try { ...
  } catch (err) { ... }

  initI18n(settingsState.get().language);

  // Initialize Claude event bus and provider (hooks or scraping)
  initClaudeEvents();
```

After:
```javascript
  // (Ctrl+Tab subscriber block ends ~line 173)

  // Initialize Claude event bus and provider (hooks or scraping)
  // Must run BEFORE terminal restore so resumed sessions capture new session IDs
  initClaudeEvents();

  // Restore terminal sessions from previous run
  try { ...
  } catch (err) { ... }

  initI18n(settingsState.get().language);
```
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && node -e "const src=require('fs').readFileSync('renderer.js','utf8'); const lines=src.split('\n'); const initIdx=lines.findIndex(l=>l.includes('initClaudeEvents()')); const restoreIdx=lines.findIndex(l=>l.includes('Restore terminal sessions')); if(initIdx===-1||restoreIdx===-1||initIdx>=restoreIdx){console.error('FAIL: initClaudeEvents must come before restore block. initIdx='+initIdx+' restoreIdx='+restoreIdx); process.exit(1);} console.log('PASS: initClaudeEvents before restore (line '+initIdx+' < '+restoreIdx+')'); if(!src.includes('mode: tab.mode')){console.error('FAIL: mode not passed in restore'); process.exit(1);} console.log('PASS: tab mode passed on restore');"</automated>
  </verify>
  <done>
    - Restore loop passes saved tab mode to createTerminal
    - initClaudeEvents() runs before terminal restore block
    - Resumed sessions will have their new session IDs captured by HooksProvider
  </done>
</task>

</tasks>

<verification>
All three root causes from the debug report are addressed:
1. Chat mode branch forwards resumeSessionId (Fix 1)
2. Tab mode is saved and restored (Fix 2 + Fix 3)
3. initClaudeEvents runs before restore (Fix 4)

Run full test suite to confirm no regressions:
```bash
cd C:/Users/uhgde/source/repos/claude-terminal && npm test
```

Then rebuild renderer:
```bash
npm run build:renderer
```
</verification>

<success_criteria>
- resumeSessionId appears in the createChatTerminal call within createTerminal's chat branch
- TerminalSessionService saves mode field per tab
- Chat-mode tabs are persisted (mode filter relaxed)
- renderer.js restore loop passes mode: tab.mode
- initClaudeEvents() line appears before the restore terminal sessions block
- npm test passes
- npm run build:renderer succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-resume-claude-sessions/06-03-SUMMARY.md`
</output>
