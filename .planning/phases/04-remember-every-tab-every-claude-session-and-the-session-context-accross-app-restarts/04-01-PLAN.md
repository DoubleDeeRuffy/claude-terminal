---
phase: 04-remember-every-tab-every-claude-session-and-the-session-context-accross-app-restarts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/services/TerminalSessionService.js
  - src/renderer/ui/components/TerminalManager.js
autonomous: true
requirements:
  - SESS-01
  - SESS-03

must_haves:
  truths:
    - "Terminal session data is saved to disk after every tab open or close"
    - "Only regular terminal tabs (mode=terminal) are serialized — chat, file, and type console tabs are excluded"
    - "Each saved tab records its effective CWD (project root or overrideCwd for worktrees)"
    - "Save uses atomic write with debounce (crash-resilient)"
  artifacts:
    - path: "src/renderer/services/TerminalSessionService.js"
      provides: "Load, save, clear session data for terminal tabs"
      contains: "saveTerminalSessions"
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "CWD stored in termData, save hooks after create/close"
      contains: "overrideCwd"
  key_links:
    - from: "src/renderer/ui/components/TerminalManager.js"
      to: "src/renderer/services/TerminalSessionService.js"
      via: "calls saveTerminalSessions() after createTerminal and closeTerminal"
      pattern: "saveTerminalSessions"
    - from: "src/renderer/services/TerminalSessionService.js"
      to: "~/.claude-terminal/terminal-sessions.json"
      via: "atomic write (writeFileSync + renameSync)"
      pattern: "terminal-sessions\\.json"
---

<objective>
Create the TerminalSessionService and wire save hooks into TerminalManager so that terminal tab state is persisted to disk on every tab open/close.

Purpose: Provides the persistence layer for terminal session restore. Without continuous saving, crash recovery would lose all tab state.
Output: New `TerminalSessionService.js` module and modified `TerminalManager.js` with CWD tracking and save triggers.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-remember-every-tab-every-claude-session-and-the-session-context-accross-app-restarts/04-CONTEXT.md
@.planning/phases/04-remember-every-tab-every-claude-session-and-the-session-context-accross-app-restarts/04-RESEARCH.md
@src/renderer/services/TerminalSessionService.js
@src/renderer/ui/components/TerminalManager.js
@src/renderer/state/terminals.state.js
@src/renderer/state/projects.state.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TerminalSessionService with save/load/clear functions</name>
  <files>src/renderer/services/TerminalSessionService.js</files>
  <action>
Create `src/renderer/services/TerminalSessionService.js` with the following exports:

1. **`loadSessionData()`** — Reads `~/.claude-terminal/terminal-sessions.json` via `window.electron_nodeModules.fs.readFileSync`. Returns parsed JSON or `{ lastOpenedProjectId: null, projects: {} }` if file missing or corrupt. Wrap in try/catch, return default on error.

2. **`saveTerminalSessions()`** — Debounced (300ms) save function. When triggered:
   - Import `terminalsState` from `../../state/terminals.state` and `projectsState` from `../../state/projects.state`
   - Iterate `terminalsState.get().terminals` (Map)
   - Filter to only entries where `termData.mode === 'terminal'` AND `termData.project?.id` exists (excludes chat, file, type consoles)
   - Build a `projects` object keyed by `projectId`, each with `{ tabs: [{ cwd, isBasic }], activeCwd }`:
     - `cwd` = `termData.cwd || termData.project.path` (the stored effective CWD — see Task 2)
     - `isBasic` = `termData.isBasic === true`
     - `activeCwd` = the CWD of the active terminal (where `id === terminalsState.get().activeTerminal`)
   - Also read `lastOpenedProjectId` from current state: look at `projectsState.get().selectedProjectFilter` index, resolve to project ID
   - Atomic write: `writeFileSync(tmpPath, JSON.stringify(data, null, 2))` then `renameSync(tmpPath, sessionsFile)`. Use `window.electron_nodeModules.fs` for all file ops.
   - Use `window.electron_nodeModules.path.join(dataDir, 'terminal-sessions.json')` where `dataDir` comes from `../../utils/paths` (the `getDataDir()` or equivalent — check `paths.js` for the pattern, likely `path.join(os.homedir(), '.claude-terminal')`).

3. **`clearProjectSessions(projectId)`** — Loads session data, deletes `data.projects[projectId]`, writes back immediately (no debounce — deletion is infrequent).

4. **`updateLastOpenedProject(projectId)`** — Triggers the debounced save (which already captures lastOpenedProjectId from current state). If a lighter approach is preferred: load, update `lastOpenedProjectId`, save with debounce.

Follow the debounce pattern from `projects.state.js`: module-scope `saveDebounceTimer`, `clearTimeout`/`setTimeout` with 300ms delay. The actual write function (`saveTerminalSessionsImmediate`) does the atomic write.

File structure follows existing service conventions: JSDoc header, `const fs = window.electron_nodeModules.fs;`, `const path = window.electron_nodeModules.path;`, export functions via `module.exports = { ... }`.
  </action>
  <verify>
    <automated>node -e "const src = require('fs').readFileSync('src/renderer/services/TerminalSessionService.js','utf8'); const has = (s) => src.includes(s); console.log('saveTerminalSessions:', has('saveTerminalSessions')); console.log('loadSessionData:', has('loadSessionData')); console.log('clearProjectSessions:', has('clearProjectSessions')); console.log('atomic write:', has('renameSync')); console.log('debounce:', has('setTimeout')); console.log('module.exports:', has('module.exports')); if (!has('saveTerminalSessions') || !has('loadSessionData') || !has('clearProjectSessions') || !has('renameSync')) process.exit(1);"</automated>
  </verify>
  <done>TerminalSessionService.js exists with loadSessionData, saveTerminalSessions (debounced), clearProjectSessions, and atomic write pattern. Exports all functions via module.exports.</done>
</task>

<task type="auto">
  <name>Task 2: Add CWD tracking to termData and save hooks in TerminalManager</name>
  <files>src/renderer/ui/components/TerminalManager.js</files>
  <action>
Two changes to TerminalManager.js:

**Change A — Store effective CWD in termData (line ~1220-1232):**

In `createTerminal()`, the `termData` object (line 1220) does NOT store the effective CWD (`overrideCwd || project.path`). Add a `cwd` property:

```js
const termData = {
  terminal,
  fitAddon,
  project,
  projectIndex,
  name: tabName,
  status: initialStatus,
  inputBuffer: '',
  isBasic: isBasicTerminal,
  mode: 'terminal',
  cwd: overrideCwd || project.path,   // <-- ADD THIS LINE
  ...(initialPrompt ? { pendingPrompt: initialPrompt } : {}),
  ...(overrideCwd ? { parentProjectId: project.id } : {}),
};
```

This makes the effective CWD available for serialization by TerminalSessionService.

**Change B — Add save hooks after createTerminal and closeTerminal:**

At the top of TerminalManager.js, add the import:
```js
const { saveTerminalSessions } = require('../../services/TerminalSessionService');
```

In `createTerminal()`, after `addTerminal(id, termData)` (line 1234), add:
```js
saveTerminalSessions();
```

In `closeTerminal()`, after the terminal is fully cleaned up and removed (after `removeTerminal(id)` — there are 3 call sites for removeTerminal in closeTerminal: line ~1122, ~1125, ~1129), add the save call at the END of the closeTerminal function, after all the cleanup and tab switching logic. Find the end of closeTerminal (after the same-project terminal switching logic finishes, before the next function), and add:
```js
saveTerminalSessions();
```

Place the single `saveTerminalSessions()` call once at the very end of `closeTerminal()`, after all the if/else branches for switching to another terminal. This way it fires regardless of which cleanup path was taken.

Do NOT add save hooks to `createChatTerminal`, `createTypeConsole`, or any type-specific console functions — those are out of scope per user decision.
  </action>
  <verify>
    <automated>node -e "const src = require('fs').readFileSync('src/renderer/ui/components/TerminalManager.js','utf8'); const has = (s) => src.includes(s); console.log('import:', has('TerminalSessionService')); console.log('cwd in termData:', has('cwd: overrideCwd || project.path')); console.log('save calls:', (src.match(/saveTerminalSessions\(\)/g) || []).length); if (!has('TerminalSessionService') || !has('cwd: overrideCwd || project.path') || (src.match(/saveTerminalSessions\(\)/g) || []).length < 2) process.exit(1);"</automated>
  </verify>
  <done>TerminalManager.js stores effective CWD in termData.cwd and calls saveTerminalSessions() after both createTerminal and closeTerminal. Import of TerminalSessionService is present at the top of the file.</done>
</task>

</tasks>

<verification>
1. `src/renderer/services/TerminalSessionService.js` exists and exports `loadSessionData`, `saveTerminalSessions`, `clearProjectSessions`
2. `src/renderer/ui/components/TerminalManager.js` imports from `TerminalSessionService`
3. `termData` object in `createTerminal` includes `cwd: overrideCwd || project.path`
4. `saveTerminalSessions()` is called after `addTerminal(id, termData)` in `createTerminal`
5. `saveTerminalSessions()` is called at the end of `closeTerminal`
6. `npm run build:renderer` succeeds without errors
</verification>

<success_criteria>
- TerminalSessionService.js created with all persistence functions
- TerminalManager.js modified to track CWD and trigger saves
- Opening and closing terminal tabs causes `terminal-sessions.json` to be written to `~/.claude-terminal/`
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-remember-every-tab-every-claude-session-and-the-session-context-accross-app-restarts/04-01-SUMMARY.md`
</output>
