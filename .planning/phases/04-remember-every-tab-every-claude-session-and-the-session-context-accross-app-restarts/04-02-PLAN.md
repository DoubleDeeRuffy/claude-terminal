---
phase: 04-remember-every-tab-every-claude-session-and-the-session-context-accross-app-restarts
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - renderer.js
autonomous: true
requirements:
  - SESS-01
  - SESS-02
  - SESS-04

must_haves:
  truths:
    - "When the app restarts, each project's terminal tabs are re-created in the same working directories"
    - "The last opened project is selected and visible after restart"
    - "Projects whose directories no longer exist are silently skipped during restore"
    - "When a project is deleted, its saved terminal session data is removed"
    - "Zero-terminal state is respected: projects with no saved tabs get no auto-created terminals"
  artifacts:
    - path: "renderer.js"
      provides: "Restore pass at startup, last-opened-project subscription, deletion cleanup"
      contains: "restoreAllSessions"
  key_links:
    - from: "renderer.js"
      to: "src/renderer/services/TerminalSessionService.js"
      via: "calls loadSessionData at startup, clearProjectSessions on delete, subscribes for lastOpenedProject"
      pattern: "loadSessionData|clearProjectSessions"
    - from: "renderer.js restore loop"
      to: "src/renderer/ui/components/TerminalManager.js"
      via: "calls TerminalManager.createTerminal for each saved tab"
      pattern: "TerminalManager\\.createTerminal"
---

<objective>
Wire terminal session restore at app startup, last-opened-project persistence, and cleanup on project deletion into renderer.js.

Purpose: Completes the persistence loop — Plan 01 saves, this plan restores and cleans up. Users see their tabs back after restart.
Output: Modified `renderer.js` with restore logic, project subscription, and delete hook.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-remember-every-tab-every-claude-session-and-the-session-context-accross-app-restarts/04-CONTEXT.md
@.planning/phases/04-remember-every-tab-every-claude-session-and-the-session-context-accross-app-restarts/04-RESEARCH.md
@.planning/phases/04-remember-every-tab-every-claude-session-and-the-session-context-accross-app-restarts/04-01-SUMMARY.md
@renderer.js
@src/renderer/services/TerminalSessionService.js
@src/renderer/ui/components/TerminalManager.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add terminal session restore at startup and project deletion cleanup</name>
  <files>renderer.js</files>
  <action>
Three changes to renderer.js:

**Change A — Import TerminalSessionService (near top with other imports, around line 154):**

```js
const { loadSessionData, clearProjectSessions, saveTerminalSessions } = require('./src/renderer/services/TerminalSessionService');
```

**Change B — Add restore pass after initializeState() (inside the async IIFE, after line 158 `await initializeState()`):**

Insert a terminal session restore block immediately after `await initializeState()` and before `initI18n(...)`. The logic:

```js
// Restore terminal sessions from previous run
try {
  const sessionData = loadSessionData();
  if (sessionData && sessionData.projects) {
    const fs = window.electron_nodeModules.fs;
    const projects = projectsState.get().projects;

    for (const projectId of Object.keys(sessionData.projects)) {
      const saved = sessionData.projects[projectId];
      const project = projects.find(p => p.id === projectId);
      if (!project) continue;                         // project deleted — skip
      if (!fs.existsSync(project.path)) continue;    // project root gone — skip
      if (!saved.tabs || saved.tabs.length === 0) continue; // zero-terminal state — respect

      for (const tab of saved.tabs) {
        const cwd = fs.existsSync(tab.cwd) ? tab.cwd : project.path;
        await TerminalManager.createTerminal(project, {
          runClaude: !tab.isBasic,
          cwd,
          skipPermissions: settingsState.get().skipPermissions,
        });
      }

      // Set active terminal to the one matching saved activeCwd
      if (saved.activeCwd) {
        const terminals = terminalsState.get().terminals;
        let activeId = null;
        terminals.forEach((td, id) => {
          if (td.project?.id === projectId && td.cwd === saved.activeCwd) {
            activeId = id;
          }
        });
        if (activeId !== null) {
          TerminalManager.setActiveTerminal(activeId);
        }
      }
    }

    // Restore last opened project
    if (sessionData.lastOpenedProjectId) {
      const idx = projects.findIndex(p => p.id === sessionData.lastOpenedProjectId);
      if (idx !== -1) {
        setSelectedProjectFilter(idx);
        TerminalManager.filterByProject(idx);
      }
    }
  }
} catch (err) {
  console.error('[SessionRestore] Error restoring terminal sessions:', err);
}
```

Important ordering: This MUST run after `await initializeState()` (projects loaded) but before `initI18n` is fine — i18n doesn't affect terminal creation. The restore is sequential within each project (preserves tab order) and sequential across projects (avoids PTY spawn flooding).

**Change C — Add deletion cleanup in deleteProjectUI (line ~862-870):**

In `deleteProjectUI`, after `saveProjects()` (line 863) and before the selectedProjectFilter check (line 865), add:

```js
  // Clean up saved terminal session data for deleted project
  clearProjectSessions(projectId);
```

**Change D — Subscribe to selectedProjectFilter changes for last-opened-project persistence:**

At the end of the async IIFE (after all init is complete, before the closing `})();`), add a subscription:

```js
// Track last opened project for session restore
projectsState.subscribe((state) => {
  if (state.selectedProjectFilter !== null && state.selectedProjectFilter !== undefined) {
    const project = state.projects[state.selectedProjectFilter];
    if (project) {
      saveTerminalSessions(); // debounced — captures lastOpenedProjectId from current state
    }
  }
});
```

This piggybacks on the existing `saveTerminalSessions` debounce which already reads `selectedProjectFilter` to derive `lastOpenedProjectId`.
  </action>
  <verify>
    <automated>node -e "const src = require('fs').readFileSync('renderer.js','utf8'); const has = (s) => src.includes(s); console.log('import:', has('loadSessionData')); console.log('restore:', has('restoreTerminalSessions') || has('loadSessionData()')); console.log('delete cleanup:', has('clearProjectSessions')); console.log('subscribe:', has('saveTerminalSessions')); if (!has('loadSessionData') || !has('clearProjectSessions')) process.exit(1);"</automated>
    <manual>Start the app, open a project, create 2 terminals, close the app, reopen — both terminals should reappear. Delete a project and verify no orphaned session data.</manual>
  </verify>
  <done>renderer.js restores terminal sessions at startup (sequential, with CWD validation), restores last opened project, cleans up session data on project deletion, and tracks project selection changes for lastOpenedProjectId persistence.</done>
</task>

<task type="auto">
  <name>Task 2: Build renderer bundle and verify no errors</name>
  <files>dist/renderer.bundle.js</files>
  <action>
Run `npm run build:renderer` to rebuild the esbuild bundle. This is required because renderer.js and TerminalManager.js were modified.

Verify:
1. Build completes without errors
2. The bundle includes TerminalSessionService references
3. No syntax errors in any modified file

If build fails, check for:
- Missing imports (TerminalSessionService not found by esbuild)
- Circular dependencies (unlikely — TerminalSessionService imports state, TerminalManager imports service)
- Syntax errors in the new code
  </action>
  <verify>
    <automated>npm run build:renderer 2>&1 | tail -5</automated>
  </verify>
  <done>Renderer bundle builds successfully with all session persistence code included. No errors or warnings from esbuild.</done>
</task>

</tasks>

<verification>
1. App startup restores terminal tabs from `terminal-sessions.json`
2. Last opened project is selected after restart
3. Missing project directories are silently skipped
4. Projects with zero saved tabs get no auto-created terminals
5. Deleting a project removes its entry from `terminal-sessions.json`
6. `npm run build:renderer` succeeds
7. `npm test` passes (no regressions)
</verification>

<success_criteria>
- Terminal tabs survive app restart with correct working directories
- Last opened project is restored
- Crash resilience: kill app mid-session, reopen, tabs are back
- Delete project: no orphaned session data
- Build and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-remember-every-tab-every-claude-session-and-the-session-context-accross-app-restarts/04-02-SUMMARY.md`
</output>
