---
phase: 22-explorer-filewatcher
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/renderer/ui/components/FileExplorer.js
  - renderer.js
  - src/renderer/i18n/locales/en.json
  - src/renderer/i18n/locales/fr.json
autonomous: true
requirements:
  - EXPL-WATCH-01

must_haves:
  truths:
    - "File explorer automatically shows new files/folders created externally without manual refresh"
    - "File explorer automatically removes deleted files/folders without manual refresh"
    - "Expanded folders, scroll position, and selection remain intact during automatic updates"
    - "Watcher starts when a project is opened and stops when project switches or closes"
    - "User sees a toast warning if the project has too many watched paths"
  artifacts:
    - path: "src/renderer/ui/components/FileExplorer.js"
      provides: "applyWatcherChanges function for incremental tree patching"
      exports: ["applyWatcherChanges"]
    - path: "renderer.js"
      provides: "Watcher lifecycle wiring in project-switch subscriber and onChanges listener"
      contains: "explorer.startWatch"
    - path: "src/renderer/i18n/locales/en.json"
      provides: "i18n key for watch limit warning"
      contains: "explorer.watchLimitWarning"
    - path: "src/renderer/i18n/locales/fr.json"
      provides: "French i18n key for watch limit warning"
      contains: "explorer.watchLimitWarning"
  key_links:
    - from: "renderer.js"
      to: "src/renderer/ui/components/FileExplorer.js"
      via: "FileExplorer.applyWatcherChanges called from onChanges listener"
      pattern: "applyWatcherChanges"
    - from: "renderer.js"
      to: "src/main/preload.js"
      via: "api.explorer.startWatch/stopWatch in project-switch subscriber"
      pattern: "api\\.explorer\\.startWatch"
---

<objective>
Wire the file watcher to the renderer: add incremental patch logic to FileExplorer.js, connect watcher lifecycle to project switching, and surface the soft-limit warning toast.

Purpose: Complete the feature so the file explorer tree automatically reflects filesystem changes in real-time — files appear/disappear as they're created/deleted externally.

Output: FileExplorer.js gains `applyWatcherChanges()`, renderer.js wires start/stop/onChange, i18n keys added for warning toast.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-explorer-filewatcher/22-CONTEXT.md
@.planning/phases/22-explorer-filewatcher/22-RESEARCH.md
@.planning/phases/22-explorer-filewatcher/22-01-SUMMARY.md

<interfaces>
<!-- From Plan 01 — preload bridge API -->
explorer: {
  startWatch: (projectPath) => ipcRenderer.send('explorer:startWatch', projectPath),
  stopWatch: () => ipcRenderer.send('explorer:stopWatch'),
  onChanges: createListener('explorer:changes'),
  onWatchLimitWarning: createListener('explorer:watchLimitWarning')
}

<!-- Change event format from explorer.ipc.js -->
// Each change: { type: 'add'|'remove', path: string, isDirectory: boolean }
// Sent as array: mainWindow.webContents.send('explorer:changes', changes[])

<!-- From FileExplorer.js — key data structures -->
let expandedFolders = new Map(); // path -> { children: [...], loaded: bool }
let selectedFiles = new Set();
let lastSelectedFile = null;

async function readDirectoryAsync(dirPath) { /* returns sorted array of { name, path, isDirectory, size, modified } */ }
function render() { /* re-renders the file tree DOM */ }

module.exports = { setCallbacks, setRootPath, show, hide, toggle, init, getState, restoreState };

<!-- From renderer.js — project-switch subscriber (lines ~1568-1583) -->
projectsState.subscribe(() => {
  const state = projectsState.get();
  const selectedFilter = state.selectedProjectFilter;
  const projects = state.projects;
  if (selectedFilter !== null && projects[selectedFilter]) {
    const project = projects[selectedFilter];
    const sessionData = loadSessionData();
    const explorerState = sessionData?.projects?.[project.id]?.explorer || null;
    FileExplorer.setRootPath(project.path, explorerState);
  } else {
    FileExplorer.hide();
  }
});

<!-- From renderer.js — toast usage pattern -->
// showToast is available at module level in renderer.js
// Usage: showToast(message, type) where type is 'info'|'success'|'warning'|'error'
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add applyWatcherChanges to FileExplorer.js</name>
  <files>src/renderer/ui/components/FileExplorer.js</files>
  <action>
Add a new exported async function `applyWatcherChanges(changes)` to FileExplorer.js. Place it in the "FILE SYSTEM" section near `readDirectoryAsync` and `refreshFolder`.

**Implementation:**

```javascript
async function applyWatcherChanges(changes) {
  if (!rootPath || !changes || !changes.length) return;

  const affectedParents = new Set();

  for (const change of changes) {
    const parentDir = path.dirname(change.path);

    if (change.type === 'add') {
      // Only re-read parent if it's a tracked (loaded) folder
      const entry = expandedFolders.get(parentDir);
      if (entry && entry.loaded) {
        affectedParents.add(parentDir);
      }
      // If parent is untracked/collapsed, no action — loads fresh from disk when expanded
    } else if (change.type === 'remove') {
      // Remove the deleted item from parent's children array
      const entry = expandedFolders.get(parentDir);
      if (entry && entry.loaded) {
        entry.children = entry.children.filter(c => c.path !== change.path);
      }
      // For directory deletion: remove the folder AND all descendants from expandedFolders
      if (change.isDirectory) {
        const prefix = change.path + path.sep;
        for (const key of [...expandedFolders.keys()]) {
          if (key === change.path || key.startsWith(prefix)) {
            expandedFolders.delete(key);
          }
        }
      }
      // Clean up selection state for deleted items
      selectedFiles.delete(change.path);
      if (lastSelectedFile === change.path) lastSelectedFile = null;
    }
  }

  // Re-read affected parent directories for additions (to get correctly sorted, stat-complete children)
  for (const parentDir of affectedParents) {
    const entry = expandedFolders.get(parentDir);
    if (entry) {
      entry.children = await readDirectoryAsync(parentDir);
    }
  }

  // Single render call after all patches applied
  render();
}
```

**Key design decisions (from CONTEXT.md):**
- Incremental patches — only touch affected parent folders, not full tree re-read
- Use `path.sep` in startsWith check (not `/`) — prevents false matches like `/project/src` matching `/project/src-old`
- Iterate `[...expandedFolders.keys()]` (copy) since we delete during iteration
- For additions, re-read the parent via `readDirectoryAsync` to get correctly sorted children with stats — avoids manual insertion and sorting logic
- For removals, directly filter children array — cheaper than re-reading from disk
- Selection cleanup prevents stale selections pointing to deleted files

**Add to module.exports:**
Add `applyWatcherChanges` to the existing module.exports object at the bottom of the file.
  </action>
  <verify>
    <automated>node -e "const src = require('fs').readFileSync('src/renderer/ui/components/FileExplorer.js','utf8'); const ok = src.includes('applyWatcherChanges') && src.includes('module.exports') && src.includes('affectedParents'); console.log(ok ? 'OK' : 'FAIL')"</automated>
  </verify>
  <done>FileExplorer.js exports applyWatcherChanges that incrementally patches the tree for add/remove changes</done>
</task>

<task type="auto">
  <name>Task 2: Wire watcher lifecycle in renderer.js and add i18n keys</name>
  <files>renderer.js, src/renderer/i18n/locales/en.json, src/renderer/i18n/locales/fr.json</files>
  <action>
**In `renderer.js`:**

1. **One-time onChanges listener** — Add BEFORE the projectsState.subscribe block (not inside it, to avoid duplicate listeners). Place it right before the `// ========== FILE EXPLORER PROJECT SWITCH ==========` comment (or equivalent location near the project-switch subscriber):

```javascript
// ========== FILE WATCHER ==========
api.explorer.onChanges((changes) => {
  FileExplorer.applyWatcherChanges(changes);
});

api.explorer.onWatchLimitWarning((totalPaths) => {
  showToast(t('explorer.watchLimitWarning', { count: totalPaths }), 'warning');
});
```

2. **Wire startWatch/stopWatch into project-switch subscriber** — Modify the existing `projectsState.subscribe` block that calls `FileExplorer.setRootPath`:

In the `if (selectedFilter !== null && projects[selectedFilter])` branch, ADD after the `FileExplorer.setRootPath(project.path, explorerState)` line:
```javascript
api.explorer.startWatch(project.path);
```

In the `else` branch (after `FileExplorer.hide()`), ADD:
```javascript
api.explorer.stopWatch();
```

This ensures the watcher lifecycle is tied to the active project — starts when a project is selected, stops when deselected or switched (startWatch internally calls stopWatch first).

**In `src/renderer/i18n/locales/en.json`:**

Add under the `explorer` section (find existing `explorer` keys):
```json
"explorer.watchLimitWarning": "Large project: watching {count} paths. Explorer auto-refresh may be slower."
```

**In `src/renderer/i18n/locales/fr.json`:**

Add under the `explorer` section:
```json
"explorer.watchLimitWarning": "Projet volumineux : {count} chemins surveillés. L'actualisation automatique de l'explorateur peut être plus lente."
```

Note: Use proper UTF-8 characters for French text (per CLAUDE.md convention — no ASCII substitutes for accented characters).
  </action>
  <verify>
    <automated>node -e "const r = require('fs').readFileSync('renderer.js','utf8'); const en = require('fs').readFileSync('src/renderer/i18n/locales/en.json','utf8'); const fr = require('fs').readFileSync('src/renderer/i18n/locales/fr.json','utf8'); const ok = r.includes('api.explorer.startWatch') && r.includes('api.explorer.stopWatch') && r.includes('applyWatcherChanges') && en.includes('watchLimitWarning') && fr.includes('watchLimitWarning'); console.log(ok ? 'OK' : 'FAIL')"</automated>
  </verify>
  <done>Watcher starts/stops on project switch, changes flow to FileExplorer.applyWatcherChanges, soft-limit warning shows as toast in both EN and FR</done>
</task>

</tasks>

<verification>
1. `npm run build:renderer` succeeds
2. `npm test` passes (no regressions)
3. Manual flow: open a project, create a file externally → file appears in explorer without refresh
4. Manual flow: delete a file externally → file disappears from explorer without refresh
5. Manual flow: switch projects → old watcher stops, new watcher starts for new project
6. Manual flow: expanded folders, scroll position, and selection remain intact when files change around them
</verification>

<success_criteria>
File explorer automatically reflects external filesystem changes. New files/folders appear, deleted files/folders disappear — all without manual refresh. Expanded folders and scroll position are preserved. Watcher lifecycle is tied to the active project.
</success_criteria>

<output>
After completion, create `.planning/phases/22-explorer-filewatcher/22-02-SUMMARY.md`
</output>
