---
phase: 22-explorer-filewatcher
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/ipc/explorer.ipc.js
  - renderer.js
  - src/renderer/ui/components/FileExplorer.js
autonomous: true
requirements:
  - EXPL-WATCH-01
gap_closure: true

must_haves:
  truths:
    - "New file appears automatically without error dialogs"
    - "Deleted file/directory disappears automatically without EPERM exceptions"
    - "No uncaught exception dialog boxes from file watcher operations"
  artifacts:
    - path: "src/main/ipc/explorer.ipc.js"
      provides: "Chokidar watcher with persistent:true and ignorePermissionErrors:true"
      contains: "persistent: true"
    - path: "renderer.js"
      provides: "Error-safe onChanges callback"
      contains: ".catch"
    - path: "src/renderer/ui/components/FileExplorer.js"
      provides: "Error-safe applyWatcherChanges"
      contains: "try"
  key_links:
    - from: "src/main/ipc/explorer.ipc.js"
      to: "chokidar"
      via: "persistent:true activates native error listener in chokidar/handler.js:175-198"
      pattern: "persistent:\\s*true"
    - from: "renderer.js"
      to: "FileExplorer.applyWatcherChanges"
      via: "catch block on async call"
      pattern: "applyWatcherChanges.*\\.catch"
---

<objective>
Fix two blocker UAT gaps from Phase 22: uncaught exception spam from file watcher errors and EPERM crashes on directory deletion.

Purpose: Both gaps share the same root cause — `persistent: false` in chokidar options bypasses native FSWatcher error listener registration (chokidar/handler.js:164-168), causing fs.watch errors to become uncaught exceptions that Electron surfaces as dialog.showErrorBox. On Windows, deleting a watched directory triggers EPERM that chokidar's persistent-mode workaround (handler.js:180-194) would normally swallow silently.

Output: Three files patched so file watcher errors are handled gracefully at every layer.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-explorer-filewatcher/22-UAT.md
@.planning/phases/22-explorer-filewatcher/22-01-SUMMARY.md
@.planning/phases/22-explorer-filewatcher/22-02-SUMMARY.md

<interfaces>
From src/main/ipc/explorer.ipc.js (lines 108-121 — the chokidar.watch call to fix):
```javascript
activeWatcher = chokidar.watch(projectPath, {
    ignored: makeIgnoredFn(),
    persistent: false,        // <-- ROOT CAUSE: must change to true
    ignoreInitial: true,
    awaitWriteFinish: {
      stabilityThreshold: 200,
      pollInterval: 100
    }
  });
```

From renderer.js (lines 1569-1571 — the unguarded async call):
```javascript
api.explorer.onChanges((changes) => {
  FileExplorer.applyWatcherChanges(changes);
});
```

From src/renderer/ui/components/FileExplorer.js (lines 477-523 — async function without try-catch):
```javascript
async function applyWatcherChanges(changes) {
  if (!rootPath || !changes || !changes.length) return;
  // ... no try-catch wrapping the body
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix chokidar persistent mode and add ignorePermissionErrors</name>
  <files>src/main/ipc/explorer.ipc.js</files>
  <action>
In `startWatch()` function (line 113), change the chokidar.watch options object:

1. Change `persistent: false` to `persistent: true` — this activates chokidar's native error listener registration (handler.js:175-198) which catches and swallows EPERM errors from deleted directories on Windows. The Phase 21 markdown viewer uses `persistent: false` for fs.watch to avoid keeping Electron alive, but chokidar's watcher is explicitly managed via `stopWatch()` on project switch and app quit, so persistent:true is safe here.

2. Add `ignorePermissionErrors: true` as defense-in-depth — chokidar will silently ignore EACCES/EPERM errors from subdirectories the user lacks permission to read.

The existing `.on('error', () => {})` handler on line 160-162 stays as-is — it already silently swallows errors that make it through to the watcher-level error event.

Do NOT change any other options (ignored, ignoreInitial, awaitWriteFinish remain as-is).
  </action>
  <verify>
    <automated>node -e "const src = require('fs').readFileSync('src/main/ipc/explorer.ipc.js','utf8'); if (!src.includes('persistent: true')) throw 'missing persistent:true'; if (!src.includes('ignorePermissionErrors: true')) throw 'missing ignorePermissionErrors'; console.log('PASS')"</automated>
  </verify>
  <done>chokidar.watch options contain persistent:true and ignorePermissionErrors:true</done>
</task>

<task type="auto">
  <name>Task 2: Add error handling to renderer onChanges callback and applyWatcherChanges</name>
  <files>renderer.js, src/renderer/ui/components/FileExplorer.js</files>
  <action>
Two changes:

1. In `renderer.js` (line 1569-1571), wrap the async call with `.catch()`:

```javascript
api.explorer.onChanges((changes) => {
  FileExplorer.applyWatcherChanges(changes).catch(() => {
    // Silently ignore — stale path, race condition, etc.
  });
});
```

2. In `src/renderer/ui/components/FileExplorer.js`, wrap the entire body of `applyWatcherChanges` (lines 478-522) in a try-catch. The catch block should silently swallow the error — file watcher changes are best-effort and a failed patch is harmless (user can always manually refresh). Do NOT log to console as that would be noisy for expected transient errors (deleted paths, permission changes).

```javascript
async function applyWatcherChanges(changes) {
  try {
    if (!rootPath || !changes || !changes.length) return;
    // ... existing body unchanged ...
    render();
  } catch {
    // Silently ignore — stale paths, permission errors, etc.
  }
}
```
  </action>
  <verify>
    <automated>node -e "const r = require('fs').readFileSync('renderer.js','utf8'); const f = require('fs').readFileSync('src/renderer/ui/components/FileExplorer.js','utf8'); if (!r.includes('.catch(')) throw 'renderer.js missing .catch'; if (!f.includes('try {') || !f.includes('catch')) throw 'FileExplorer missing try-catch'; console.log('PASS')"</automated>
  </verify>
  <done>onChanges callback catches rejected promises; applyWatcherChanges has top-level try-catch</done>
</task>

</tasks>

<verification>
1. `npm run build:renderer` completes without errors
2. `npm test` passes (no regressions)
3. All three fix points verifiable via grep:
   - `grep "persistent: true" src/main/ipc/explorer.ipc.js`
   - `grep "ignorePermissionErrors" src/main/ipc/explorer.ipc.js`
   - `grep ".catch" renderer.js` (in FILE WATCHER section)
   - `grep "try {" src/renderer/ui/components/FileExplorer.js` (in applyWatcherChanges)
</verification>

<success_criteria>
- File watcher no longer throws uncaught exceptions when files are created externally
- Directory deletion no longer causes EPERM uncaught exception dialogs
- All error paths are silently handled (no dialog boxes, no console spam)
- Existing watcher lifecycle (project switch, app quit) works as before
</success_criteria>

<output>
After completion, create `.planning/phases/22-explorer-filewatcher/22-03-SUMMARY.md`
</output>
