---
phase: 22-explorer-filewatcher
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/ipc/explorer.ipc.js
  - src/main/ipc/index.js
  - src/main/preload.js
autonomous: true
requirements:
  - EXPL-WATCH-01

must_haves:
  truths:
    - "Main process can watch a project directory recursively via chokidar"
    - "Watcher excludes IGNORE_PATTERNS directories (node_modules, .git, etc.)"
    - "File/directory add and remove events are debounced and batched into a single IPC message"
    - "Only one watcher is active at a time — startWatch stops the previous watcher"
    - "Stale watcher events from a previous project are discarded via watchId"
    - "Renderer can call explorer.startWatch/stopWatch and listen to explorer.onChanges via preload bridge"
  artifacts:
    - path: "src/main/ipc/explorer.ipc.js"
      provides: "Chokidar watcher lifecycle, debounced event batching, IPC handlers"
      exports: ["registerExplorerHandlers", "stopWatch"]
    - path: "src/main/ipc/index.js"
      provides: "Explorer handler registration"
      contains: "registerExplorerHandlers"
    - path: "src/main/preload.js"
      provides: "explorer namespace in electron_api"
      contains: "explorer:"
  key_links:
    - from: "src/main/ipc/explorer.ipc.js"
      to: "mainWindow.webContents.send"
      via: "explorer:changes IPC channel"
      pattern: "explorer:changes"
    - from: "src/main/preload.js"
      to: "src/main/ipc/explorer.ipc.js"
      via: "ipcRenderer.send explorer:startWatch/stopWatch"
      pattern: "explorer:startWatch"
---

<objective>
Create the main-process file watcher service using chokidar, with IPC handlers and preload bridge.

Purpose: Establish the backend infrastructure that watches a project directory for filesystem changes and pushes debounced, batched change events to the renderer process.

Output: New `explorer.ipc.js` module with chokidar watcher, registered in IPC index, exposed via preload bridge as `electron_api.explorer`.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-explorer-filewatcher/22-CONTEXT.md
@.planning/phases/22-explorer-filewatcher/22-RESEARCH.md

<interfaces>
<!-- From src/main/ipc/index.js — registration pattern -->
const { registerDialogHandlers, setMainWindow: setDialogMainWindow } = require('./dialog.ipc');
// registerAllHandlers(mainWindow) calls each register function

<!-- From src/main/preload.js — namespace + createListener pattern -->
function createListener(channel) {
  return (callback) => {
    const subscription = (event, ...args) => callback(...args);
    ipcRenderer.on(channel, subscription);
    return () => ipcRenderer.removeListener(channel, subscription);
  };
}
// Namespaces exposed on window.electron_api: { terminal: {...}, dialog: {...}, ... }

<!-- From FileExplorer.js — IGNORE_PATTERNS to mirror -->
const IGNORE_PATTERNS = new Set([
  'node_modules', '.git', 'dist', 'build', '__pycache__',
  '.next', 'vendor', '.cache', '.idea', '.vscode',
  '.DS_Store', 'Thumbs.db', '.env.local', 'coverage',
  '.nuxt', '.output', '.turbo', '.parcel-cache'
]);
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create explorer.ipc.js with chokidar watcher and IPC handlers</name>
  <files>src/main/ipc/explorer.ipc.js</files>
  <action>
Create `src/main/ipc/explorer.ipc.js` — the main-process file watcher module.

**Install chokidar first:**
```bash
npm install chokidar@^4.0.3
```
Verify it installs without needing electron-rebuild (v4 is pure JS).

**Module structure:**

Module-level state:
- `let mainWindow = null` — BrowserWindow reference
- `let activeWatcher = null` — current chokidar instance
- `let watchId = 0` — incremented on each startWatch to detect stale events from closed watchers
- `let pendingChanges = []` — batched change events
- `let debounceTimer = null` — setTimeout handle for flush
- `const DEBOUNCE_MS = 350` — within 300-500ms range per user decision
- `const SOFT_LIMIT = 10000` — soft limit on watched paths

**IGNORED_DIRS** — mirror of IGNORE_PATTERNS from FileExplorer.js:
```javascript
const IGNORED_DIRS = new Set([
  'node_modules', '.git', 'dist', 'build', '__pycache__',
  '.next', 'vendor', '.cache', '.idea', '.vscode',
  '.DS_Store', 'Thumbs.db', '.env.local', 'coverage',
  '.nuxt', '.output', '.turbo', '.parcel-cache'
]);
```

**`makeIgnoredFn()`** — returns a function for chokidar's `ignored` option. The function receives a file path and returns true if any path segment is in IGNORED_DIRS. Split on both `\\` and `/` for cross-platform compatibility.

**`flushChanges(myWatchId)`** — if `myWatchId !== watchId`, return (stale watcher). If no pending changes, return. Send `explorer:changes` to mainWindow via `webContents.send`, then clear `pendingChanges` and `debounceTimer`.

**`stopWatch()`** — increment `watchId` (invalidates in-flight debounce timers). Clear debounceTimer. Clear pendingChanges. If `activeWatcher` exists, call `.close()` (fire-and-forget, it's async internally but safe) and set to null.

**`startWatch(projectPath)`** — call `stopWatch()` first. Capture `const myWatchId = watchId`. Create chokidar watcher with options:
- `ignored: makeIgnoredFn()`
- `persistent: false` — don't prevent process exit
- `ignoreInitial: true` — only watch for changes, not initial scan
- `awaitWriteFinish: { stabilityThreshold: 200, pollInterval: 100 }` — wait for writes to stabilize

Create helper `pushChange(type, filePath, isDirectory)` that: checks `myWatchId !== watchId` (return if stale), pushes to pendingChanges, clears/resets debounceTimer to `setTimeout(() => flushChanges(myWatchId), DEBOUNCE_MS)`.

Wire chokidar events:
- `add` → pushChange('add', p, false)
- `addDir` → pushChange('add', p, true)
- `unlink` → pushChange('remove', p, false)
- `unlinkDir` → pushChange('remove', p, true)
- `ready` → check watched path count via `activeWatcher.getWatched()`, sum all arrays' lengths. If > SOFT_LIMIT, send `explorer:watchLimitWarning` to mainWindow.
- `error` → silently ignore (permission denied on subdirs)

Do NOT watch `change` events — Phase 22 only tracks tree structure changes, not file content modifications.

**`registerExplorerHandlers(mw)`** — set `mainWindow = mw`. Register two IPC handlers:
- `ipcMain.on('explorer:startWatch', (event, projectPath) => { ... })` — validate projectPath is non-empty string, then call `startWatch(projectPath)`
- `ipcMain.on('explorer:stopWatch', () => stopWatch())`

Use `ipcMain.on` (not `ipcMain.handle`) since these are fire-and-forget messages, no return value needed.

**Export:** `{ registerExplorerHandlers, stopWatch }` — stopWatch exported for app cleanup on quit.
  </action>
  <verify>
    <automated>node -e "const m = require('./src/main/ipc/explorer.ipc.js'); console.log(typeof m.registerExplorerHandlers === 'function' && typeof m.stopWatch === 'function' ? 'OK' : 'FAIL')"</automated>
  </verify>
  <done>explorer.ipc.js exists with registerExplorerHandlers and stopWatch exports, chokidar installed in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Register explorer handlers in IPC index and expose via preload bridge</name>
  <files>src/main/ipc/index.js, src/main/preload.js</files>
  <action>
**In `src/main/ipc/index.js`:**

1. Add require at top with other imports:
```javascript
const { registerExplorerHandlers } = require('./explorer.ipc');
```

2. In `registerAllHandlers(mainWindow)`, add call passing mainWindow:
```javascript
registerExplorerHandlers(mainWindow);
```
Place it near other handler registrations (after registerDialogHandlers or at the end before the closing brace).

**In `src/main/preload.js`:**

Add a new `explorer` namespace to `window.electron_api`. Place it near the `dialog` namespace since they're related (file operations).

```javascript
explorer: {
  startWatch: (projectPath) => ipcRenderer.send('explorer:startWatch', projectPath),
  stopWatch: () => ipcRenderer.send('explorer:stopWatch'),
  onChanges: createListener('explorer:changes'),
  onWatchLimitWarning: createListener('explorer:watchLimitWarning')
},
```

Uses `ipcRenderer.send` (not `invoke`) since startWatch/stopWatch are fire-and-forget. Uses existing `createListener` helper for the two event listeners (same pattern as `terminal.onData`, `terminal.onExit`).
  </action>
  <verify>
    <automated>node -e "const src = require('fs').readFileSync('src/main/ipc/index.js','utf8'); const pre = require('fs').readFileSync('src/main/preload.js','utf8'); const ok = src.includes('registerExplorerHandlers') && pre.includes('explorer:') && pre.includes('onChanges') && pre.includes('onWatchLimitWarning'); console.log(ok ? 'OK' : 'FAIL')"</automated>
  </verify>
  <done>Explorer IPC handlers registered in index.js, preload.js exposes explorer namespace with startWatch, stopWatch, onChanges, and onWatchLimitWarning</done>
</task>

</tasks>

<verification>
1. `npm install` succeeds (chokidar installed, no electron-rebuild needed)
2. `node -e "require('chokidar')"` succeeds without error
3. `explorer.ipc.js` exports both `registerExplorerHandlers` and `stopWatch`
4. `index.js` imports and calls `registerExplorerHandlers(mainWindow)`
5. `preload.js` contains `explorer:` namespace with all four methods
6. `npm test` passes (no regressions)
7. `npm run build:renderer` succeeds
</verification>

<success_criteria>
Main process can watch directories via chokidar with debounced event batching and the preload bridge exposes the explorer API to the renderer. No renderer-side integration yet — that is Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/22-explorer-filewatcher/22-01-SUMMARY.md`
</output>
