---
phase: 2.1-fix-pr-13-review-issues-for-terminal-keyboard-shortcuts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/state/settings.state.js
  - src/renderer/ui/components/TerminalManager.js
  - src/renderer/ui/panels/ShortcutsManager.js
  - renderer.js
autonomous: true
requirements:
  - TERM-V2-01
  - TERM-01
  - TERM-04

must_haves:
  truths:
    - "All terminal shortcut settings use flat keys (shortcutXxxEnabled/shortcutXxxKey) instead of nested terminalShortcuts object"
    - "Deep-merge logic in loadSettings() is removed — standard spread handles all settings"
    - "Terminal shortcut toggles in Settings panel still read and write the correct enabled state"
    - "Existing users get safe defaults (enabled !== false guard) for all shortcut keys"
  artifacts:
    - path: "src/renderer/state/settings.state.js"
      provides: "Flat shortcut keys in defaultSettings, no deep-merge"
      contains: "shortcutCtrlCEnabled"
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "Flat key reads for all shortcut settings"
      contains: "getSetting('shortcutCtrlCEnabled')"
    - path: "src/renderer/ui/panels/ShortcutsManager.js"
      provides: "ID-to-flat-key mapping, flat key toggle handlers"
      contains: "shortcutCtrlCEnabled"
    - path: "renderer.js"
      provides: "Flat key startup sync for ctrlTab"
      contains: "shortcutCtrlTabEnabled"
  key_links:
    - from: "src/renderer/ui/panels/ShortcutsManager.js"
      to: "src/renderer/state/settings.state.js"
      via: "setProp with flat key names"
      pattern: "setProp\\('shortcut"
    - from: "src/renderer/ui/components/TerminalManager.js"
      to: "src/renderer/state/settings.state.js"
      via: "getSetting with flat key names"
      pattern: "getSetting\\('shortcut"
---

<objective>
Flatten the nested `terminalShortcuts` settings object to individual flat keys matching the codebase's established settings pattern.

Purpose: PR #13 reviewer (Sterll) flagged the nested `terminalShortcuts` object as inconsistent with the flat key pattern used everywhere else in settings. This plan replaces the nested structure with 8 flat `shortcutXxx` keys, removes the deep-merge logic from `loadSettings()`, and updates all four consumer files.

Output: All shortcut settings use flat keys; deep-merge eliminated; ShortcutsManager UI and TerminalManager key handler read/write flat keys correctly.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/2.1-fix-pr-13-review-issues-for-terminal-keyboard-shortcuts/2.1-CONTEXT.md
@.planning/phases/2.1-fix-pr-13-review-issues-for-terminal-keyboard-shortcuts/2.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Flatten shortcut settings in settings.state.js and update TerminalManager consumers</name>
  <files>src/renderer/state/settings.state.js, src/renderer/ui/components/TerminalManager.js</files>
  <action>
IMPORTANT: All work is done on the `feat/terminal-keyboard-shortcuts` branch. Switch to it first: `git checkout feat/terminal-keyboard-shortcuts`.

**settings.state.js:**
1. In `defaultSettings`, REMOVE the entire `terminalShortcuts` nested object:
   ```js
   terminalShortcuts: {
     ctrlC:              { enabled: true  },
     ctrlV:              { enabled: true  },
     ctrlArrow:          { enabled: true  },
     ctrlTab:            { enabled: true  },
     rightClickPaste:    { enabled: true  },
     rightClickCopyPaste:{ enabled: false }
   }
   ```
2. ADD these 8 flat keys to `defaultSettings` (place them where the nested object was):
   ```js
   shortcutCtrlCEnabled: true,
   shortcutCtrlCKey: 'C',
   shortcutCtrlVEnabled: true,
   shortcutCtrlVKey: 'V',
   shortcutCtrlArrowEnabled: true,
   shortcutCtrlTabEnabled: true,
   shortcutRightClickPasteEnabled: true,
   shortcutRightClickCopyPasteEnabled: false,
   ```
3. In `loadSettings()`, REMOVE the deep-merge block that handles nested `terminalShortcuts`. The standard `{ ...defaultSettings, ...saved }` spread is sufficient for flat keys. Keep `terminalContextMenu` as-is (already flat).

**TerminalManager.js:**
1. In `createTerminalKeyHandler()`, replace all reads of `getSetting('terminalShortcuts')?.xxx?.enabled` with flat key reads:
   - `ts.ctrlC?.enabled === false` → `getSetting('shortcutCtrlCEnabled') === false`
   - `ts.ctrlC?.key` → `getSetting('shortcutCtrlCKey')`
   - `ts.ctrlV?.enabled === false` → `getSetting('shortcutCtrlVEnabled') === false`
   - `ts.ctrlV?.key` → `getSetting('shortcutCtrlVKey')`
   - `ts.ctrlArrow?.enabled === false` → `getSetting('shortcutCtrlArrowEnabled') === false`
   - Remove the `const ts = getSetting('terminalShortcuts') || {};` line at top of handler
2. In `setupRightClickHandler()`, replace:
   - `ts.rightClickCopyPaste?.enabled` → `getSetting('shortcutRightClickCopyPasteEnabled')`
   - `ts.rightClickPaste?.enabled !== false` → `getSetting('shortcutRightClickPasteEnabled') !== false`
   - Remove the `const ts = getSetting('terminalShortcuts') || {};` line in this function too
  </action>
  <verify>
    <automated>cd /c/Users/uhgde/source/repos/claude-terminal && grep -c "terminalShortcuts" src/renderer/state/settings.state.js src/renderer/ui/components/TerminalManager.js | grep -v ":0$" | wc -l</automated>
    <manual>Count should be 0 — no remaining references to nested terminalShortcuts in either file</manual>
  </verify>
  <done>settings.state.js has 8 flat shortcutXxx keys in defaultSettings, no deep-merge block; TerminalManager.js reads all shortcut settings via getSetting('shortcutXxxEnabled') and getSetting('shortcutXxxKey') flat keys</done>
</task>

<task type="auto">
  <name>Task 2: Update ShortcutsManager UI and renderer.js startup sync to use flat keys</name>
  <files>src/renderer/ui/panels/ShortcutsManager.js, renderer.js</files>
  <action>
**ShortcutsManager.js:**
1. Add an `ID_TO_ENABLED_KEY` mapping constant at the top of the file (or inside the relevant function scope):
   ```js
   const ID_TO_ENABLED_KEY = {
     ctrlC: 'shortcutCtrlCEnabled',
     ctrlV: 'shortcutCtrlVEnabled',
     ctrlArrow: 'shortcutCtrlArrowEnabled',
     ctrlTab: 'shortcutCtrlTabEnabled',
     rightClickPaste: 'shortcutRightClickPasteEnabled',
     rightClickCopyPaste: 'shortcutRightClickCopyPasteEnabled',
   };
   ```
2. Add an `ID_TO_KEY_KEY` mapping for rebindable shortcuts:
   ```js
   const ID_TO_KEY_KEY = {
     ctrlC: 'shortcutCtrlCKey',
     ctrlV: 'shortcutCtrlVKey',
   };
   ```
3. Replace the toggle `onchange` handler: instead of deep-merging into `terminalShortcuts`, use `ctx.settingsState.setProp(ID_TO_ENABLED_KEY[id], enabled)`.
4. Replace `getTerminalShortcutKey(id)` reads: instead of reading `terminalShortcuts[id]?.key`, use `getSetting(ID_TO_KEY_KEY[id])` or equivalent.
5. Replace the key-rebind save logic: instead of deep-merging `{ key: newKey }` into `terminalShortcuts[id]`, use `ctx.settingsState.setProp(ID_TO_KEY_KEY[id], newKey)`.
6. Replace the render logic that reads `terminalShortcuts[id]?.enabled` to determine checkbox state: use `getSetting(ID_TO_ENABLED_KEY[id])` with `!== false` guard.

**renderer.js:**
1. Replace the startup sync block that reads from nested `terminalShortcuts`:
   ```js
   // BEFORE:
   const _startupTs = getSetting('terminalShortcuts') || {};
   api.terminal.setCtrlTabEnabled(_startupTs.ctrlTab?.enabled !== false);
   let _prevCtrlTabEnabled = _startupTs.ctrlTab?.enabled !== false;
   settingsState.subscribe(() => { ... terminalShortcuts?.ctrlTab?.enabled ... });

   // AFTER:
   api.terminal.setCtrlTabEnabled(getSetting('shortcutCtrlTabEnabled') !== false);
   let _prevCtrlTab = getSetting('shortcutCtrlTabEnabled') !== false;
   settingsState.subscribe(() => {
     const _tab = getSetting('shortcutCtrlTabEnabled') !== false;
     if (_tab !== _prevCtrlTab) { _prevCtrlTab = _tab; api.terminal.setCtrlTabEnabled(_tab); }
   });
   ```
  </action>
  <verify>
    <automated>cd /c/Users/uhgde/source/repos/claude-terminal && grep -c "terminalShortcuts" src/renderer/ui/panels/ShortcutsManager.js renderer.js | grep -v ":0$" | wc -l</automated>
    <manual>Count should be 0 — no remaining references to nested terminalShortcuts in either file</manual>
  </verify>
  <done>ShortcutsManager.js toggles read/write flat keys via ID_TO_ENABLED_KEY mapping; renderer.js startup sync uses flat getSetting('shortcutCtrlTabEnabled') instead of nested object access</done>
</task>

</tasks>

<verification>
1. `grep -rn "terminalShortcuts" src/renderer/ renderer.js` returns zero results (all nested references eliminated)
2. `grep -c "shortcutCtrlCEnabled" src/renderer/state/settings.state.js` returns 1+ (flat key present in defaults)
3. `grep -c "shortcutCtrlTabEnabled" renderer.js` returns 1+ (startup sync uses flat key)
4. `npm run build:renderer` completes successfully
</verification>

<success_criteria>
- All 8 flat shortcut keys exist in defaultSettings
- Zero references to nested `terminalShortcuts` object in any renderer file
- Deep-merge block removed from loadSettings()
- ShortcutsManager toggle handlers use setProp with flat key names
- TerminalManager key handler uses getSetting with flat key names
- renderer.js startup sync uses flat key reads
- `npm run build:renderer` passes
</success_criteria>

<output>
After completion, create `.planning/phases/2.1-fix-pr-13-review-issues-for-terminal-keyboard-shortcuts/2.1-01-SUMMARY.md`
</output>
