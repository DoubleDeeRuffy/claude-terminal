---
phase: 2.1-fix-pr-13-review-issues-for-terminal-keyboard-shortcuts
plan: 02
type: execute
wave: 2
depends_on:
  - 2.1-01
files_modified:
  - src/main/windows/MainWindow.js
  - src/main/ipc/terminal.ipc.js
  - src/main/preload.js
  - renderer.js
  - src/renderer/i18n/locales/en.json
  - src/renderer/i18n/locales/fr.json
autonomous: true
requirements:
  - TERM-03
  - TERM-05

must_haves:
  truths:
    - "Ctrl+Left/Right is intercepted in main process to prevent Windows Snap regardless of word-jump setting"
    - "When word-jump is enabled, Ctrl+Left/Right reaches xterm naturally for word-jump escape sequences"
    - "When word-jump is disabled, Ctrl+Left/Right sends IPC for old tab-switching behavior"
    - "Word-jump setting syncs from renderer to main process on startup and on settings change"
    - "Branch is rebased on fork's main with a single clean squash commit"
  artifacts:
    - path: "src/main/windows/MainWindow.js"
      provides: "ctrlArrowWordJumpEnabled flag, two-mode Left/Right handler, setCtrlArrowWordJumpEnabled export"
      contains: "ctrlArrowWordJumpEnabled"
    - path: "src/main/ipc/terminal.ipc.js"
      provides: "terminal:setCtrlArrowWordJumpEnabled IPC handler with lazy require"
      contains: "setCtrlArrowWordJumpEnabled"
    - path: "src/main/preload.js"
      provides: "setCtrlArrowWordJumpEnabled method in terminal namespace"
      contains: "setCtrlArrowWordJumpEnabled"
    - path: "renderer.js"
      provides: "Startup sync and live subscribe for ctrlArrowWordJump setting"
      contains: "setCtrlArrowWordJumpEnabled"
  key_links:
    - from: "renderer.js"
      to: "src/main/preload.js"
      via: "api.terminal.setCtrlArrowWordJumpEnabled()"
      pattern: "setCtrlArrowWordJumpEnabled"
    - from: "src/main/ipc/terminal.ipc.js"
      to: "src/main/windows/MainWindow.js"
      via: "lazy require + setCtrlArrowWordJumpEnabled call"
      pattern: "require.*MainWindow.*setCtrlArrowWordJumpEnabled"
    - from: "src/main/windows/MainWindow.js"
      to: "renderer webContents"
      via: "ctrl-arrow IPC send when word-jump disabled"
      pattern: "send\\('ctrl-arrow'"
---

<objective>
Restore Ctrl+Left/Right interception in MainWindow.js to prevent Windows Snap while supporting word-jump, add the IPC chain for setting sync, update i18n labels, and rebase the branch on fork's main.

Purpose: PR #13 reviewer identified that removing Ctrl+Left/Right from `before-input-event` broke the Windows Snap bypass. This plan restores the intercept with a two-mode behavior (word-jump vs tab-switch), mirrors the existing ctrlTab IPC pattern for setting sync, clarifies the UI label, and rebases the branch to resolve PR #12 overlap.

Output: MainWindow.js has ctrlArrowWordJumpEnabled flag with two-mode routing; full IPC chain for setting sync; branch rebased on fork's main as a single squash commit.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/2.1-fix-pr-13-review-issues-for-terminal-keyboard-shortcuts/2.1-CONTEXT.md
@.planning/phases/2.1-fix-pr-13-review-issues-for-terminal-keyboard-shortcuts/2.1-RESEARCH.md
@.planning/phases/2.1-fix-pr-13-review-issues-for-terminal-keyboard-shortcuts/2.1-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ctrlArrowWordJumpEnabled two-mode handler in MainWindow.js + IPC chain + i18n labels</name>
  <files>src/main/windows/MainWindow.js, src/main/ipc/terminal.ipc.js, src/main/preload.js, renderer.js, src/renderer/i18n/locales/en.json, src/renderer/i18n/locales/fr.json</files>
  <action>
All work is on the `feat/terminal-keyboard-shortcuts` branch (already checked out from Plan 01).

**MainWindow.js:**
1. Add module-level flag: `let ctrlArrowWordJumpEnabled = true;`
2. In the `before-input-event` handler, within the `modKey && !input.alt && input.type === 'keyDown'` block, AFTER the existing Ctrl+Tab handler, ADD a Ctrl+Left/Right handler:
   ```js
   if (!input.shift) {
     const lrDir = { Left: 'left', ArrowLeft: 'left', Right: 'right', ArrowRight: 'right' }[input.key];
     if (lrDir) {
       event.preventDefault(); // Always block Windows Snap
       if (!ctrlArrowWordJumpEnabled) {
         // Word-jump disabled → old tab-switch behavior
         mainWindow.webContents.send('ctrl-arrow', lrDir);
       }
       // Word-jump enabled → preventDefault alone; xterm handles word-jump naturally
       return;
     }
   }
   ```
   Place this BEFORE the existing Ctrl+Up/Down handler (which sends ctrl-arrow for project switching). Ensure the existing Up/Down handler only matches Up/Down keys, not Left/Right.
3. Add setter function:
   ```js
   function setCtrlArrowWordJumpEnabled(enabled) {
     ctrlArrowWordJumpEnabled = !!enabled;
   }
   ```
4. Export: add `setCtrlArrowWordJumpEnabled` to module.exports alongside `setCtrlTabEnabled`.

**terminal.ipc.js:**
1. Add IPC handler using lazy require (Phase 04 circular-dep pattern):
   ```js
   ipcMain.handle('terminal:setCtrlArrowWordJumpEnabled', (event, enabled) => {
     const { setCtrlArrowWordJumpEnabled } = require('../windows/MainWindow');
     setCtrlArrowWordJumpEnabled(enabled);
   });
   ```
   Place next to the existing `terminal:setCtrlTabEnabled` handler.

**preload.js:**
1. In the `terminal` namespace object, add:
   ```js
   setCtrlArrowWordJumpEnabled: (enabled) => ipcRenderer.invoke('terminal:setCtrlArrowWordJumpEnabled', enabled),
   ```
   Place next to the existing `setCtrlTabEnabled` method.

**renderer.js:**
1. In the startup sync section (modified by Plan 01 to use flat keys), ADD the ctrlArrow sync alongside ctrlTab:
   ```js
   api.terminal.setCtrlArrowWordJumpEnabled(getSetting('shortcutCtrlArrowEnabled') !== false);
   ```
2. In the settingsState.subscribe block (modified by Plan 01), ADD ctrlArrow live sync:
   ```js
   let _prevCtrlArrow = getSetting('shortcutCtrlArrowEnabled') !== false;
   // Inside subscribe callback:
   const _arrow = getSetting('shortcutCtrlArrowEnabled') !== false;
   if (_arrow !== _prevCtrlArrow) { _prevCtrlArrow = _arrow; api.terminal.setCtrlArrowWordJumpEnabled(_arrow); }
   ```

**i18n labels:**
1. In `en.json`, update the `shortcuts.termCtrlArrow` key (or whatever label key the branch uses for Ctrl+Arrow) to: `"Word jump (Ctrl+\u2190/\u2192) \u2014 replaces tab switching"`
2. In `fr.json`, update the same key to: `"Saut de mot (Ctrl+\u2190/\u2192) \u2014 remplace le changement d'onglet"`

NOTE: Use Unicode escapes for arrows (\u2190/\u2192) and em dash (\u2014) since these are JSON files and the CLAUDE.md warns about encoding issues with special characters.
  </action>
  <verify>
    <automated>cd /c/Users/uhgde/source/repos/claude-terminal && grep -c "ctrlArrowWordJumpEnabled" src/main/windows/MainWindow.js src/main/ipc/terminal.ipc.js src/main/preload.js renderer.js | grep -v ":0$" | wc -l</automated>
    <manual>All 4 files should contain ctrlArrowWordJumpEnabled references (count = 4)</manual>
  </verify>
  <done>MainWindow.js has two-mode Ctrl+Left/Right handler (always preventDefault, conditionally sends IPC); full IPC chain from renderer through preload to main process; i18n labels clarify word-jump replaces tab switching</done>
</task>

<task type="auto">
  <name>Task 2: Rebase branch on fork's main, resolve conflicts, squash to single commit</name>
  <files>feat/terminal-keyboard-shortcuts branch (git operation)</files>
  <action>
**Pre-rebase verification:**
1. Verify all code changes from Plan 01 and Task 1 above are committed on `feat/terminal-keyboard-shortcuts`.
2. Run `npm run build:renderer` to verify the bundle builds cleanly before rebase.

**Rebase on fork's main:**
1. `git fetch origin main` — ensure fork's main is up to date
2. `git rebase origin/main` — rebase onto fork's main (which includes PR #12)
3. During conflict resolution in TerminalManager.js:
   - Keep the keyboard shortcuts branch changes for ALL shortcut-related code (key handler, right-click handler, etc.)
   - Keep main's version for session/chat code (from PR #12)
   - For `findClaudeTerminalForProject`: KEEP main's version (from merged PR #8), DISCARD the duplicate added on the keyboard branch
4. Resolve any other conflicts by keeping the appropriate version (keyboard branch for shortcut code, main for everything else)

**Post-rebase verification:**
1. `npm run build:renderer` — verify bundle builds
2. `npm test` — verify tests pass
3. Verify `findClaudeTerminalForProject` appears exactly once in TerminalManager.js (not duplicated)

**Squash to single commit:**
Follow the squash PR playbook:
1. Count commits: `git log --oneline origin/main..HEAD | wc -l`
2. If more than 1 commit: `git reset --soft origin/main` then `git commit -m "feat(terminal): add keyboard shortcuts with configurable settings"`
3. The commit message should summarize: Ctrl+C copy, Ctrl+V paste, right-click paste, Ctrl+Arrow word-jump, Ctrl+Tab tab switching, configurable settings with flat keys, Windows Snap bypass

**Force push:**
`git push origin feat/terminal-keyboard-shortcuts --force-with-lease`

NOTE: This is a PR branch, not main. Force push with lease is the standard squash workflow.
  </action>
  <verify>
    <automated>cd /c/Users/uhgde/source/repos/claude-terminal && git log --oneline origin/main..HEAD | wc -l</automated>
    <manual>Should be exactly 1 commit (squashed). Also verify: npm run build:renderer succeeds, npm test passes, grep -c findClaudeTerminalForProject src/renderer/ui/components/TerminalManager.js returns exactly 1</manual>
  </verify>
  <done>Branch is rebased on fork's main, all conflicts resolved (main's findClaudeTerminalForProject kept, shortcut code preserved), squashed to single commit, force-pushed to origin</done>
</task>

</tasks>

<verification>
1. `grep -c "ctrlArrowWordJumpEnabled" src/main/windows/MainWindow.js` returns 3+ (flag, handler check, setter)
2. `grep "setCtrlArrowWordJumpEnabled" src/main/ipc/terminal.ipc.js` shows IPC handler
3. `grep "setCtrlArrowWordJumpEnabled" src/main/preload.js` shows preload method
4. `grep "setCtrlArrowWordJumpEnabled" renderer.js` shows startup sync
5. `git log --oneline origin/main..HEAD | wc -l` returns 1 (single squash commit)
6. `grep -c "findClaudeTerminalForProject" src/renderer/ui/components/TerminalManager.js` returns exactly 1 (no duplicate)
7. `npm run build:renderer` passes
8. `npm test` passes
</verification>

<success_criteria>
- MainWindow.js intercepts Ctrl+Left/Right with event.preventDefault() to block Windows Snap
- When shortcutCtrlArrowEnabled is true: no IPC sent, xterm handles word-jump naturally
- When shortcutCtrlArrowEnabled is false: IPC sent for old tab-switch behavior
- Full IPC chain: MainWindow flag + terminal.ipc handler + preload method + renderer sync
- i18n labels clarify word-jump replaces tab switching
- Branch rebased on fork's main, conflicts resolved, squashed to 1 commit
- findClaudeTerminalForProject not duplicated
- npm run build:renderer and npm test pass
</success_criteria>

<output>
After completion, create `.planning/phases/2.1-fix-pr-13-review-issues-for-terminal-keyboard-shortcuts/2.1-02-SUMMARY.md`
</output>
