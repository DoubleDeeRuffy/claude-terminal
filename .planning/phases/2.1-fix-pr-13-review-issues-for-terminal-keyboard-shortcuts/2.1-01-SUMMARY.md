---
phase: 2.1-fix-pr-13-review-issues-for-terminal-keyboard-shortcuts
plan: 01
subsystem: ui
tags: [settings, keyboard-shortcuts, terminal, xterm, electron]

# Dependency graph
requires:
  - phase: 2-terminal-keyboard-shortcuts
    provides: "nested terminalShortcuts settings object and TerminalManager key handlers"
provides:
  - "8 flat shortcutXxx keys in defaultSettings replacing nested terminalShortcuts object"
  - "TerminalManager reads flat keys via getSetting('shortcutXxxEnabled') and getSetting('shortcutXxxKey')"
  - "ShortcutsManager UI reads/writes flat keys via ID_TO_ENABLED_KEY and ID_TO_KEY_KEY mappings"
  - "renderer.js startup sync uses getSetting('shortcutCtrlTabEnabled') !== false"
affects: [phase-2.1-plan-02, phase-2.1-plan-03]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Flat settings keys pattern: shortcutXxxEnabled/shortcutXxxKey instead of nested objects"
    - "ID_TO_ENABLED_KEY and ID_TO_KEY_KEY maps in ShortcutsManager for id-to-flat-key dispatch"

key-files:
  created: []
  modified:
    - src/renderer/state/settings.state.js
    - src/renderer/ui/components/TerminalManager.js
    - src/renderer/ui/panels/ShortcutsManager.js
    - renderer.js

key-decisions:
  - "shortcutCtrlCKey default is 'C' (bare letter); rebound value is a full key string like 'Ctrl+X' saved by shortcut capture — comparison uses !== 'C' to detect rebind"
  - "terminalContextMenu flat key kept as-is — controls distinct behavior (show menu vs instant paste), logically separate from shortcutXxx keys"
  - "i18n key 'shortcuts.terminalShortcuts' retained in ShortcutsManager as UI section title — not a settings object reference"
  - "No migration shim for nested->flat: clean break; existing settings files missing these keys fall back to defaults via !== false guard"

patterns-established:
  - "Flat shortcut pattern: use shortcutXxxEnabled (boolean) and shortcutXxxKey (string) at defaultSettings top level"
  - "ID_TO_ENABLED_KEY map in ShortcutsManager for toggle dispatch without if-else chains"

requirements-completed: [TERM-V2-01, TERM-01, TERM-04]

# Metrics
duration: 15min
completed: 2026-02-26
---

# Phase 2.1 Plan 01: Settings Flattening Summary

**Replaced nested `terminalShortcuts` object with 8 flat `shortcutXxx` keys across 4 files, removing deep-merge logic from loadSettings() and updating all consumers to flat key reads**

## Performance

- **Duration:** ~15 min
- **Started:** 2026-02-26T00:00:00Z
- **Completed:** 2026-02-26
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- Removed nested `terminalShortcuts` object from `defaultSettings` and replaced with 8 flat keys (`shortcutCtrlCEnabled`, `shortcutCtrlCKey`, `shortcutCtrlVEnabled`, `shortcutCtrlVKey`, `shortcutCtrlArrowEnabled`, `shortcutCtrlTabEnabled`, `shortcutRightClickPasteEnabled`, `shortcutRightClickCopyPasteEnabled`)
- Removed deep-merge block from `loadSettings()` — standard `{ ...defaultSettings, ...saved }` spread handles flat keys correctly
- Updated `TerminalManager.js` key handler and right-click handler to use `getSetting('shortcutXxxEnabled')` and `getSetting('shortcutXxxKey')` flat key reads
- Updated `ShortcutsManager.js` with `ID_TO_ENABLED_KEY`/`ID_TO_KEY_KEY` maps; toggle handlers and key rebind handlers write flat keys via `setProp`
- Updated `renderer.js` startup sync to read `getSetting('shortcutCtrlTabEnabled') !== false`
- All 262 tests pass; `npm run build:renderer` succeeds

## Task Commits

Each task was committed atomically:

1. **Task 1: Flatten shortcut settings in settings.state.js and update TerminalManager consumers** - `2a77580c` (refactor)
2. **Task 2: Update ShortcutsManager UI and renderer.js startup sync to use flat keys** - `b39daca2` (refactor)

## Files Created/Modified

- `src/renderer/state/settings.state.js` - 8 flat shortcutXxx keys in defaultSettings; deep-merge block removed from loadSettings()
- `src/renderer/ui/components/TerminalManager.js` - All shortcut reads converted to getSetting('shortcutXxxEnabled') and getSetting('shortcutXxxKey') flat keys
- `src/renderer/ui/panels/ShortcutsManager.js` - ID_TO_ENABLED_KEY/ID_TO_KEY_KEY maps; toggle onchange writes flat keys; getTerminalShortcutKey reads flat keys
- `renderer.js` - Startup sync uses getSetting('shortcutCtrlTabEnabled') !== false

## Decisions Made

- `shortcutCtrlCKey` default is `'C'` (bare letter). When user rebinds, the full key string (e.g., `'Ctrl+X'`) is stored. Rebind detection: `storedKey !== 'C'`. The `normalizeStoredKey` call then uses the full stored key directly without prefixing `Ctrl+`.
- `terminalContextMenu` key kept as-is (already flat, logically separate from shortcut enable/disable keys).
- The i18n key `t('shortcuts.terminalShortcuts')` in ShortcutsManager is a UI section title string — correctly retained.

## Deviations from Plan

None - plan executed exactly as written. One minor implementation detail resolved during execution: the `normalizeStoredKey` call in TerminalManager.js for rebound keys uses the stored key directly (not `'Ctrl+' + key`) since rebound values from shortcut capture are already full key strings like `'Ctrl+X'`.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Settings flattening complete; all four consumer files updated
- Plan 2.1-02 (Ctrl+Left/Right main-process intercept) can now proceed — it reads `shortcutCtrlArrowEnabled` which is now a flat key
- Plan 2.1-03 (rebase) can proceed last after all code fixes are applied

---
*Phase: 2.1-fix-pr-13-review-issues-for-terminal-keyboard-shortcuts*
*Completed: 2026-02-26*

## Self-Check: PASSED

- SUMMARY.md: FOUND at `.planning/phases/2.1-fix-pr-13-review-issues-for-terminal-keyboard-shortcuts/2.1-01-SUMMARY.md`
- Commit `2a77580c`: FOUND (Task 1 — settings.state.js + TerminalManager.js)
- Commit `b39daca2`: FOUND (Task 2 — ShortcutsManager.js + renderer.js)
- `npm run build:renderer`: PASSED
- `npm test`: 262/262 tests PASSED
