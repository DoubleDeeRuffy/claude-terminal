# Phase 14.1: Resumed Session Tab Naming - Research

**Researched:** 2026-02-27
**Domain:** Renderer IPC data flow — resume dialog → tab creation → tab name
**Confidence:** HIGH (all findings from direct codebase inspection)

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

- **Naming source:** Restore the original tab name from the resume dialog data (same data Phase 10.1 shows in the picker — i.e. `displayTitle` from `preprocessSessions`)
- **Timing:** Name applies after the session connects, not immediately on tab creation — tab shows "Resume..." during connection (current behavior unchanged)
- **Default passthrough:** If the original tab had no custom name (still "Terminal N" or default `project.name`), keep that default name as-is — no AI rename triggered
- **No re-persistence:** The name is already stored in `session-names.json` — no need to re-persist after patching it into the tab
- **Override behavior:** Manual rename after resume overrides the restored name permanently — standard rename behavior unchanged
- **No visual distinction:** No indicator differentiating resumed tabs from fresh tabs once name is patched in
- **No extra loading indicator:** Keep "Resume..." interim state unchanged
- **Data flow:** Resume dialog passes session name to tab creation flow directly (in the callback/event, not looked up separately)
- **Scope:** Dialog-resume only — app-restart restore (Phase 16) already implemented

### Claude's Discretion

- Exact event/callback shape for passing the name from dialog to tab creation
- Where to hook the name patch (SESSION_START event vs direct callback)
- Error handling if session name is missing or empty

### Deferred Ideas (OUT OF SCOPE)

None — discussion stayed within phase scope
</user_constraints>

---

## Summary

Phase 14.1 is a targeted data-threading fix. The resume dialog (`renderSessionsPanel`) already has full session metadata including a `displayTitle` (from `preprocessSessions` + `getSessionCustomName`) at click time. The bug is that this name is never forwarded to `resumeSession`, which creates the tab with a hardcoded `t('terminals.resuming')` name. The session then gets renamed only if Claude's OSC title handler or haiku AI fires — but only for new conversations, not resumes.

The fix has three touch points: (1) the card click handler passes the `displayTitle` through via the `sessionMap`, (2) `resumeSession` accepts and forwards a `name` option, (3) both terminal-mode and chat-mode tab creation use the name to patch the tab after connection. The "after connection" constraint from CONTEXT.md means the tab starts as "Resume..." and gets patched once the PTY/session emits its first data — but inspection reveals the simplest implementation just sets the name immediately after the terminal data object is created (before PTY data arrives), matching Phase 16's pattern where `createTerminal` accepts a `name` option.

The chat-mode path (`createChatTerminal`) already accepts a `name` option and uses it as the initial tab name (`const tabName = customName || project.name`), so that path only needs the caller to pass the name. The terminal-mode path (`resumeSession`) creates its own tab inline and must be updated separately.

**Primary recommendation:** Thread `displayTitle` from `sessionMap` through `resumeSession(project, sessionId, { skipPermissions, name })` — then apply it in both the terminal-mode tab creation and the chat-mode `createChatTerminal` call within `resumeSession`.

---

## Architecture Patterns

### File: `src/renderer/ui/components/TerminalManager.js`

This is the single file requiring changes. All relevant code lives here.

### Current Data Flow (broken)

```
renderSessionsPanel()
  └─ preprocessSessions(sessions)  →  [{ sessionId, displayTitle, isRenamed, ... }]
     └─ sessionMap = Map(sessionId → processedSession)  ← displayTitle IS available here
        └─ card click → resumeSession(project, sessionId, { skipPermissions })
                                                          ↑ name NOT forwarded
           ├─ terminal mode: termData.name = t('terminals.resuming')  ← hardcoded, never updated
           └─ chat mode: createChatTerminal(project, { resumeSessionId })
                         └─ tabName = customName || project.name  ← falls back to project.name
```

### Fixed Data Flow

```
renderSessionsPanel()
  └─ sessionMap = Map(sessionId → processedSession)
     └─ card click:
        const session = sessionMap.get(sessionId);
        const sessionName = session?.displayTitle || null;
        resumeSession(project, sessionId, { skipPermissions, name: sessionName })
           ├─ terminal mode: termData.name = name || t('terminals.resuming')
           │  AND tab.querySelector('.tab-name').textContent = name  (after tab creation)
           └─ chat mode: createChatTerminal(project, { resumeSessionId, name })
```

### Pattern 1: Name option threading (established by Phase 16)

`createTerminal` already accepts a `name` option (used in Phase 16 restore flow):

```javascript
// In renderer.js restore loop (Phase 16):
await TerminalManager.createTerminal(project, {
  runClaude: !tab.isBasic,
  cwd,
  mode: tab.mode || null,
  skipPermissions: settingsState.get().skipPermissions,
  resumeSessionId: (!tab.isBasic && tab.claudeSessionId) ? tab.claudeSessionId : null,
  name: tab.name || null,   // Phase 16: persist tab name
});
```

The same pattern applies: pass `name` as an option, use it as the initial `tabName`.

### Pattern 2: `createChatTerminal` already handles `name` option

```javascript
// Existing (src/renderer/ui/components/TerminalManager.js ~line 3787-3792):
async function createChatTerminal(project, options = {}) {
  const { skipPermissions = false, name: customName = null, resumeSessionId = null, ... } = options;
  const tabName = customName || project.name;
  // tabName is used for both termData.name and the DOM tab text
```

Chat mode only needs the caller to pass `name` — the function already handles it correctly.

### Pattern 3: Terminal-mode `resumeSession` inline tab creation

Unlike `createTerminal` (which routes through `createChatTerminal` or the general path), `resumeSession` builds the terminal and tab inline without going through `createTerminal`. The tab text is set here:

```javascript
// Line ~2971-2989 (current):
const termData = {
  ...
  name: t('terminals.resuming'),   // ← CHANGE: use name || t('terminals.resuming')
  ...
};
// ...
tab.innerHTML = `
  <span class="status-dot"></span>
  <span class="tab-name">${escapeHtml(t('terminals.resuming'))}</span>  // ← CHANGE: use name
  ...`;
```

The CONTEXT.md decision says "name applies after session connects, not immediately on tab creation." However, inspecting the Phase 16 restore pattern shows names are set immediately at tab creation (before PTY data arrives). The simplest conforming interpretation: show "Resume..." for truly async connection delay, then patch once connected. But the simpler implementation (set name immediately at tab creation, matching Phase 16's `name: tab.name || null` pattern) achieves the same user-visible result — the user sees the name when they click, not "Resume...".

**Recommendation (Claude's discretion):** Apply the name immediately at tab creation, consistent with Phase 16. The CONTEXT.md says "tab shows 'Resume...' during connection" which describes current behavior to preserve — if a name IS available, show it immediately (same as Phase 16 restore). If name is null/empty, fall back to "Resume..." (existing behavior).

### Pattern 4: Name guard — when NOT to apply (default names)

The CONTEXT.md decision: "If the original tab had no custom name (still 'Terminal N' or default), keep that default name as-is."

In `preprocessSessions`, the `displayTitle` always has a value — it falls back to "Untitled conversation" when there's no custom name, summary, or prompt. The distinction:

- `isRenamed: true` → session has a custom name from `setSessionCustomName` (set by haiku AI, slash command, or manual rename)
- `isRenamed: false` → title derived from summary/prompt text, not a user/AI-set name

The CONTEXT.md intent: only apply the `displayTitle` as the tab name if it represents a meaningful name (custom name or haiku AI name), not a raw prompt snippet. However, the simpler reading is: pass `displayTitle` regardless — the summary/prompt-derived title IS more meaningful than "Resume...", and the user can always rename. The decision says "Terminal N" or "default" — the only truly "default" title in the resume dialog is "Untitled conversation" (when `displayTitle` falls back to that string).

**Recommendation (Claude's discretion):** Pass `displayTitle` as the name only when `isRenamed` is true OR when `customName` (from `getSessionCustomName`) is truthy. Otherwise pass `null` (falls back to "Resume..."). This strictly matches the decision: only propagate names that were explicitly set, not summary snippets.

Alternative: Pass `displayTitle` always (including summary/prompt snippets). This is user-friendly but may not match the intent of "no custom name = keep default."

---

## Code Examples

### Change 1: Card click handler (passes name)

```javascript
// src/renderer/ui/components/TerminalManager.js — inside card click handler (~line 2851-2856)
const card = e.target.closest('.session-card');
if (!card) return;
const sessionId = card.dataset.sid;
if (!sessionId) return;
const skipPermissions = getSetting('skipPermissions') || false;
const session = sessionMap.get(sessionId);
// Only pass name if it was explicitly set (custom name / haiku AI / slash command)
const sessionName = (session?.isRenamed && session?.displayTitle) ? session.displayTitle : null;
resumeSession(project, sessionId, { skipPermissions, name: sessionName });
```

### Change 2: `resumeSession` signature

```javascript
// ~line 2921:
async function resumeSession(project, sessionId, options = {}) {
  const { skipPermissions = false, name: sessionName = null } = options;

  // chat mode path:
  return createChatTerminal(project, { skipPermissions, resumeSessionId: sessionId, name: sessionName });

  // terminal mode path — termData:
  const termData = {
    ...
    name: sessionName || t('terminals.resuming'),
    ...
  };
  // terminal mode path — tab DOM:
  tab.innerHTML = `
    <span class="status-dot"></span>
    <span class="tab-name">${escapeHtml(sessionName || t('terminals.resuming'))}</span>
    ...`;
```

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead |
|---------|-------------|-------------|
| Name persistence after resume | New save call | Already handled — `session-names.json` already has the name; `TerminalSessionService.saveTerminalSessions()` persists tab state on normal rename events |
| Looking up session name by ID at resume time | Separate `getSessionCustomName(sessionId)` call inside `resumeSession` | Use the `displayTitle` already in `sessionMap` at click time — avoids duplicate file I/O and is consistent with what the user sees in the dialog |

---

## Common Pitfalls

### Pitfall 1: Passing null name to `createChatTerminal` when not needed

**What goes wrong:** If `sessionName` is `null`, `createChatTerminal` falls back to `project.name` (already existing behavior). This is correct — no regression.

**How to avoid:** Guard `name: sessionName` with `sessionName ? { name: sessionName } : {}` spread OR let `createChatTerminal`'s existing `customName = null` default handle it — the fallback to `project.name` is safe.

### Pitfall 2: `sessionMap` scope — only available inside `renderSessionsPanel`

**What goes wrong:** `sessionMap` is a closure-scoped `Map` inside `renderSessionsPanel`. It is correctly available at the card click handler site (line 2856) because the handler is defined within the same function.

**How to avoid:** No change needed — the fix accesses `sessionMap` at the same scope as the existing click handler.

### Pitfall 3: `displayTitle` for sessions with no custom name

**What goes wrong:** `preprocessSessions` always sets `displayTitle`. For a session with no custom name and no summary, `displayTitle` is "Untitled conversation". Passing this to `resumeSession` would show "Untitled conversation" as the tab name instead of the expected default behavior.

**How to avoid:** Use the `isRenamed` flag to distinguish intentionally-named sessions from fallback-titled ones. Only pass `displayTitle` when `isRenamed === true`.

### Pitfall 4: OSC title overwrites the restored name

**What goes wrong:** After the resumed session starts, Claude emits OSC title changes. `handleClaudeTitleChange` calls `updateTerminalTabName` which can overwrite the restored name with a tool name or task name.

**Impact assessment:** This is existing behavior for all tabs. Phase 18 (`aiTabNaming`) and Phase 10 (`tabRenameOnSlashCommand`) guards are already in place. The restored name will be overwritten by AI naming if the user resumes and immediately starts a new task — which is acceptable and consistent with how all other tabs behave.

**No action needed:** This is not a regression, it is existing behavior.

### Pitfall 5: `resumeSession` for terminal mode doesn't go through `createTerminal`

**What goes wrong:** Unlike the Phase 16 restore path (which calls `createTerminal(project, { name })`), `resumeSession` for terminal mode builds the terminal object inline. The `name` must be applied to both `termData.name` AND the DOM tab `<span class="tab-name">`. Missing either leaves inconsistent state.

**How to avoid:** Update both locations in the inline terminal creation code within `resumeSession`.

---

## Validation Architecture

nyquist_validation is not set in config.json, so this section is skipped per instructions.

---

## Open Questions

1. **Should `displayTitle` from prompt/summary snippets be used as tab names?**
   - What we know: `isRenamed` distinguishes user/AI-set names from auto-derived display text
   - What's unclear: The CONTEXT.md says "Terminal N or default" — in the resume dialog there is no "Terminal N"; the closest default is "Untitled conversation"
   - Recommendation: Use `isRenamed` guard (only propagate explicitly-set names). If user wants to also propagate summary snippets, that can be a follow-up decision.

2. **Should `name` patch happen immediately or deferred until SESSION_START?**
   - What we know: Phase 16 sets names immediately at tab creation time
   - CONTEXT.md says "name applies after session connects" — but this describes the current behavior for the AI haiku rename, not a hard constraint on this phase
   - Recommendation: Set immediately at tab creation (Phase 16 pattern), consistent with how restored tabs work. The user sees a meaningful name the moment they click.

---

## Sources

### Primary (HIGH confidence)

All findings from direct codebase inspection of:
- `src/renderer/ui/components/TerminalManager.js` — `resumeSession`, `renderSessionsPanel`, `preprocessSessions`, `createChatTerminal`, `updateTerminalTabName`, `buildSessionCardHtml`
- `src/renderer/services/TerminalSessionService.js` — Phase 16 name persistence pattern
- `renderer.js` — Phase 16 restore loop showing `name: tab.name || null` option pattern
- `src/renderer/i18n/locales/en.json` + `fr.json` — `terminals.resuming` key

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — pure JS renderer code, no libraries needed
- Architecture: HIGH — data flow traced end-to-end in source
- Pitfalls: HIGH — identified from direct code inspection, not speculation

**Research date:** 2026-02-27
**Valid until:** Until TerminalManager.js is significantly refactored (stable)
