---
phase: 14.1-resumed-session-tab-naming
plan: "03"
type: execute
wave: 1
depends_on: ["14.1-02"]
files_modified:
  - src/renderer/ui/components/TerminalManager.js
autonomous: true
gap_closure: true
requirements: [SESS-RESUME-01, TAB-RESUME-01]

must_haves:
  truths:
    - "When user resumes a session with any saved name (haiku AI, slash command, or manual rename), the tab displays that name immediately and keeps it after the session becomes ready"
    - "When user resumes a session with no saved name, the tab shows 'Resume...' then receives a haiku name via the normal AI naming flow when Claude first becomes active"
  artifacts:
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "isRenamed condition widened at line 2889; explicit updateTerminalTabName call after addTerminal in resumeSession"
      contains: "session?.displayTitle"
  key_links:
    - from: "renderSessionsPanel card click"
      to: "resumeSession options.name"
      via: "session?.displayTitle (without isRenamed guard)"
      pattern: "session\\?\\.(displayTitle)"
    - from: "resumeSession addTerminal call"
      to: "updateTerminalTabName"
      via: "explicit call if sessionName is truthy"
      pattern: "updateTerminalTabName\\(id, sessionName\\)"
---

<objective>
Fix two targeted bugs in TerminalManager.js that cause resumed session tabs to stay frozen at "Resume..." even when a saved name exists.

Purpose: Plans 01 and 02 threaded the session name and added claudeSessionId, but two conditions still prevent the name from displaying: (1) the isRenamed guard at line 2889 excludes AI-haiku named sessions which have isRenamed=false, and (2) the --resume CLI command returns to ready state without emitting a new OSC task name, so updateTerminalTabName() is never triggered for either renamed or un-renamed sessions.

Output: Two minimal edits to TerminalManager.js — one guard widened, one explicit name call added.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14.1-resumed-session-tab-naming/14.1-02-SUMMARY.md

<interfaces>
<!-- Exact current code at the two change sites. No exploration needed. -->

SITE 1 — Card click handler (line 2887-2890 in TerminalManager.js):
```javascript
const session = sessionMap.get(sessionId);
// Only pass name if it was explicitly set (haiku AI, slash command, or manual rename)
const sessionName = (session?.isRenamed && session?.displayTitle) ? session.displayTitle : null;
resumeSession(project, sessionId, { skipPermissions, name: sessionName });
```

Problem: `session?.isRenamed` is false for AI-haiku named sessions (isRenamed is only set true
for explicit user renames). The guard must be widened to just check displayTitle presence.

Fix: Remove the `isRenamed` check — trust displayTitle alone:
```javascript
const sessionName = session?.displayTitle || null;
```

SITE 2 — Inside resumeSession(), immediately after addTerminal call (line 3012):
```javascript
addTerminal(id, termData);

// Start time tracking for this project
heartbeat(project.id, 'terminal');
```

Problem: After --resume, Claude CLI returns to the ready state (✳) but emits no new
task name in the OSC title — it just says "Claude Code". parseClaudeTitle() filters out
"Claude Code" at line 338: `if (!content || content === 'Claude Code') return { state };`
So handleClaudeTitleChange() never calls updateTerminalTabName(), and the tab stays "Resume...".

Fix: After addTerminal(), if sessionName is truthy, immediately call updateTerminalTabName()
to persist it to session-names.json and DOM. This is idempotent — if OSC fires a real task
name later it will overwrite correctly via the normal flow.

```javascript
addTerminal(id, termData);

// If a saved name was passed from the resume dialog, persist it now.
// --resume sessions do not emit a new OSC task name, so we cannot rely on
// handleClaudeTitleChange to call updateTerminalTabName. Explicit call here
// mirrors what OSC would do: write to session-names.json + update DOM.
if (sessionName) {
  updateTerminalTabName(id, sessionName);
}

// Start time tracking for this project
heartbeat(project.id, 'terminal');
```

NOTE on un-renamed sessions (Test 2 from UAT): when sessionName is null and no OSC task
name fires, the tab stays "Resume..." until the user next interacts with Claude and a new
task title is emitted. This is acceptable interim behavior — the haiku AI namer fires on
SESSION_START events from hooks, not on --resume ready state. The tab will get a name on
the next actual task.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Widen isRenamed guard and add explicit updateTerminalTabName after resume</name>
  <files>src/renderer/ui/components/TerminalManager.js</files>
  <action>
Make exactly two edits to `src/renderer/ui/components/TerminalManager.js`:

**Edit 1 — Widen the sessionName guard in renderSessionsPanel card click handler.**

Find the block (around line 2887-2889):
```javascript
const session = sessionMap.get(sessionId);
// Only pass name if it was explicitly set (haiku AI, slash command, or manual rename)
const sessionName = (session?.isRenamed && session?.displayTitle) ? session.displayTitle : null;
```

Replace with:
```javascript
const session = sessionMap.get(sessionId);
// Pass name from session-names.json when present (covers haiku AI, slash command, manual rename)
const sessionName = session?.displayTitle || null;
```

Remove the old comment and change the ternary to a simple OR. The `isRenamed` check was overly narrow — AI-haiku names stored in session-names.json are reflected in displayTitle but have isRenamed=false.

**Edit 2 — Explicit updateTerminalTabName call after addTerminal in resumeSession.**

Find the block immediately after `addTerminal(id, termData);` (around line 3012):
```javascript
addTerminal(id, termData);

// Start time tracking for this project
heartbeat(project.id, 'terminal');
```

Replace with:
```javascript
addTerminal(id, termData);

// If a saved name was passed, persist it immediately — --resume does not emit
// a new OSC task name, so handleClaudeTitleChange will not call updateTerminalTabName.
if (sessionName) {
  updateTerminalTabName(id, sessionName);
}

// Start time tracking for this project
heartbeat(project.id, 'terminal');
```

Do NOT change any other code. These are the only two edits needed.
  </action>
  <verify>
    <automated>cd /c/Users/uhgde/source/repos/claude-terminal && grep -n "session?.displayTitle" src/renderer/ui/components/TerminalManager.js && grep -n "updateTerminalTabName(id, sessionName)" src/renderer/ui/components/TerminalManager.js</automated>
  </verify>
  <done>
    `session?.isRenamed &&` is removed from the sessionName assignment. `updateTerminalTabName(id, sessionName)` is called after `addTerminal(id, termData)` guarded by `if (sessionName)`. Both greps return matches. `npm test` passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build and test</name>
  <files>dist/renderer.bundle.js</files>
  <action>
Run the renderer build and test suite to confirm no regressions:

```bash
cd /c/Users/uhgde/source/repos/claude-terminal
npm run build:renderer
npm test
```

Both must succeed. If `npm test` fails, diagnose and fix before proceeding.

After both pass, remind the user to run `npm start` and manually retest the resume dialog (UAT tests 1 and 2).
  </action>
  <verify>
    <automated>cd /c/Users/uhgde/source/repos/claude-terminal && npm run build:renderer && npm test</automated>
  </verify>
  <done>
    `npm run build:renderer` exits 0. `npm test` exits 0 with all suites passing. dist/renderer.bundle.js is up to date.
  </done>
</task>

</tasks>

<verification>
1. `grep -n "isRenamed" src/renderer/ui/components/TerminalManager.js` — the `session?.isRenamed &&` clause must no longer appear in the card click handler (line ~2888); it may still appear in other contexts.
2. `grep -n "updateTerminalTabName(id, sessionName)" src/renderer/ui/components/TerminalManager.js` — must return exactly one match inside resumeSession().
3. `npm run build:renderer` — exits 0.
4. `npm test` — all tests pass.
</verification>

<success_criteria>
- Card click handler uses `session?.displayTitle || null` (no isRenamed gate)
- resumeSession() calls `updateTerminalTabName(id, sessionName)` immediately after addTerminal when sessionName is truthy
- Build and tests pass
- Resumed tabs with any saved name (haiku AI or manual) display that name immediately on creation
</success_criteria>

<output>
After completion, create `.planning/phases/14.1-resumed-session-tab-naming/14.1-03-SUMMARY.md`
</output>
