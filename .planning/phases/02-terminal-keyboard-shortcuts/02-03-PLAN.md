---
phase: 02-terminal-keyboard-shortcuts
plan: 03
type: execute
wave: 3
depends_on:
  - "02-02"
files_modified:
  - src/renderer/ui/components/TerminalManager.js
autonomous: true
requirements:
  - TERM-04
must_haves:
  truths:
    - "Right-clicking in the terminal pastes clipboard content"
    - "Right-click paste works even when window focus is uncertain"
    - "Right-click paste is debounced to prevent double-paste"
    - "Right-click paste works in FiveM and WebApp console terminals"
  artifacts:
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "contextmenu event listener on terminal wrapper elements"
      contains: "contextmenu"
  key_links:
    - from: "contextmenu listener"
      to: "api.app.clipboardRead"
      via: "IPC clipboard read (not navigator.clipboard)"
      pattern: "contextmenu.*clipboardRead"
    - from: "contextmenu listener"
      to: "api.terminal.input"
      via: "PTY input after clipboard read"
      pattern: "clipboardRead.*terminal\\.input"
---

<objective>
Add right-click paste to terminal via a contextmenu event listener using the IPC clipboard path.

Purpose: Users expect right-click paste in a terminal emulator — this is a standard Windows terminal behavior.
Output: contextmenu listener on terminal wrapper elements, using api.app.clipboardRead() to avoid focus-loss failures.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-terminal-keyboard-shortcuts/02-RESEARCH.md
@.planning/phases/02-terminal-keyboard-shortcuts/02-02-SUMMARY.md
@src/renderer/ui/components/TerminalManager.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add contextmenu paste listener to all terminal creation paths</name>
  <files>
    src/renderer/ui/components/TerminalManager.js
  </files>
  <action>
Create a reusable function `setupRightClickPaste(wrapper, terminalId, inputChannel)` in TerminalManager.js that adds a `contextmenu` event listener for paste. Place it near the existing `setupPasteHandler` and `setupClipboardShortcuts` helper functions.

```js
function setupRightClickPaste(wrapper, terminalId, inputChannel = 'terminal-input') {
  wrapper.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    const now = Date.now();
    if (now - lastPasteTime < PASTE_DEBOUNCE_MS) return;
    lastPasteTime = now;

    // Use IPC clipboard path directly — navigator.clipboard.readText() fails
    // on focus loss which can happen during right-click in some Electron versions
    api.app.clipboardRead().then((text) => {
      if (!text) return;
      if (inputChannel === 'fivem-input') {
        api.fivem.input({ projectIndex: terminalId, data: text });
      } else if (inputChannel === 'webapp-input') {
        api.webapp.input({ projectIndex: terminalId, data: text });
      } else {
        api.terminal.input({ id: terminalId, data: text });
      }
    });
  });
}
```

CRITICAL: Use `api.app.clipboardRead()` (IPC path), NOT `navigator.clipboard.readText()`. The STATE.md blocker note explicitly warns about focus-loss causing silent failure with the browser clipboard API.

CRITICAL: Use the shared `lastPasteTime` / `PASTE_DEBOUNCE_MS` variables for debounce to prevent double-paste with other paste handlers (Ctrl+V, Ctrl+Shift+V, paste event).

CRITICAL: Use the `inputChannel` parameter for correct routing to FiveM/WebApp consoles, same pattern as all other paste handlers.

Then wire `setupRightClickPaste` into ALL terminal creation code paths. Search TerminalManager.js for all places where `setupPasteHandler` is called — there should be ~5 call sites (regular terminal, Claude terminal, FiveM terminal, WebApp terminal, API terminal). Add a `setupRightClickPaste(wrapper, terminalId, inputChannel)` call immediately after each `setupPasteHandler(...)` call, passing the same arguments.

The exact call sites to find (search for `setupPasteHandler`):
1. Regular terminal creation
2. Claude terminal creation
3. FiveM terminal creation (uses `'fivem-input'` channel)
4. WebApp terminal creation (uses `'webapp-input'` channel)
5. API terminal creation (if it exists)

For each call site, verify what `inputChannel` value is passed and use the same one for `setupRightClickPaste`.
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && node -e "const fs=require('fs'); const src=fs.readFileSync('src/renderer/ui/components/TerminalManager.js','utf8'); let ok=true; if(!src.includes('setupRightClickPaste')) { console.log('FAIL: setupRightClickPaste function not found'); ok=false; } if(!src.includes('contextmenu')) { console.log('FAIL: No contextmenu listener'); ok=false; } const calls=(src.match(/setupRightClickPaste\(/g)||[]).length; const pasteHandlerCalls=(src.match(/setupPasteHandler\(/g)||[]).length; console.log('setupRightClickPaste calls:', calls-1, '(minus definition)'); console.log('setupPasteHandler calls:', pasteHandlerCalls); if(calls-1 < pasteHandlerCalls) { console.log('WARN: setupRightClickPaste called fewer times than setupPasteHandler — may be missing call sites'); } if(!src.includes('clipboardRead')) { console.log('FAIL: Not using IPC clipboard path'); ok=false; } if(ok) console.log('PASS: Right-click paste wired correctly');"</automated>
    <manual>Right-click in a terminal — clipboard content should paste. Try right-clicking rapidly — should not double-paste.</manual>
  </verify>
  <done>Right-clicking in any terminal type (regular, Claude, FiveM, WebApp) pastes clipboard content via IPC path with debounce protection.</done>
</task>

</tasks>

<verification>
1. `grep -n "contextmenu" src/renderer/ui/components/TerminalManager.js` — shows the listener
2. `grep -n "setupRightClickPaste" src/renderer/ui/components/TerminalManager.js` — shows function definition + all call sites
3. `grep -n "clipboardRead" src/renderer/ui/components/TerminalManager.js` — confirms IPC path used (not navigator.clipboard)
4. `npm run build:renderer` succeeds
5. `npm test` passes
</verification>

<success_criteria>
- Right-click in terminal pastes clipboard content
- Uses api.app.clipboardRead() (IPC path), not navigator.clipboard
- Paste is debounced using shared lastPasteTime/PASTE_DEBOUNCE_MS
- Works in all terminal types (regular, Claude, FiveM, WebApp)
- contextmenu default behavior (browser context menu) is prevented
- Renderer builds and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-terminal-keyboard-shortcuts/02-03-SUMMARY.md`
</output>
