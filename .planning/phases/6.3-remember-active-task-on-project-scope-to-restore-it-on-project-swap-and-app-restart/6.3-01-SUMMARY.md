---
phase: 6.3-remember-active-task-on-project-scope-to-restore-it-on-project-swap-and-app-restart
plan: 01
subsystem: ui
tags: [terminals, session-persistence, tab-restore, TerminalSessionService, TerminalManager]

# Dependency graph
requires:
  - phase: 6.1-bugfix-save-newsessionid-after-clear-for-restore-to-restore-the-correct-session-not-an-old-one
    provides: saveTerminalSessionsImmediate and terminal session data structure
  - phase: 04-remember-every-tab-every-claude-session-and-the-session-context-accross-app-restarts
    provides: TerminalSessionService, filterByProject project-swap/restart path
  - phase: 5.1-save-explorer-state-within-app-starts-and-remember-scroll-position
    provides: merge-before-write pattern in saveTerminalSessionsImmediate

provides:
  - activeTabIndex persisted per-project in terminal-sessions.json
  - filterByProject restores last-active tab on project-swap and app restart
  - graceful fallback to firstVisibleId when saved index is out of range

affects: [any phase touching TerminalSessionService or filterByProject]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - lazy require inside filterByProject body follows established circular-dep pattern (Phase 04, 05, 6.1)
    - activeTabIndex computed from Map iteration order — same order tabs are saved and restored

key-files:
  created: []
  modified:
    - src/renderer/services/TerminalSessionService.js
    - src/renderer/ui/components/TerminalManager.js

key-decisions:
  - "6.3-01: activeTabIndex computed as tabs.length - 1 at time of push, same loop as cwd — guaranteed to match tabs array index"
  - "6.3-01: Lazy require for loadSessionData in filterByProject avoids circular dep (same pattern as Phase 04/05/6.1)"
  - "6.3-01: Collect visibleIds from DOM display check inside filterByProject — mirrors firstVisibleId logic, consistent ordering"
  - "6.3-01: Bounds-check savedIdx < visibleIds.length — silent fallback to firstVisibleId on out-of-range, no crash"

patterns-established:
  - "activeTabIndex field in per-project session object: init to null, set to tabs.length - 1 when active terminal matches"

requirements-completed: [SESS-01, SESS-02]

# Metrics
duration: 2min
completed: 2026-02-26
---

# Phase 6.3 Plan 01: Remember Active Tab Per Project Summary

**activeTabIndex saved per project in terminal-sessions.json and restored by filterByProject on project-swap and app restart with fallback to first visible tab**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-26T16:35:36Z
- **Completed:** 2026-02-26T16:37:30Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- `activeTabIndex` (0-based integer or null) is now saved alongside `activeCwd` in per-project session data on every save
- `filterByProject` reads `activeTabIndex` from `loadSessionData()` and activates the matching visible tab on both project-swap and app restart
- Out-of-range or missing saved index gracefully falls back to `firstVisibleId` (no crash, no blank state)

## Task Commits

1. **Task 1: Persist activeTabIndex in TerminalSessionService** - `d1a764e0` (feat)
2. **Task 2: Restore active tab in filterByProject on project-swap and restart** - `5330aba5` (feat)

## Files Created/Modified

- `src/renderer/services/TerminalSessionService.js` - Added `activeTabIndex: null` initialization and assignment in `saveTerminalSessionsImmediate()`
- `src/renderer/ui/components/TerminalManager.js` - Replaced `firstVisibleId` fallback in `filterByProject` with `activeTabIndex`-aware restore using lazy require

## Decisions Made

- `activeTabIndex` computed at the moment of push (`tabs.length - 1`) inside the same loop that builds `tabs[]` — insertion order is guaranteed correct
- Lazy `require('../../services/TerminalSessionService')` inside `filterByProject` body follows the established circular-dep pattern from Phases 04, 05, 6.1
- Visible IDs collected by DOM `display !== 'none'` check — mirrors existing `firstVisibleId` logic, so iteration order is consistent between save and restore
- Bounds-check `savedIdx < visibleIds.length` ensures silent fallback when tabs have been closed since last save

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Active tab restore is fully functional for project-swap and app restart scenarios
- No blockers; merge-before-write already preserves `activeTabIndex` for projects without live terminals (existing `existingData.projects[pid]` preservation)

---
*Phase: 6.3-remember-active-task-on-project-scope-to-restore-it-on-project-swap-and-app-restart*
*Completed: 2026-02-26*
