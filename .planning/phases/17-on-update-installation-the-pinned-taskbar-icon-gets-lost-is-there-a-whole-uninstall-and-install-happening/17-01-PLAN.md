---
phase: 17-on-update-installation-the-pinned-taskbar-icon-gets-lost-is-there-a-whole-uninstall-and-install-happening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - main.js
  - electron-builder.config.js
  - build-assets/installer-custom.nsh
autonomous: true
requirements:
  - PIN-01

must_haves:
  truths:
    - "Taskbar pin survives app updates — the NSIS installer no longer deletes and recreates shortcuts during update runs"
    - "Running app AUMID matches the shortcut AUMID — no duplicate taskbar icons"
    - "Existing users upgrading from allowToChangeInstallationDirectory:true experience no install path issues"
  artifacts:
    - path: "main.js"
      provides: "Explicit AppUserModelId set on win32 before any window creation"
      contains: "app.setAppUserModelId"
    - path: "electron-builder.config.js"
      provides: "NSIS config with allowToChangeInstallationDirectory disabled"
      contains: "allowToChangeInstallationDirectory: false"
    - path: "build-assets/installer-custom.nsh"
      provides: "Guarded shortcut deletion that skips during updates"
      contains: "isUpdated"
  key_links:
    - from: "main.js"
      to: "electron-builder.config.js"
      via: "AUMID string must match appId"
      pattern: "com\\.yanis\\.claude-terminal"
    - from: "electron-builder.config.js"
      to: "build-assets/installer-custom.nsh"
      via: "include directive references custom NSH"
      pattern: "installer-custom\\.nsh"
---

<objective>
Fix the Windows taskbar pin being lost on every auto-update by addressing three independent root causes: (1) missing explicit AppUserModelId in main process, (2) `allowToChangeInstallationDirectory: true` forcing shortcut recreation, and (3) unconditional shortcut deletion in the custom NSIS uninstall macro.

Purpose: Users who pin Claude Terminal to the taskbar keep their pin across updates instead of losing it every time.
Output: Three files modified — main.js, electron-builder.config.js, build-assets/installer-custom.nsh
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-on-update-installation-the-pinned-taskbar-icon-gets-lost-is-there-a-whole-uninstall-and-install-happening/17-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add explicit AppUserModelId and disable forced shortcut recreation</name>
  <files>main.js, electron-builder.config.js</files>
  <action>
    **In main.js:**
    Add `app.setAppUserModelId('com.yanis.claude-terminal')` inside `bootstrapApp()`, BEFORE `app.whenReady()` (line ~180). Place it right after the function opens and the `require` block, before the `app.on('second-instance', ...)` handler. The string MUST exactly match the `appId` in `electron-builder.config.js` (`com.yanis.claude-terminal`). Guard with `process.platform === 'win32'` since this is Windows-only.

    Add a comment explaining why: "Set AUMID explicitly for NSIS builds — must match appId in electron-builder.config.js. Without this, Electron may generate a different runtime AUMID, causing the taskbar to show duplicate icons and breaking the pin."

    **In electron-builder.config.js:**
    Change `allowToChangeInstallationDirectory: true` to `allowToChangeInstallationDirectory: false` in the `nsis` section. Add a comment: "false prevents keepShortcuts=false — preserves taskbar pin across updates".

    Do NOT change any other NSIS options. Keep `oneClick: false`, `perMachine: false`, `createDesktopShortcut: true`, `createStartMenuShortcut: true` as they are.
  </action>
  <verify>
    <automated>grep -c "setAppUserModelId" main.js &amp;&amp; grep -c "allowToChangeInstallationDirectory: false" electron-builder.config.js</automated>
    <manual>Verify AUMID string matches appId string in both files</manual>
  </verify>
  <done>main.js calls app.setAppUserModelId with the correct appId on win32; electron-builder.config.js has allowToChangeInstallationDirectory set to false</done>
</task>

<task type="auto">
  <name>Task 2: Guard shortcut deletion in custom NSIS uninstall macro</name>
  <files>build-assets/installer-custom.nsh</files>
  <action>
    In `build-assets/installer-custom.nsh`, modify the `!macro customUnInstall` section. Wrap the `Delete "$DESKTOP\Claude Terminal.lnk"` line with an `${ifNot} ${isUpdated}` guard so the desktop shortcut is only deleted during actual uninstalls, NOT during update runs.

    The macro should become:
    ```nsis
    !macro customUnInstall
      ; Only clean up desktop shortcut on actual uninstall, NOT during update runs
      ; During updates, preserving the shortcut prevents taskbar pin loss
      ${ifNot} ${isUpdated}
        Delete "$DESKTOP\Claude Terminal.lnk"
      ${endIf}
    !macroend
    ```

    The `${isUpdated}` variable is set by electron-builder's NSIS template when the installer runs with `--updated` flag (which electron-updater passes during auto-updates).

    NOTE: If `${isUpdated}` is not available in `customUnInstall` context (this is a LOW confidence finding from research), the build will fail with an NSIS error. In that case, remove the guard and rely on changes from Task 1 alone (which are HIGH confidence fixes). Document this in the summary.
  </action>
  <verify>
    <automated>grep -c "isUpdated" build-assets/installer-custom.nsh</automated>
    <manual>Verify the Delete line is wrapped in the ifNot/endIf guard</manual>
  </verify>
  <done>customUnInstall macro guards shortcut deletion with isUpdated check; desktop shortcut only removed on actual uninstall, not updates</done>
</task>

</tasks>

<verification>
1. `grep "setAppUserModelId" main.js` — confirms AUMID call exists
2. `grep "com.yanis.claude-terminal" main.js` — confirms AUMID matches appId
3. `grep "allowToChangeInstallationDirectory: false" electron-builder.config.js` — confirms config change
4. `grep "isUpdated" build-assets/installer-custom.nsh` — confirms guard exists
5. `npm test` — existing tests still pass (no logic changes to tested code)
6. `npm run build:renderer` — renderer still builds (no renderer changes, but good hygiene)
</verification>

<success_criteria>
- main.js sets AppUserModelId to 'com.yanis.claude-terminal' on win32 before any window creation
- electron-builder.config.js has allowToChangeInstallationDirectory: false
- installer-custom.nsh guards desktop shortcut deletion with isUpdated check
- All existing tests pass
- No changes to any renderer code (this is a main-process + build-config only change)
</success_criteria>

<output>
After completion, create `.planning/phases/17-on-update-installation-the-pinned-taskbar-icon-gets-lost-is-there-a-whole-uninstall-and-install-happening/17-01-SUMMARY.md`
</output>
