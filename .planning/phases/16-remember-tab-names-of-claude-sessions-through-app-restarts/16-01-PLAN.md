---
phase: 16-remember-tab-names-of-claude-sessions-through-app-restarts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/services/TerminalSessionService.js
  - src/renderer/ui/components/TerminalManager.js
  - renderer.js
autonomous: true
requirements:
  - TAB-PERSIST-01
must_haves:
  truths:
    - "Tab names survive app restarts — restored tabs show their pre-shutdown name"
    - "All name sources are persisted: user renames, AI haiku names, slash-command names, default names"
    - "Name changes are saved immediately (crash-resilient) via debounced save"
    - "Restored tabs behave normally — new renames, AI naming, and slash-command naming still work"
    - "Chat-mode tabs restored in chat mode receive their saved name via createChatTerminal"
  artifacts:
    - path: "src/renderer/services/TerminalSessionService.js"
      provides: "Tab name serialization in saveTerminalSessionsImmediate"
      contains: "name: td.name"
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "Save triggers after all four name-mutation paths"
      contains: "saveTerminalSessions"
    - path: "renderer.js"
      provides: "Tab name and mode restoration in startup restore loop"
      contains: "name: tab.name"
  key_links:
    - from: "src/renderer/services/TerminalSessionService.js"
      to: "terminal-sessions.json"
      via: "saveTerminalSessionsImmediate writes name field to disk"
      pattern: "name: td\\.name"
    - from: "renderer.js"
      to: "src/renderer/ui/components/TerminalManager.js"
      via: "restore loop passes name to createTerminal which routes to createChatTerminal for chat mode"
      pattern: "name: tab\\.name"
    - from: "src/renderer/ui/components/TerminalManager.js"
      to: "src/renderer/services/TerminalSessionService.js"
      via: "lazy require saveTerminalSessions after name mutations"
      pattern: "TerminalSessionService\\.saveTerminalSessions\\(\\)"
---

<objective>
Persist tab names across app restarts so restored tabs display the exact name they had before shutdown.

Purpose: Currently terminal session persistence (Phase 4/6) saves tab CWD, mode, and session ID but not the tab name. After restart, all tabs fall back to the project name, losing user renames, AI-generated haiku names, and slash-command derived names.

Output: Tab names saved to terminal-sessions.json on every name change (debounced), restored on startup via existing createTerminal name parameter.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-remember-tab-names-of-claude-sessions-through-app-restarts/16-RESEARCH.md

@src/renderer/services/TerminalSessionService.js
@src/renderer/ui/components/TerminalManager.js
@renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add name to serialized tab object and trigger save on all name-mutation paths</name>
  <files>
    src/renderer/services/TerminalSessionService.js
    src/renderer/ui/components/TerminalManager.js
  </files>
  <action>
**TerminalSessionService.js (~line 89):** Add `name: td.name || null` to the tab object in `saveTerminalSessionsImmediate`, after the `claudeSessionId` line:

```js
const tab = {
  cwd: td.cwd || td.project.path,
  isBasic: td.isBasic || false,
  mode: td.mode || 'terminal',
  claudeSessionId: td.claudeSessionId || null,
  name: td.name || null,   // Phase 16: persist tab name
};
```

**TerminalManager.js — three save hooks using lazy require pattern (same as Phase 4/6):**

1. **`updateTerminalTabName` function (~line 1002):** After the DOM update block (after the closing `}` of the `if (tab)` block), add:
```js
// Phase 16: persist name change (debounced)
const TerminalSessionService = require('../services/TerminalSessionService');
TerminalSessionService.saveTerminalSessions();
```
This covers both OSC terminal renames AND slash-command renames (both flow through this function).

2. **`finishRename` inside `startRenameTab` (~line 1143):** After `updateTerminal(id, { name: newName })` and the DOM updates, before the function ends, add:
```js
// Phase 16: persist user rename (debounced)
const TerminalSessionService = require('../services/TerminalSessionService');
TerminalSessionService.saveTerminalSessions();
```

3. **`onTabRename` callback in `createChatTerminal` (~line 3441):** After `if (data) data.name = name;` and the remote notify block, add:
```js
// Phase 16: persist chat AI name (debounced)
const TerminalSessionService = require('../services/TerminalSessionService');
TerminalSessionService.saveTerminalSessions();
```

IMPORTANT: Use `saveTerminalSessions()` (debounced, 2000ms) NOT `saveTerminalSessionsImmediate()` — name changes are frequent and not crash-critical enough for immediate writes. The lazy `require()` pattern avoids circular dependency (same pattern used throughout TerminalManager.js since Phase 4).
  </action>
  <verify>
    <automated>npm run build:renderer &amp;&amp; npm test</automated>
    <manual>Grep for "name: td.name" in TerminalSessionService.js and count 3 occurrences of "saveTerminalSessions()" in TerminalManager.js that are Phase 16 related</manual>
  </verify>
  <done>
    - Tab object in saveTerminalSessionsImmediate includes name field
    - updateTerminalTabName triggers debounced save after name change
    - finishRename (user double-click rename) triggers debounced save
    - onTabRename (chat haiku naming) triggers debounced save
    - Build succeeds, tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Pass saved name and mode in restore loop</name>
  <files>renderer.js</files>
  <action>
In `renderer.js`, find the restore loop's `createTerminal` call (~line 181):

```js
await TerminalManager.createTerminal(project, {
  runClaude: !tab.isBasic,
  cwd,
  skipPermissions: settingsState.get().skipPermissions,
  resumeSessionId: (!tab.isBasic && tab.claudeSessionId) ? tab.claudeSessionId : null,
});
```

Add two new properties to the options object:

```js
await TerminalManager.createTerminal(project, {
  runClaude: !tab.isBasic,
  cwd,
  mode: tab.mode || null,
  skipPermissions: settingsState.get().skipPermissions,
  resumeSessionId: (!tab.isBasic && tab.claudeSessionId) ? tab.claudeSessionId : null,
  name: tab.name || null,
});
```

Both `createTerminal` and `createChatTerminal` already accept `name` (as `customName`) and `mode` (as `explicitMode`) in their options destructuring. No changes needed in those functions.

**Why `mode` is included:** Research confirmed that the current restore loop does NOT pass `mode`, despite STATE.md Phase 06-03 decision saying it should. Without `mode`, chat-mode tabs are restored as terminal-mode tabs, which means they never call `createChatTerminal` and thus never use the `customName` parameter for chat tabs. Including `mode` is a prerequisite for correct name restoration on chat-mode tabs.

**The `|| null` guard** ensures undefined/missing values in old session files (saved before this change) pass null, which createTerminal treats as "use default" — safe for existing users.
  </action>
  <verify>
    <automated>npm run build:renderer &amp;&amp; npm test</automated>
    <manual>Grep renderer.js restore loop for both "name: tab.name" and "mode: tab.mode"</manual>
  </verify>
  <done>
    - Restore loop passes name and mode from saved session data to createTerminal
    - Old session files without name/mode fields restore correctly (null fallback)
    - Chat-mode tabs restore in chat mode and receive their saved name
    - Build succeeds, tests pass
  </done>
</task>

</tasks>

<verification>
1. `npm run build:renderer` succeeds
2. `npm test` passes
3. Grep confirms `name: td.name` in TerminalSessionService.js saveTerminalSessionsImmediate
4. Grep confirms 3 new `saveTerminalSessions()` calls in TerminalManager.js (in updateTerminalTabName, finishRename, onTabRename)
5. Grep confirms `name: tab.name` and `mode: tab.mode` in renderer.js restore loop
</verification>

<success_criteria>
- Tab names are serialized to terminal-sessions.json alongside existing tab data
- All four name-mutation paths (OSC rename, slash-command rename, user rename, chat haiku rename) trigger a debounced save
- Restore loop passes saved name and mode to createTerminal
- Backward compatible: old session files without name field restore normally (null → default project name)
- No new dependencies, no CSS changes, no i18n changes
</success_criteria>

<output>
After completion, create `.planning/phases/16-remember-tab-names-of-claude-sessions-through-app-restarts/16-01-SUMMARY.md`
</output>
