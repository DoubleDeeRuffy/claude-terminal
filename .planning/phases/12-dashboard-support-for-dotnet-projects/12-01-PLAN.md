---
phase: 12-dashboard-support-for-dotnet-projects
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/project-types/dotnet/index.js
  - src/project-types/dotnet/renderer/DotNetDashboard.js
  - src/project-types/dotnet/i18n/en.json
  - src/project-types/dotnet/i18n/fr.json
  - src/project-types/registry.js
  - src/renderer/services/DashboardService.js
autonomous: true
requirements:
  - DOTNET-01
must_haves:
  truths:
    - "User adding a project with type 'dotnet' sees an SDK-specific badge (e.g. ASP.NET, Blazor WASM, Console) in the dashboard header"
    - "User sees target framework and SDK type in the dashboard stats area for a dotnet project (e.g. net8.0 - ASP.NET)"
    - "User sees C# overview-type-badge for .NET projects even when .sln/.csproj is one level deep"
    - "Multi-project solutions show project count alongside framework info"
    - "dotnet type appears in the project creation wizard under General category"
  artifacts:
    - path: "src/project-types/dotnet/index.js"
      provides: "Type descriptor registered with createType"
      contains: "createType"
    - path: "src/project-types/dotnet/renderer/DotNetDashboard.js"
      provides: "getDashboardBadge and getDashboardStats"
      exports: ["getDashboardBadge", "getDashboardStats", "getProjectIcon"]
    - path: "src/project-types/dotnet/i18n/en.json"
      provides: "English translations for dotnet type"
      contains: "dotnet"
    - path: "src/project-types/dotnet/i18n/fr.json"
      provides: "French translations for dotnet type"
      contains: "dotnet"
    - path: "src/project-types/registry.js"
      provides: "dotnet type registration in discoverAll"
      contains: "require('./dotnet')"
    - path: "src/renderer/services/DashboardService.js"
      provides: "One-level-deep detection for csharp marker"
      contains: "fileMatchExistsDeep"
  key_links:
    - from: "src/project-types/dotnet/index.js"
      to: "src/project-types/dotnet/renderer/DotNetDashboard.js"
      via: "lazy require in getDashboardBadge/getDashboardStats"
      pattern: "require.*DotNetDashboard"
    - from: "src/project-types/registry.js"
      to: "src/project-types/dotnet/index.js"
      via: "require in discoverAll"
      pattern: "require.*dotnet"
    - from: "src/renderer/services/DashboardService.js"
      to: "detectProjectType"
      via: "one-level-deep fallback for csharp marker"
      pattern: "csharp.*deep|fileMatchExists.*sub"
---

<objective>
Add a .NET/C# project type plugin with SDK-specific dashboard badge and stats, plus one-level-deep detection in DashboardService.

Purpose: Users with .NET projects see relevant framework info (target framework, SDK type, project count) in the dashboard — matching the experience of other project types like webapp and api.

Output: Complete dotnet plugin under `src/project-types/dotnet/` with registration, i18n, and extended DashboardService detection.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-dashboard-support-for-dotnet-projects/12-CONTEXT.md
@.planning/phases/12-dashboard-support-for-dotnet-projects/12-RESEARCH.md
@src/project-types/base-type.js
@src/project-types/registry.js
@src/project-types/webapp/index.js
@src/project-types/general/index.js
@src/renderer/services/DashboardService.js (lines 98-197)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dotnet project type plugin and register it</name>
  <files>
    src/project-types/dotnet/index.js
    src/project-types/dotnet/renderer/DotNetDashboard.js
    src/project-types/dotnet/i18n/en.json
    src/project-types/dotnet/i18n/fr.json
    src/project-types/registry.js
  </files>
  <action>
Create the dotnet project type plugin following the exact same structure as webapp and general types.

**1. `src/project-types/dotnet/index.js`** — Type descriptor using `createType()`:
- `id: 'dotnet'`, `nameKey: 'newProject.types.dotnet'`, `descKey: 'newProject.types.dotnetDesc'`, `category: 'general'`
- `icon`: Use a .NET-themed SVG (the official .NET logo simplified — a dot within angle brackets or similar). Keep it simple, 24x24 viewBox with `fill="currentColor"`.
- `mainModule: () => null` — no main process code
- `initialize: () => {}`, `cleanup: () => {}`
- `getProjectIcon: () => require('./renderer/DotNetDashboard').getProjectIcon()`
- `getDashboardIcon: () => require('./renderer/DotNetDashboard').getProjectIcon()`
- `getDashboardBadge: (project) => require('./renderer/DotNetDashboard').getDashboardBadge(project)`
- `getDashboardStats: (ctx) => require('./renderer/DotNetDashboard').getDashboardStats(ctx)`
- `getTranslations`: return `{ en: require('./i18n/en.json'), fr: require('./i18n/fr.json') }` wrapped in try/catch like webapp
- `getStyles`: return CSS string with these classes:
  - `.dashboard-project-type.dotnet { background: rgba(81,43,212,0.15); color: #7c6af7; }`
  - `.project-type-icon.dotnet svg { color: #7c6af7; }`
  - `.project-item.dotnet-project .project-name svg { color: #7c6af7; width: 14px; height: 14px; margin-right: 6px; flex-shrink: 0; }`
  - `.dotnet-stat { display: flex; align-items: center; gap: 6px; font-size: var(--font-xs); }`
- `getPreloadBridge: () => null` — no IPC channels needed

**2. `src/project-types/dotnet/renderer/DotNetDashboard.js`** — Detection and display logic:

IMPORTANT: Access `window.electron_nodeModules.fs` and `window.electron_nodeModules.path` INSIDE function bodies (lazy access), NOT at module top-level. This avoids the preload timing pitfall.

Implement these functions:

`parseCsproj(filePath, nodeFs)`:
- Read file content with `nodeFs.readFileSync(filePath, 'utf-8')` in try/catch
- Extract `Sdk` attribute from `<Project Sdk="...">` using regex: `/<Project[^>]*\bSdk="([^"]+)"/i`
- Extract `<TargetFramework>` or `<TargetFrameworks>` (handle plural) using: `/<TargetFramework(?:s)?>([^<]+)<\/TargetFramework(?:s)?>/i`
- Extract `<OutputType>` using: `/<OutputType>([^<]+)<\/OutputType>/i`
- For multi-target frameworks (contains `;`), pick highest version using `pickHighestFramework()`
- Also handle old-style .NET Framework: check for `<TargetFrameworkVersion>v(\d+\.\d+)</TargetFrameworkVersion>` and convert to `net{version}` format
- Return `{ sdk, targetFramework, outputType }` or `null` on error

`pickHighestFramework(frameworks)`:
- Split by `;`, trim, filter empty
- Sort by extracted numeric version descending (strip `net` prefix, parse float)
- Return first element

`countProjectsInSln(slnPath, nodeFs)`:
- Read `.sln` file, match `Project("...") = "...", "....csproj"` lines
- Count matches, return count (minimum 1)

`findFirstCsprojFromSln(slnPath, nodePath, nodeFs)`:
- Parse `.sln` to extract `.csproj` relative paths from `Project()` lines
- Iterate through them, parse each with `parseCsproj`
- Return the first one with `Microsoft.NET.Sdk.Web` or `Microsoft.NET.Sdk.BlazorWebAssembly` or `Microsoft.NET.Sdk.Worker` SDK
- If none found with web/worker SDK, return the first `.csproj` path that exists
- Resolve paths relative to the `.sln` file's directory

`detectDotNetInfo(projectPath)`:
- Use lazy access: `const nodeFs = window.electron_nodeModules.fs; const nodePath = window.electron_nodeModules.path;`
- Check root directory for `.sln` and `.csproj` files using `safeReaddir` + `.endsWith()`
- If not found at root, check one level deep (iterate subdirs)
- `.sln` takes priority over standalone `.csproj` (per user decision)
- When `.sln` found: use `findFirstCsprojFromSln` for SDK detection, `countProjectsInSln` for count
- When only `.csproj` found: parse it directly, count = 1
- Return `{ sdk, targetFramework, outputType, projectCount, hasSlnFile }` or `null`

`sdkToBadgeText(sdk, outputType)`:
- Map SDK strings to friendly names per user decision:
  - `Microsoft.NET.Sdk.Web` → `'ASP.NET'`
  - `Microsoft.NET.Sdk.BlazorWebAssembly` → `'Blazor WASM'`
  - `Microsoft.NET.Sdk.Blazor` → `'Blazor Server'`
  - `Microsoft.NET.Sdk.Worker` → `'Worker Service'`
  - `Microsoft.NET.Sdk.Razor` → `'Razor'`
  - `Microsoft.NET.Sdk` → `'Library'` if outputType is `'library'`, else `'Console'`
  - Unknown/null → `'.NET'`

`getProjectIcon()`:
- Return the same .NET SVG icon string used in index.js

`getDashboardBadge(project)`:
- Guard: `if (!project || !project.path) return null;`
- Call `detectDotNetInfo(project.path)`
- If null, return `{ text: '.NET', cssClass: 'dotnet' }`
- Return `{ text: sdkToBadgeText(info.sdk, info.outputType), cssClass: 'dotnet' }`

`getDashboardStats(ctx)`:
- Guard: `if (!ctx.project || !ctx.project.path) return '';`
- Call `detectDotNetInfo(ctx.project.path)`
- If null, return `''`
- Build HTML: framework + SDK label + optional project count
- Format: `<div class="dashboard-quick-stat dotnet-stat"><span>{targetFramework} - {sdkLabel}{countText}</span></div>`
- If `projectCount > 1`, append ` · {count} projects` (use i18n `ctx.t('dotnet.projects', { count })` if available, else hardcode)
- Export: `module.exports = { getDashboardBadge, getDashboardStats, getProjectIcon }`

**3. `src/project-types/dotnet/i18n/en.json`**:
```json
{
  "dotnet": {
    "framework": "Framework",
    "projects": "{count} projects",
    "project": "1 project",
    "badgeLabel": ".NET"
  },
  "newProject": {
    "types": {
      "dotnet": ".NET / C#",
      "dotnetDesc": "C# project with .sln or .csproj"
    }
  }
}
```

**4. `src/project-types/dotnet/i18n/fr.json`**:
```json
{
  "dotnet": {
    "framework": "Framework",
    "projects": "{count} projets",
    "project": "1 projet",
    "badgeLabel": ".NET"
  },
  "newProject": {
    "types": {
      "dotnet": ".NET / C#",
      "dotnetDesc": "Projet C# avec .sln ou .csproj"
    }
  }
}
```

**5. `src/project-types/registry.js`** — Add dotnet registration in `discoverAll()`:
- Add a new try/catch block after the minecraft registration:
```javascript
try {
  register(require('./dotnet'));
} catch (e) {
  console.warn('[Registry] Failed to load dotnet type:', e.message);
}
```
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && node -e "const d = require('./src/project-types/dotnet'); console.log('id:', d.id); console.log('badge:', typeof d.getDashboardBadge); console.log('stats:', typeof d.getDashboardStats); console.log('styles:', d.getStyles().includes('.dotnet')); const t = d.getTranslations(); console.log('en:', !!t.en.dotnet); console.log('fr:', !!t.fr.dotnet);"</automated>
    <manual>Verify dotnet type loads, has getDashboardBadge/getDashboardStats functions, CSS includes .dotnet class, and both i18n files load</manual>
  </verify>
  <done>dotnet project type fully registered: index.js descriptor with CSS, DotNetDashboard.js with detection/badge/stats, en.json + fr.json translations, and registry.js updated to load dotnet type</done>
</task>

<task type="auto">
  <name>Task 2: Extend DashboardService with one-level-deep detection for csharp marker</name>
  <files>
    src/renderer/services/DashboardService.js
  </files>
  <action>
Extend the `detectProjectType` function in `DashboardService.js` to support one-level-deep detection for the `csharp` marker type.

The existing `fileMatchExists` only checks the root directory. When the normal marker loop fails to find `.sln`/`.csproj` at root, we need a fallback that checks one level deep — but ONLY for the `csharp` marker (per research recommendation to keep it specific, not generic).

**Approach:** After the main `for` loop in `detectProjectType` (line ~191, before `return null`), add a csharp-specific one-level-deep check:

```javascript
// One-level-deep detection for C# (.sln/.csproj)
// Other markers only check root; .NET solutions are commonly nested (e.g., src/MyApp.sln)
try {
  const csharpMarker = PROJECT_TYPE_MARKERS.find(m => m.type === 'csharp');
  if (csharpMarker) {
    const rootEntries = fs.readdirSync(projectPath);
    for (const entry of rootEntries) {
      // Skip dotfiles and common non-project directories for performance
      if (entry.startsWith('.') || entry === 'node_modules' || entry === 'bin' || entry === 'obj') continue;
      const subPath = path.join(projectPath, entry);
      try {
        if (!fs.statSync(subPath).isDirectory()) continue;
      } catch (e) { continue; }
      const hasFile = csharpMarker.files.some(f => fileMatchExists(subPath, f));
      if (hasFile) {
        return { type: csharpMarker.type, label: csharpMarker.label, color: csharpMarker.color };
      }
    }
  }
} catch (e) {
  // Silently ignore — detection is best-effort
}
```

This goes right before the `return null;` at the end of `detectProjectType`. The `fileMatchExists` function already handles `*.sln` and `*.csproj` patterns via the glob extension check.

**DO NOT:**
- Change the existing `fileMatchExists` function
- Modify the `PROJECT_TYPE_MARKERS` array
- Add a generic one-level-deep capability (keep it csharp-specific)
- Add any async file operations (the detection function is async but we use sync reads here, which is the existing pattern in `fileMatchExists`)
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && node -e "const fs = require('fs'); const content = fs.readFileSync('src/renderer/services/DashboardService.js', 'utf-8'); console.log('has one-level-deep:', content.includes('One-level-deep detection')); console.log('has csharp check:', content.includes('csharp')); console.log('still has return null:', content.includes('return null'));"</automated>
    <manual>Verify detectProjectType has a one-level-deep csharp fallback before the final return null</manual>
  </verify>
  <done>DashboardService.js detectProjectType function has a csharp-specific one-level-deep fallback that checks subdirectories for .sln/.csproj when root check fails</done>
</task>

</tasks>

<verification>
1. `node -e "require('./src/project-types/dotnet')"` succeeds without errors
2. `node -e "const r = require('./src/project-types/registry'); r.discoverAll(); console.log(r.get('dotnet').id);"` prints `dotnet`
3. DashboardService.js contains one-level-deep csharp detection code
4. Both i18n files exist and contain dotnet keys
5. `npm run build:renderer` succeeds (renderer bundle includes new plugin)
6. `npm test` passes (no regressions)
</verification>

<success_criteria>
- dotnet project type is fully functional: type descriptor, dashboard badge with SDK-specific text, dashboard stats with framework info, i18n in both EN and FR
- Registry discovers and loads dotnet type alongside existing 6 types
- DashboardService detects .NET projects with .sln/.csproj one level deep (not just root)
- No regressions in existing project types or tests
</success_criteria>

<output>
After completion, create `.planning/phases/12-dashboard-support-for-dotnet-projects/12-01-SUMMARY.md`
</output>
