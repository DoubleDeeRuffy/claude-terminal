# Phase 6.4: bugfix-session-resume-claudeSessionId-not-persisted-across-restarts - Research

**Researched:** 2026-02-26
**Domain:** Electron renderer-side state persistence, terminal session restore
**Confidence:** HIGH — all findings are from direct codebase inspection, no external libraries involved

---

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

#### Root Cause A — claudeSessionId not stored on termData at resume time
- Store `claudeSessionId` on the termData object inside `createTerminal` (TerminalManager.js) when `resumeSessionId` is provided
- Single source of truth: the termData gets the session ID at creation time, not after the restore loop

#### Root Cause B — claudeSessionId depends on async event capture before app close
- Add a synchronous save in Electron's `before-quit` handler to flush `terminal-sessions.json` before the process exits
- This ensures the latest terminal state (including any claudeSessionId captured by the events system) is persisted even on fast app close

#### Root Cause C — activeCwd matching broken (pre-existing)
- Store `cwd` on termData at creation time in `createTerminal`: `cwd: overrideCwd || project.path`
- This fixes the `td.cwd === saved.activeCwd` matching logic in renderer.js that currently always evaluates to `false`

### Claude's Discretion
- Exact placement of the before-quit handler in main.js lifecycle
- Whether the before-quit save triggers via IPC to renderer or reads state directly
- Error handling approach for edge cases (e.g., save fails during quit)

### Deferred Ideas (OUT OF SCOPE)
None — discussion stayed within phase scope
</user_constraints>

---

## Summary

This is a pure bugfix phase with a fully diagnosed root cause — no external libraries, no new patterns to research. The debug investigation in `.planning/debug/session-not-resumed-on-restart.md` has identified three independent bugs in the terminal session persistence pipeline. All three bugs are in existing code and require small, surgical changes.

The end-to-end resume mechanism (saving `claudeSessionId` → loading it on restart → passing as `--resume <sessionId>` to Claude CLI) is correctly wired when the session ID is actually present in the saved data. The bugs are all about ensuring the session ID _reaches_ the save file reliably.

The `before-quit` save path already exists in `renderer.js` (lines 3775-3789) via `api.lifecycle.onWillQuit`. The IPC plumbing (`app-will-quit` channel sent from `main.js` `before-quit` handler, exposed via `preload.js` `createListener`) is fully functional. The only problem is that `saveTerminalSessionsImmediate()` is already called there, but at that moment `td.claudeSessionId` may still be `undefined` (Root Cause A) — so the fix for Root Cause A directly improves the quit-save outcome too.

**Primary recommendation:** Three targeted code changes across two files (`TerminalManager.js` and the restore loop in `renderer.js`), plus no new infrastructure.

---

## Standard Stack

No new libraries needed. This phase uses only existing project infrastructure:

| Component | Version | Purpose | Role in Fix |
|-----------|---------|---------|-------------|
| `terminals.state.js` | (project) | `updateTerminal(id, updates)` mutates termData in place | Used to write `claudeSessionId` and `cwd` onto termData |
| `TerminalSessionService.js` | (project) | `saveTerminalSessionsImmediate()` | Already called on quit — just needs the data to be correct |
| `renderer.js` | (project) | Session restore loop + `api.lifecycle.onWillQuit` | Fix: call `updateTerminal` after `createTerminal` returns |
| `TerminalManager.js` | (project) | `createTerminal()` — termData creation | Fix: add `claudeSessionId` and `cwd` to initial termData object |

**Installation:** No new packages required.

---

## Architecture Patterns

### Existing Save/Restore Pipeline (Verified)

```
SAVE SIDE:
  Events system (events/index.js:379)
    → updateTerminal(terminalId, { claudeSessionId })    ← async, after Claude prints session ID
    → saveTerminalSessionsImmediate()                    ← writes terminal-sessions.json immediately

  Debounced save (TerminalSessionService.saveTerminalSessions)
    → 2s debounce, triggered on tab changes, etc.

  On quit (renderer.js:3775-3789)
    → api.lifecycle.onWillQuit callback
    → saveTerminalSessionsImmediate()                    ← synchronous flush

RESTORE SIDE (renderer.js:179-233):
  loadSessionData()
    → for each saved tab → createTerminal({ resumeSessionId: tab.claudeSessionId })
    → activeCwd matching to set active terminal
    → scheduleScrollAfterRestore
```

### Root Cause A: Fix Location

**File:** `src/renderer/ui/components/TerminalManager.js`
**Location:** `createTerminal()` function, the `termData` object literal (lines ~1391-1403)
**Current state:**
```javascript
const termData = {
  terminal,
  fitAddon,
  project,
  projectIndex,
  name: tabName,
  status: initialStatus,
  inputBuffer: '',
  isBasic: isBasicTerminal,
  mode: 'terminal',
  ...(initialPrompt ? { pendingPrompt: initialPrompt } : {}),
  ...(overrideCwd ? { parentProjectId: project.id } : {})
};
```
**Fix:** Add `claudeSessionId` and `cwd` to the spread:
```javascript
const termData = {
  terminal,
  fitAddon,
  project,
  projectIndex,
  name: tabName,
  status: initialStatus,
  inputBuffer: '',
  isBasic: isBasicTerminal,
  mode: 'terminal',
  cwd: overrideCwd || project.path,                        // Root Cause C fix
  ...(resumeSessionId ? { claudeSessionId: resumeSessionId } : {}),  // Root Cause A fix
  ...(initialPrompt ? { pendingPrompt: initialPrompt } : {}),
  ...(overrideCwd ? { parentProjectId: project.id } : {})
};
```

### Root Cause B: Fix Location (Discretion Area)

The `before-quit` save already calls `saveTerminalSessionsImmediate()`. With Root Cause A fixed, the termData will already have `claudeSessionId` populated on restored terminals — so the quit-save will capture it.

However, for _new_ terminals (not yet resumed), the session ID only arrives via the async events system. The locked decision says: "add a synchronous save in Electron's `before-quit` handler." The existing mechanism in `renderer.js` at line 3775 already does this:

```javascript
api.lifecycle.onWillQuit(() => {
  const { saveAndShutdown } = require('./src/renderer');
  saveAndShutdown();
  const { saveTerminalSessionsImmediate } = require('./src/renderer/services/TerminalSessionService');
  saveTerminalSessionsImmediate();
});
```

This is already synchronous from the renderer's perspective. The decision says the fix is about ensuring `terminal-sessions.json` is flushed before process exits. Since this handler already exists, Root Cause B may already be handled once Root Cause A is fixed. The planner should decide whether an additional IPC-based save call from the `main.js` `before-quit` handler is also needed.

**IPC architecture for before-quit (if planner chooses to add main-side flush):**
- `main.js` line 190: `app.on('before-quit', ...)` sends `app-will-quit` IPC to renderer
- Renderer's `api.lifecycle.onWillQuit` receives it and calls `saveTerminalSessionsImmediate()`
- This is already the pattern — it already works

**The gap:** `app.on('before-quit')` in `main.js` sends the IPC event and immediately calls `cleanupServices()`. It does NOT await the renderer's synchronous save. On Windows, `before-quit` → `will-quit` → process exit can happen very fast. The renderer's `onWillQuit` callback may fire after the process has already started tearing down.

**Safer approach for Root Cause B:** Since `saveTerminalSessionsImmediate()` uses synchronous `fs.writeFileSync` + `fs.renameSync` (no async I/O), the `beforeunload` handler at line 3784 (the backup) should catch any missed quit-saves. Both handlers already exist. The primary fix is Root Cause A.

### Root Cause C: Fix Location

**Same file and same location as Root Cause A** — add `cwd: overrideCwd || project.path` to the `termData` object in `createTerminal()`. This enables the `td.cwd === saved.activeCwd` matching in `renderer.js` lines 206-217 to work.

Note: The `cwd` value is already passed to the PTY via `api.terminal.create({ cwd: overrideCwd || project.path, ... })` at line 1354. It just wasn't stored on the renderer-side `termData`. This is a single-line addition.

---

## Anti-Patterns to Avoid

- **Do NOT add `claudeSessionId` via a separate `updateTerminal()` call after `addTerminal()` in `createTerminal()`** — `addTerminal` immediately broadcasts state, so subscribers may fire with incomplete data before the follow-up call. Adding it directly to the `termData` literal is the right approach.
- **Do NOT modify `saveTerminalSessions` (debounced)** — the debounced save is fine; the bug is in what data is available when save runs.
- **Do NOT modify `TerminalSessionService.saveTerminalSessionsImmediate`** — the save logic reads `td.claudeSessionId` correctly; the bug is upstream (the value is never set on `td`).

---

## File Map

| File | Change Type | What Changes |
|------|-------------|--------------|
| `src/renderer/ui/components/TerminalManager.js` | Modify | Add `cwd` and `claudeSessionId` fields to `termData` object in `createTerminal()` |
| `renderer.js` | No change needed | Restore loop already passes `resumeSessionId` correctly; onWillQuit already saves |

The fix is **one location, two new fields** in the `termData` object literal. That's it for Root Causes A and C. Root Cause B is already handled by the existing `onWillQuit` infrastructure once A is fixed.

---

## Common Pitfalls

### Pitfall 1: `overrideCwd` vs `project.path` for cwd
**What goes wrong:** Using just `project.path` when `overrideCwd` is set, breaking worktree terminals.
**Why it happens:** The `cwd: overrideCwd || project.path` pattern is already used in the `api.terminal.create` call — must mirror exactly.
**How to avoid:** Copy the same expression: `cwd: overrideCwd || project.path`.

### Pitfall 2: Double-setting claudeSessionId
**What goes wrong:** If the events system later fires `SESSION_START` and calls `updateTerminal(id, { claudeSessionId: newId })`, it would overwrite the restored `claudeSessionId` with the new session's ID — which is correct behavior.
**Why it happens:** When Claude resumes a session, it still emits a `SESSION_START` event, possibly with the same ID or a new one.
**How to avoid:** This is fine — the events system always wins on the latest session ID. No guard needed.

### Pitfall 3: Watchdog fires on slow resume
**What goes wrong:** The 20-second watchdog in `createTerminal` (lines 1514-1539) closes the terminal and creates a fresh one if `td.terminal.buffer.active.length <= 1` after 20 seconds.
**Why it happens:** Stale session IDs (sessions whose `.jsonl` files are gone) cause Claude to hang. The watchdog is intentional.
**How to avoid:** This is not a bug to fix in this phase — it's existing intended behavior. The fix for A+C only ensures the session ID is present so resume can be attempted.

### Pitfall 4: `before-quit` timing race
**What goes wrong:** If the main process exits before the renderer's `onWillQuit` handler completes, the save may be lost.
**Why it happens:** `app.on('before-quit')` in `main.js` sends the IPC message but doesn't wait for it.
**How to avoid:** The `beforeunload` fallback handler at line 3784 provides a second save attempt. With Root Cause A fixed, both handlers will have correct data. No additional infrastructure needed unless testing reveals the race is real.

---

## Code Examples

### The Complete Fix (TerminalManager.js)

```javascript
// In createTerminal(), replace the termData literal:
const termData = {
  terminal,
  fitAddon,
  project,
  projectIndex,
  name: tabName,
  status: initialStatus,
  inputBuffer: '',
  isBasic: isBasicTerminal,
  mode: 'terminal',
  cwd: overrideCwd || project.path,                                    // FIX: Root Cause C
  ...(resumeSessionId ? { claudeSessionId: resumeSessionId } : {}),   // FIX: Root Cause A
  ...(initialPrompt ? { pendingPrompt: initialPrompt } : {}),
  ...(overrideCwd ? { parentProjectId: project.id } : {})
};
```

### Verification Query (after fix)

To verify Root Cause C is fixed, check that `td.cwd` is populated:
```javascript
// In renderer.js restore loop, after the createTerminal loop:
terminalsState.get().terminals.forEach((td, id) => {
  console.log(`Terminal ${id}: cwd=${td.cwd}, claudeSessionId=${td.claudeSessionId}`);
});
```

---

## Open Questions

1. **Root Cause B — Is additional before-quit handling needed?**
   - What we know: `onWillQuit` in `renderer.js` already calls `saveTerminalSessionsImmediate()`. The save is synchronous (`writeFileSync` + `renameSync`).
   - What's unclear: Whether the `before-quit` IPC message reaches the renderer before the process begins tearing down on fast app closes.
   - Recommendation: Fix Root Cause A first. If the event system captures the session ID (which it does within seconds of Claude starting), Root Cause B is only about timing of app close. The `beforeunload` fallback provides a second attempt. Planner may decide to add a main-process-side IPC flush call, but it's likely not needed given the existing dual-save mechanism.

2. **Chat mode terminals (`createChatTerminal`)**
   - What we know: `createTerminal` routes to `createChatTerminal` when `mode === 'chat'`. This codepath is separate.
   - What's unclear: Whether `createChatTerminal` has the same `cwd`/`claudeSessionId` gap.
   - Recommendation: Scope this phase to terminal mode only, matching the locked decisions. Chat mode resume is a separate concern.

---

## Sources

### Primary (HIGH confidence)
- Direct inspection of `src/renderer/ui/components/TerminalManager.js` lines 1341-1539
- Direct inspection of `renderer.js` lines 179-237, 3773-3790
- Direct inspection of `src/renderer/services/TerminalSessionService.js` (full file)
- Direct inspection of `src/renderer/events/index.js` lines 370-385
- Direct inspection of `src/renderer/state/terminals.state.js` lines 47-64
- Direct inspection of `main.js` lines 183-210
- Direct inspection of `src/main/preload.js` lines 69-75, 379-382
- `.planning/debug/session-not-resumed-on-restart.md` — full root cause investigation

### Secondary (MEDIUM confidence)
- None required — all findings from direct codebase inspection

---

## Metadata

**Confidence breakdown:**
- Fix locations: HIGH — exact line numbers and object literal identified from code
- Root Cause A fix: HIGH — direct code inspection confirms `resumeSessionId` param available in scope, `termData` literal identified
- Root Cause B analysis: MEDIUM — timing behavior of Electron's `before-quit` vs renderer IPC on Windows is not explicitly tested; existing dual-save mechanism likely covers it
- Root Cause C fix: HIGH — `td.cwd` is provably `undefined` (never assigned), `activeCwd` matching provably never fires

**Research date:** 2026-02-26
**Valid until:** Stable — no external dependencies, all findings from source code inspection
