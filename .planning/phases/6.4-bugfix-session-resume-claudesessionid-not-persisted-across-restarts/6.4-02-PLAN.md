---
phase: 6.4-bugfix-session-resume-claudesessionid-not-persisted-across-restarts
plan: 02
type: execute
wave: 1
depends_on: ["6.4-01"]
files_modified:
  - src/renderer/ui/components/ChatView.js
  - src/renderer/ui/components/TerminalManager.js
autonomous: true
requirements: [SESS-01, SESS-02]
gap_closure: true
must_haves:
  truths:
    - "After /clear in a chat-mode tab, the new SDK session ID is persisted to termData.claudeSessionId"
    - "On next app restart after /clear, the NEW session is resumed (not the old pre-clear one)"
    - "Fresh chat sessions (no resume) also store their first session ID on termData"
  artifacts:
    - path: "src/renderer/ui/components/ChatView.js"
      provides: "Propagation of SDK session ID changes to terminal state"
      contains: "updateTerminal.*claudeSessionId"
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "claudeSessionId set on termData at chat terminal creation and in onSessionStart"
      contains: "claudeSessionId"
  key_links:
    - from: "src/renderer/ui/components/ChatView.js"
      to: "src/renderer/state/terminals.state.js"
      via: "lazy require updateTerminal when sdkSessionId changes"
      pattern: "updateTerminal.*claudeSessionId.*msg\\.session_id"
    - from: "src/renderer/ui/components/TerminalManager.js"
      to: "src/renderer/services/TerminalSessionService.js"
      via: "onSessionStart callback updates termData and triggers save"
      pattern: "claudeSessionId.*sid"
---

<objective>
Fix chat-mode tabs not persisting new session IDs after /clear.

Purpose: After /clear creates a new SDK session, the new session_id must propagate from ChatView's local variable back to termData.claudeSessionId so TerminalSessionService persists it to disk. Without this, app restart resumes the old pre-clear session.

Output: Two targeted code changes ensuring session ID flows from SDK messages to persistence layer.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/6.4-bugfix-session-resume-claudesessionid-not-persisted-across-restarts/6.4-01-SUMMARY.md
@.planning/debug/session-resume-after-clear.md

<interfaces>
From src/renderer/state/terminals.state.js:
```javascript
function updateTerminal(id, updates) {
  const terminal = getTerminal(id);
  if (terminal) {
    Object.assign(terminal, updates);
    terminalsState.set({ terminals: terminalsState.get().terminals });
  }
}
// Exported from module.exports { updateTerminal }
```

From src/renderer/services/TerminalSessionService.js:
```javascript
function saveTerminalSessionsImmediate() { /* ... */ }
function saveTerminalSessions() { /* debounced version */ }
// Exported from module.exports { saveTerminalSessionsImmediate, saveTerminalSessions }
```

From ChatView.js line 3047 (current code to modify):
```javascript
if (msg.session_id) sdkSessionId = msg.session_id;
```

From TerminalManager.js createChatTerminal termData (lines 3842-3854):
```javascript
const termData = {
  terminal: null, fitAddon: null, project, projectIndex,
  name: tabName, status: 'ready', inputBuffer: '',
  isBasic: false, mode: 'chat', chatView: null,
  ...(parentProjectId ? { parentProjectId } : {})
};
// NOTE: NO claudeSessionId field here
```

From TerminalManager.js createChatTerminal onSessionStart (line 3895-3898):
```javascript
onSessionStart: (sid) => {
  _chatSessionId = sid;
  if (onSessionStart) onSessionStart(sid);
},
// NOTE: Does NOT update termData.claudeSessionId
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Propagate SDK session ID changes from ChatView to terminal state</name>
  <files>src/renderer/ui/components/ChatView.js</files>
  <action>
In ChatView.js at line 3047, replace:
```javascript
if (msg.session_id) sdkSessionId = msg.session_id;
```
With:
```javascript
if (msg.session_id && msg.session_id !== sdkSessionId) {
  sdkSessionId = msg.session_id;
  // Propagate new session ID to termData for persistence (fixes /clear not saving new ID)
  if (terminalId) {
    const { updateTerminal } = require('../../state/terminals.state');
    updateTerminal(terminalId, { claudeSessionId: msg.session_id });
    const TerminalSessionService = require('../../services/TerminalSessionService');
    TerminalSessionService.saveTerminalSessionsImmediate();
  }
}
```

Key details:
- Use `msg.session_id !== sdkSessionId` guard to avoid redundant updates on every message (SDK sends session_id on every message, but it only changes after /clear).
- Use lazy require for `updateTerminal` from `../../state/terminals.state` (not `../../state` which doesn't re-export it). ChatView already uses lazy requires for state modules at lines 1238-1239, so this follows the established pattern.
- Use lazy require for `TerminalSessionService` from `../../services/TerminalSessionService` — same pattern as Phase 6.1 established for crash-resilient immediate save.
- `terminalId` is already available in ChatView's closure (destructured from options at line 121).
- Use `saveTerminalSessionsImmediate()` (not debounced) per Phase 6.1 decision for crash-resilient session ID persistence.
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && grep -n "msg.session_id !== sdkSessionId" src/renderer/ui/components/ChatView.js && grep -n "updateTerminal.*claudeSessionId.*msg.session_id" src/renderer/ui/components/ChatView.js && grep -n "saveTerminalSessionsImmediate" src/renderer/ui/components/ChatView.js</automated>
  </verify>
  <done>ChatView.js line ~3047 updates termData.claudeSessionId whenever SDK session_id changes, and immediately saves to disk</done>
</task>

<task type="auto">
  <name>Task 2: Set claudeSessionId on chat-mode termData at creation and in onSessionStart</name>
  <files>src/renderer/ui/components/TerminalManager.js</files>
  <action>
Two changes in createChatTerminal() in TerminalManager.js:

**Change A — Add claudeSessionId to termData literal (line ~3853):**
Add the resumeSessionId spread to the termData object, same pattern as createTerminal (from plan 6.4-01):
```javascript
const termData = {
  terminal: null,
  fitAddon: null,
  project,
  projectIndex,
  name: tabName,
  status: 'ready',
  inputBuffer: '',
  isBasic: false,
  mode: 'chat',
  chatView: null,
  ...(parentProjectId ? { parentProjectId } : {}),
  ...(resumeSessionId ? { claudeSessionId: resumeSessionId } : {})
};
```
This ensures resumed chat-mode tabs start with their session ID on termData.

**Change B — Update termData.claudeSessionId in onSessionStart callback (line ~3895-3898):**
Replace:
```javascript
onSessionStart: (sid) => {
  _chatSessionId = sid;
  if (onSessionStart) onSessionStart(sid);
},
```
With:
```javascript
onSessionStart: (sid) => {
  _chatSessionId = sid;
  // Persist session ID on termData for TerminalSessionService (fresh sessions)
  const data = getTerminal(id);
  if (data) data.claudeSessionId = sid;
  if (onSessionStart) onSessionStart(sid);
},
```
This covers fresh chat sessions (no resume) getting their first session ID stored. Uses direct property set on termData (same as data.name pattern at line 3903) instead of updateTerminal() to avoid unnecessary state notification during session startup. `getTerminal` is already imported at module top level.
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && grep -n "claudeSessionId: resumeSessionId" src/renderer/ui/components/TerminalManager.js | grep -v "^$" | wc -l && grep -n "data.claudeSessionId = sid" src/renderer/ui/components/TerminalManager.js && npm run build:renderer && npm test</automated>
  </verify>
  <done>createChatTerminal sets claudeSessionId on termData at creation (for resume) and in onSessionStart (for fresh sessions). Build and tests pass.</done>
</task>

</tasks>

<verification>
After both tasks:
1. `grep -c "claudeSessionId" src/renderer/ui/components/ChatView.js` returns >= 1
2. `grep -c "claudeSessionId" src/renderer/ui/components/TerminalManager.js` returns count increased by 2-3 from baseline
3. `npm run build:renderer` exits 0
4. `npm test` — all tests pass
</verification>

<success_criteria>
- ChatView propagates SDK session_id changes to termData.claudeSessionId via updateTerminal + immediate save
- createChatTerminal stores resumeSessionId on termData at creation
- createChatTerminal onSessionStart callback stores first session ID on termData
- Build passes, tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/6.4-bugfix-session-resume-claudesessionid-not-persisted-across-restarts/6.4-02-SUMMARY.md`
</output>
