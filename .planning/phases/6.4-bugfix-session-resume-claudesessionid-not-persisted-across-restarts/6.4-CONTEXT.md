# Phase 6.4: bugfix-session-resume-claudeSessionId-not-persisted-across-restarts - Context

**Gathered:** 2026-02-26
**Status:** Ready for planning

<domain>
## Phase Boundary

Fix the bug where `claudeSessionId` is not reliably persisted in `terminal-sessions.json`, causing Claude sessions to start fresh instead of resuming after app restart. Three diagnosed root causes (A, B, C) are all in scope. Debug investigation in `.planning/debug/session-not-resumed-on-restart.md` has full evidence.

</domain>

<decisions>
## Implementation Decisions

### Root Cause A — claudeSessionId not stored on termData at resume time
- Store `claudeSessionId` on the termData object inside `createTerminal` (TerminalManager.js) when `resumeSessionId` is provided
- Single source of truth: the termData gets the session ID at creation time, not after the restore loop

### Root Cause B — claudeSessionId depends on async event capture before app close
- Add a synchronous save in Electron's `before-quit` handler to flush `terminal-sessions.json` before the process exits
- This ensures the latest terminal state (including any claudeSessionId captured by the events system) is persisted even on fast app close

### Root Cause C — activeCwd matching broken (pre-existing)
- Store `cwd` on termData at creation time in `createTerminal`: `cwd: overrideCwd || project.path`
- This fixes the `td.cwd === saved.activeCwd` matching logic in renderer.js that currently always evaluates to `false`

### Claude's Discretion
- Exact placement of the before-quit handler in main.js lifecycle
- Whether the before-quit save triggers via IPC to renderer or reads state directly
- Error handling approach for edge cases (e.g., save fails during quit)

</decisions>

<specifics>
## Specific Ideas

- Debug investigation is complete — `.planning/debug/session-not-resumed-on-restart.md` contains full root cause analysis with line numbers and evidence
- The suggested fix directions in that debug file align with the decisions above

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 6.4-bugfix-session-resume-claudesessionid-not-persisted-across-restarts*
*Context gathered: 2026-02-26*
