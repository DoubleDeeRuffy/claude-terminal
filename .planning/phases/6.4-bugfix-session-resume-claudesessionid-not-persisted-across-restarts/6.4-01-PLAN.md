---
phase: 6.4-bugfix-session-resume-claudesessionid-not-persisted-across-restarts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/ui/components/TerminalManager.js
autonomous: true
requirements: []
must_haves:
  truths:
    - "claudeSessionId is stored on termData when createTerminal receives resumeSessionId"
    - "cwd is stored on termData at terminal creation time"
    - "Restored terminals preserve claudeSessionId across subsequent saves (no data loss on save cycle)"
    - "activeCwd matching in renderer.js restore loop can find the correct terminal"
  artifacts:
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "termData with claudeSessionId and cwd fields"
      contains: "claudeSessionId: resumeSessionId"
  key_links:
    - from: "src/renderer/ui/components/TerminalManager.js"
      to: "src/renderer/services/TerminalSessionService.js"
      via: "td.claudeSessionId read during save"
      pattern: "td.claudeSessionId"
    - from: "renderer.js"
      to: "src/renderer/ui/components/TerminalManager.js"
      via: "createTerminal({ resumeSessionId }) populates termData.claudeSessionId"
      pattern: "resumeSessionId"
---

<objective>
Fix three bugs preventing Claude session IDs from persisting across app restarts: (A) `claudeSessionId` not stored on termData when `resumeSessionId` is passed to `createTerminal`, (B) `cwd` never set on termData so `activeCwd` matching always fails, and (C) the existing before-quit save already works but saves undefined values due to (A).

Purpose: Without this fix, restarting the app always starts fresh Claude sessions instead of resuming previous ones — the session ID is passed to the PTY correctly on restore, but is lost on the very next save cycle because it was never stored on the renderer-side termData object.

Output: Two new fields (`claudeSessionId`, `cwd`) in the `termData` object literal in `createTerminal()`.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/session-not-resumed-on-restart.md
@.planning/phases/6.4-bugfix-session-resume-claudesessionid-not-persisted-across-restarts/6.4-RESEARCH.md
@src/renderer/ui/components/TerminalManager.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add claudeSessionId and cwd to termData in createTerminal</name>
  <files>src/renderer/ui/components/TerminalManager.js</files>
  <action>
In `createTerminal()`, locate the `termData` object literal (around lines 1389-1403). Add two new fields:

1. `cwd: overrideCwd || project.path` — mirrors the same expression already used in the `api.terminal.create()` call at line ~1354. Place it after `mode: 'terminal'`.

2. `...(resumeSessionId ? { claudeSessionId: resumeSessionId } : {})` — conditional spread that stores the session ID on termData when a resume is requested. Place it after the `cwd` line, before the existing `initialPrompt` spread.

The `resumeSessionId` variable is already destructured from `options` at the top of `createTerminal()` (confirmed in research). The `overrideCwd` and `project.path` are also already in scope.

DO NOT:
- Add a separate `updateTerminal()` call after `addTerminal()` — the field must be on the object literal to avoid state notification with incomplete data (per RESEARCH.md anti-pattern).
- Modify `saveTerminalSessionsImmediate()` or the debounced save — the save logic already reads `td.claudeSessionId` correctly.
- Modify `renderer.js` — the restore loop already passes `resumeSessionId` correctly.
- Touch the events system (`events/index.js`) — the async SESSION_START update is correct and will overwrite the initial value with the latest session ID if Claude issues a new one.

The resulting termData should look like:
```javascript
const termData = {
  terminal,
  fitAddon,
  project,
  projectIndex,
  name: tabName,
  status: initialStatus,
  inputBuffer: '',
  isBasic: isBasicTerminal,
  mode: 'terminal',
  cwd: overrideCwd || project.path,
  ...(resumeSessionId ? { claudeSessionId: resumeSessionId } : {}),
  ...(initialPrompt ? { pendingPrompt: initialPrompt } : {}),
  ...(overrideCwd ? { parentProjectId: project.id } : {})
};
```
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && grep -n "claudeSessionId: resumeSessionId" src/renderer/ui/components/TerminalManager.js && grep -n "cwd: overrideCwd || project.path" src/renderer/ui/components/TerminalManager.js | grep -v "api.terminal.create" | head -5</automated>
    <manual>Verify the two new fields appear inside the termData object literal, not in a separate updateTerminal call</manual>
  </verify>
  <done>
    - termData object in createTerminal contains `cwd: overrideCwd || project.path`
    - termData object in createTerminal contains conditional spread for `claudeSessionId` from `resumeSessionId`
    - `npm run build:renderer` succeeds
    - `npm test` passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify build and tests pass</name>
  <files>src/renderer/ui/components/TerminalManager.js</files>
  <action>
Run the renderer build and full test suite to confirm the change introduces no regressions.

1. Run `npm run build:renderer` — must succeed with exit code 0
2. Run `npm test` — all existing test suites must pass

No new tests are needed for this bugfix — the change adds two fields to an object literal with no branching logic. The existing save/restore pipeline tests (if any) will exercise the data flow.
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && npm run build:renderer && npm test</automated>
  </verify>
  <done>
    - `npm run build:renderer` exits 0
    - `npm test` exits 0 with all suites passing
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `grep -n "claudeSessionId: resumeSessionId" src/renderer/ui/components/TerminalManager.js` returns exactly 1 match inside the termData literal
2. `grep -n "cwd: overrideCwd || project.path" src/renderer/ui/components/TerminalManager.js` returns at least 2 matches (one in termData, one in api.terminal.create)
3. `npm run build:renderer` exits 0
4. `npm test` exits 0
</verification>

<success_criteria>
- The `termData` object in `createTerminal()` includes `claudeSessionId` (from `resumeSessionId`) and `cwd` (from `overrideCwd || project.path`)
- No other files modified — the fix is surgical (one location, two fields)
- Build and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/6.4-bugfix-session-resume-claudesessionid-not-persisted-across-restarts/6.4-01-SUMMARY.md`
</output>
