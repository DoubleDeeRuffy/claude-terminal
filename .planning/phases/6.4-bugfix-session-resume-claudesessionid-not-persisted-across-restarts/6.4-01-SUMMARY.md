---
phase: 6.4-bugfix-session-resume-claudesessionid-not-persisted-across-restarts
plan: 01
subsystem: renderer/terminal-manager
tags: [bugfix, session-resume, persistence]
dependency_graph:
  requires: []
  provides: [claudeSessionId on termData, cwd on termData]
  affects: [TerminalSessionService save pipeline, activeCwd matching in restore loop]
tech_stack:
  added: []
  patterns: [conditional spread on object literal]
key_files:
  created: []
  modified:
    - src/renderer/ui/components/TerminalManager.js
decisions:
  - "Add cwd and claudeSessionId directly to termData object literal (not via updateTerminal call) to avoid state notification with incomplete data"
  - "Use conditional spread for claudeSessionId to avoid setting undefined on non-resume terminals"
metrics:
  duration: ~5 minutes
  completed: 2026-02-26T19:20:00Z
---

# Phase 6.4 Plan 01: Fix claudeSessionId Not Persisted on termData Summary

Two fields (`cwd` and `claudeSessionId`) added to the `termData` object literal in `createTerminal()` to fix session IDs being lost on the next save cycle after app restart restore.

## What Was Built

Added two fields to the `termData` object literal in `createTerminal()` in `src/renderer/ui/components/TerminalManager.js`:

1. `cwd: overrideCwd || project.path` — mirrors the value already passed to `api.terminal.create()`, enabling correct `activeCwd` matching in the restore loop
2. `...(resumeSessionId ? { claudeSessionId: resumeSessionId } : {})` — stores the resumed session ID on termData so `TerminalSessionService` can read `td.claudeSessionId` on the next save and persist it correctly

**Root cause fixed:** When the app restarted and restored terminals via `resumeSessionId`, the session ID was forwarded to the PTY correctly but never stored on the renderer-side `termData` object. On the very next save cycle (triggered by project switch, before-quit, etc.), `TerminalSessionService` read `td.claudeSessionId` and found `undefined`, writing `null` back to disk. This caused every subsequent restart to start fresh instead of resuming.

## Tasks Completed

| Task | Description | Commit | Files |
|------|-------------|--------|-------|
| 1 | Add claudeSessionId and cwd to termData in createTerminal | cd8fd7ba | src/renderer/ui/components/TerminalManager.js |
| 2 | Verify build and tests pass | (no separate commit — verification only) | — |

## Verification Results

- `grep "claudeSessionId: resumeSessionId"` — 1 match at line 1402 (inside termData literal)
- `grep "cwd: overrideCwd || project.path"` — 3 matches: line 1354 (api.terminal.create), line 1401 (termData), line 1537 (watchdog)
- `npm run build:renderer` — exit 0
- `npm test` — 281 tests, 14 suites, all passed

## Deviations from Plan

None - plan executed exactly as written.

## Self-Check: PASSED

- [x] `src/renderer/ui/components/TerminalManager.js` modified with 2 insertions
- [x] Commit `cd8fd7ba` exists
- [x] Build succeeded
- [x] Tests pass (281/281)
