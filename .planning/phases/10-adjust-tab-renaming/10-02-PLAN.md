---
phase: 10-adjust-tab-renaming
plan: "02"
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/renderer/ui/panels/SettingsPanel.js
  - src/renderer/ui/components/TerminalManager.js
  - src/renderer/i18n/locales/en.json
  - src/renderer/i18n/locales/fr.json
autonomous: true
requirements: [TAB-RENAME-01]
gap_closure: true
must_haves:
  truths:
    - "Toggle appears in Settings > Claude tab under a Terminal sub-section (between Default Terminal Mode and Hooks)"
    - "Terminal tab name updates to the exact slash command text when enabled"
    - "OSC title updates do not overwrite the slash-command tab name"
  artifacts:
    - path: "src/renderer/ui/panels/SettingsPanel.js"
      provides: "Toggle in Claude tab Terminal group"
      contains: "tab-rename-slash-toggle"
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "updateTerminalTabName export + OSC guard"
      exports: ["updateTerminalTabName"]
    - path: "src/renderer/i18n/locales/en.json"
      provides: "Terminal group label"
      contains: "settings.terminalGroup"
    - path: "src/renderer/i18n/locales/fr.json"
      provides: "Terminal group label (French)"
      contains: "settings.terminalGroup"
  key_links:
    - from: "src/renderer/events/index.js"
      to: "TerminalManager.updateTerminalTabName"
      via: "require + function call"
      pattern: "TerminalManager\\.updateTerminalTabName"
    - from: "src/renderer/ui/components/TerminalManager.js"
      to: "settings.state getSetting"
      via: "OSC handler guard check"
      pattern: "getSetting.*tabRenameOnSlashCommand"
---

<objective>
Fix two UAT-reported gaps in tab renaming: (1) move the toggle from General > System to Claude > Terminal sub-section, and (2) fix the rename not working because updateTerminalTabName is not exported AND handleOscTitle unconditionally overwrites the slash-command name.

Purpose: Close UAT gaps so slash-command tab renaming actually works and the setting is in the correct location.
Output: Modified SettingsPanel.js, TerminalManager.js, en.json, fr.json
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-adjust-tab-renaming/10-01-SUMMARY.md
@.planning/phases/10-adjust-tab-renaming/10-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move toggle from General to Claude > Terminal group and fix export + OSC guard</name>
  <files>
    src/renderer/ui/panels/SettingsPanel.js
    src/renderer/ui/components/TerminalManager.js
    src/renderer/i18n/locales/en.json
    src/renderer/i18n/locales/fr.json
  </files>
  <action>
**SettingsPanel.js — Move toggle to Claude tab:**

1. Remove the entire `settings-toggle-row` block for `tabRenameOnSlashCommand` from the General panel (currently at ~line 456-465, after `update-title-on-project-switch-toggle`). Delete the full div including label, desc, and checkbox.

2. In the Claude panel (`data-panel="claude"`), insert a new settings group BETWEEN the "Default Terminal Mode" group (ends ~line 645-646) and the "Hooks" group (starts ~line 647). The new group:

```html
<div class="settings-group">
  <div class="settings-group-title">${t('settings.terminalGroup')}</div>
  <div class="settings-card">
    <div class="settings-toggle-row">
      <div class="settings-toggle-label">
        <div>${t('settings.tabRenameOnSlashCommand')}</div>
        <div class="settings-toggle-desc">${t('settings.tabRenameOnSlashCommandDesc')}</div>
      </div>
      <label class="settings-toggle">
        <input type="checkbox" id="tab-rename-slash-toggle" ${settings.tabRenameOnSlashCommand ? 'checked' : ''}>
        <span class="settings-toggle-slider"></span>
      </label>
    </div>
  </div>
</div>
```

3. The `saveSettingsHandler` already reads `tab-rename-slash-toggle` by ID — no change needed there since the ID stays the same.

**TerminalManager.js — Export updateTerminalTabName:**

4. Add `updateTerminalTabName` to the `module.exports` object (at ~line 3689). Place it after `updateTerminalStatus` on line 3698. This fixes the silent failure in wireTabRenameConsumer's try/catch.

**TerminalManager.js — Guard OSC title from overwriting slash-command names:**

5. In the handleOscTitle function, at both `updateTerminalTabName` calls (lines ~392 and ~404), add a guard that skips the rename when:
   - `tabRenameOnSlashCommand` setting is enabled, AND
   - the current terminal's name starts with `/`

The guard logic (add BEFORE each `updateTerminalTabName` call in handleOscTitle):
```javascript
// Skip OSC rename if tab was renamed to a slash command
const { getSetting } = require('../state/settings.state');
if (getSetting('tabRenameOnSlashCommand')) {
  const td = getTerminal(id);
  if (td && td.name && td.name.startsWith('/')) return;
}
```

IMPORTANT: The `require` for getSetting must be lazy (inside the if block or at call-time) following the established pattern from Phase 4+. Do NOT hoist it to module level.

NOTE on the guard placement: The two sites are:
- Line ~391-393: Inside `if (parsed.taskName)` block after the working-state braille check
- Line ~401-404: Inside the ready-candidate braille check `if (parsed.taskName)` block

At line ~392, the guard should go right before `updateTerminalTabName(id, parsed.taskName);` — and if the guard triggers, skip just the updateTerminalTabName call (not the entire block, since updateTerminalStatus must still fire).

At line ~404, the guard should go right before `updateTerminalTabName(id, parsed.taskName);` — same logic.

Use a helper to avoid code duplication. Define a local function near the top of handleOscTitle (or as a module-level helper):
```javascript
function shouldSkipOscRename(id) {
  const { getSetting } = require('../state/settings.state');
  if (!getSetting('tabRenameOnSlashCommand')) return false;
  const td = getTerminal(id);
  return td && td.name && td.name.startsWith('/');
}
```

Then at both sites, wrap the updateTerminalTabName call:
```javascript
if (!shouldSkipOscRename(id)) {
  updateTerminalTabName(id, parsed.taskName);
}
```

**i18n — Add Terminal group key:**

6. In `en.json`, add under the `settings` section:
   - `"settings.terminalGroup": "Terminal"`

7. In `fr.json`, add under the `settings` section:
   - `"settings.terminalGroup": "Terminal"`

(Same word in both languages — "Terminal" is the same in French.)
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && grep -c "tab-rename-slash-toggle" src/renderer/ui/panels/SettingsPanel.js && grep -c "shouldSkipOscRename" src/renderer/ui/components/TerminalManager.js && grep -c "terminalGroup" src/renderer/i18n/locales/en.json && npm run build:renderer 2>&1 | tail -1</automated>
    <manual>Open Settings > Claude tab, verify "Terminal" group with toggle appears between Default Terminal Mode and Hooks</manual>
  </verify>
  <done>
    - Toggle removed from General tab, present in Claude > Terminal group
    - updateTerminalTabName exported from TerminalManager
    - shouldSkipOscRename guards both OSC updateTerminalTabName call sites
    - i18n keys for terminalGroup in en.json and fr.json
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify end-to-end fix with grep validation</name>
  <files></files>
  <action>
Run verification greps to confirm all gap closures are correct:

1. Confirm toggle is NOT in data-panel="general" section:
   - grep for `tab-rename-slash-toggle` in SettingsPanel.js — should appear exactly 2 times (HTML + saveHandler), neither inside data-panel="general" block

2. Confirm toggle IS in data-panel="claude" section:
   - The `tab-rename-slash-toggle` HTML should appear after `data-panel="claude"` and before `data-panel="github"`

3. Confirm updateTerminalTabName is exported:
   - grep module.exports block for updateTerminalTabName

4. Confirm shouldSkipOscRename exists and is called at both OSC sites:
   - grep for `shouldSkipOscRename` — should have 3 hits (definition + 2 call sites)

5. Confirm terminalGroup i18n key exists in both locales

6. Run `npm run build:renderer` — must succeed

7. Run `npm test` — must pass
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && grep -c "shouldSkipOscRename" src/renderer/ui/components/TerminalManager.js && grep "updateTerminalTabName" src/renderer/ui/components/TerminalManager.js | grep -c "module.exports\|exports\." && grep -c "terminalGroup" src/renderer/i18n/locales/en.json && grep -c "terminalGroup" src/renderer/i18n/locales/fr.json && npm run build:renderer 2>&1 | tail -1 && npm test 2>&1 | tail -5</automated>
  </verify>
  <done>
    - All greps confirm correct placement
    - Build succeeds
    - Tests pass
  </done>
</task>

</tasks>

<verification>
1. `grep -c "tab-rename-slash-toggle" src/renderer/ui/panels/SettingsPanel.js` returns 2
2. Toggle HTML appears between lines containing `data-panel="claude"` and `data-panel="github"` (not in general)
3. `grep "updateTerminalTabName" src/renderer/ui/components/TerminalManager.js` shows it in module.exports
4. `grep -c "shouldSkipOscRename" src/renderer/ui/components/TerminalManager.js` returns 3
5. `grep "terminalGroup" src/renderer/i18n/locales/en.json` returns 1
6. `npm run build:renderer` succeeds
7. `npm test` passes
</verification>

<success_criteria>
- Tab rename toggle appears in Settings > Claude > Terminal group (not General)
- wireTabRenameConsumer successfully calls updateTerminalTabName (now exported)
- OSC title updates do not overwrite slash-command tab names when setting is enabled
- Build and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-adjust-tab-renaming/10-02-SUMMARY.md`
</output>
