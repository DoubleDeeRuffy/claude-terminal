---
phase: 21-integrated-markdown-viewer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/ui/components/TerminalManager.js
  - styles/terminal.css
  - src/renderer/i18n/locales/en.json
  - src/renderer/i18n/locales/fr.json
autonomous: true
requirements:
  - MD-VIEW-01

must_haves:
  truths:
    - "Single-clicking a .md file in the file explorer opens a rendered markdown preview tab"
    - "Tab shows the filename and can be closed/middle-clicked like any terminal tab"
    - "Clicking an already-open .md file focuses its existing tab (no duplicates)"
    - "Toggle button in the header switches between rendered markdown and raw source"
    - "Fenced code blocks have language-aware syntax highlighting with hover copy button"
    - "Links require Ctrl+click to open and show a tooltip indicating this"
    - "Relative images resolve and render inline"
    - "Collapsible TOC sidebar generated from document headings is visible"
    - "Code block copy button and Ctrl+click link gating work correctly"
  artifacts:
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "Markdown branch in openFileTab with rendering, TOC, toggle, link gating, image resolution"
      contains: "isMarkdown"
    - path: "styles/terminal.css"
      provides: "md-viewer-* CSS classes for markdown preview layout and styling"
      contains: "md-viewer-wrapper"
    - path: "src/renderer/i18n/locales/en.json"
      provides: "mdViewer.* i18n keys"
      contains: "mdViewer"
    - path: "src/renderer/i18n/locales/fr.json"
      provides: "mdViewer.* i18n keys in French"
      contains: "mdViewer"
  key_links:
    - from: "TerminalManager.js openFileTab()"
      to: "marked (new Marked instance)"
      via: "isMarkdown branch rendering"
      pattern: "new Marked"
    - from: "TerminalManager.js closeTerminal()"
      to: "termData.mdCleanup"
      via: "cleanup call on file tab close"
      pattern: "mdCleanup"
---

<objective>
Add a markdown preview branch to the existing `openFileTab()` in TerminalManager.js so that `.md` files render as formatted content with a TOC sidebar, source/rendered toggle, code block copy buttons, Ctrl+click link gating, and relative image resolution. Add all supporting CSS and i18n keys.

Purpose: Users can view markdown files inline in Claude Terminal as nicely rendered content instead of raw text with syntax highlighting.
Output: Markdown viewer rendering engine integrated into the existing file tab system, with full CSS styling and i18n support.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-integrated-markdown-viewer/21-CONTEXT.md
@.planning/phases/21-integrated-markdown-viewer/21-RESEARCH.md

@src/renderer/ui/components/TerminalManager.js (lines 3257-3399: openFileTab, lines 1303-1350: closeTerminal)
@src/renderer/ui/components/ChatView.js (lines 26-83: marked config and renderMarkdown pattern)
@src/renderer/utils/syntaxHighlight.js (highlight function)
@styles/terminal.css (lines 1412-1540: existing file-viewer-* CSS)
@styles/chat.css (lines 390-470: chat-code-block, chat-code-copy CSS)

<interfaces>
<!-- Key imports already available in TerminalManager.js -->
From src/renderer/utils/index.js:
  const { escapeHtml, getFileIcon, highlight } = require('../../utils');

From marked (already in package.json ^17.0.3):
  const { Marked } = require('marked');  // Instance-based API for isolated config

From TerminalManager.js existing patterns:
  function openFileTab(filePath, project) { ... }  // Has branches for image/video/audio/text
  function closeTerminal(id) { ... }  // Has branch for type === 'file' (line 1341)
  function addTerminal(id, termData) { ... }
  function setActiveTerminal(id) { ... }

From ChatView.js marked config pattern:
  marked.use({ renderer: { code(), link(), html() {} }, tokenizer: { html() {} }, gfm: true });
  // CRITICAL: Use new Marked() instance to avoid global config conflict with ChatView

From settings.state.js:
  const { getSetting, setSetting } = require('../../state/settings.state');
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add markdown rendering branch to openFileTab and cleanup to closeTerminal</name>
  <files>src/renderer/ui/components/TerminalManager.js, src/renderer/i18n/locales/en.json, src/renderer/i18n/locales/fr.json</files>
  <action>
  **In TerminalManager.js:**

  1. **Add `Marked` import** near the top of the file (alongside existing `require` calls):
     ```javascript
     const { Marked } = require('marked');
     ```

  2. **Create a module-level markdown renderer factory** (above `openFileTab`):
     ```javascript
     function createMdRenderer(basePath) {
       const md = new Marked();
       md.use({
         renderer: {
           code({ text, lang }) {
             const decoded = (text || '').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
             const highlighted = lang ? highlight(decoded, lang) : escapeHtml(decoded);
             return `<div class="chat-code-block"><div class="chat-code-header"><span class="chat-code-lang">${escapeHtml(lang || 'text')}</span><button class="chat-code-copy" title="${t('common.copy')}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button></div><pre><code>${highlighted}</code></pre></div>`;
           },
           codespan({ text }) {
             return `<code class="chat-inline-code">${escapeHtml(text)}</code>`;
           },
           table({ header, rows }) {
             const safeAlign = (a) => ['left', 'center', 'right'].includes(a) ? a : 'left';
             const headerHtml = header.map(h => `<th style="text-align:${safeAlign(h.align)}">${escapeHtml(typeof h.text === 'string' ? h.text : String(h.text || ''))}</th>`).join('');
             const rowsHtml = rows.map(row =>
               `<tr>${row.map(cell => `<td style="text-align:${safeAlign(cell.align)}">${escapeHtml(typeof cell.text === 'string' ? cell.text : String(cell.text || ''))}</td>`).join('')}</tr>`
             ).join('');
             return `<div class="chat-table-wrapper"><table class="chat-table"><thead><tr>${headerHtml}</tr></thead><tbody>${rowsHtml}</tbody></table></div>`;
           },
           link({ href, text }) {
             const safeHref = escapeHtml((href || '').trim());
             return `<a class="md-viewer-link" data-md-link="${safeHref}" title="${t('mdViewer.ctrlClickToOpen')}">${text || safeHref}</a>`;
           },
           image({ href, title, text }) {
             const src = (href || '').startsWith('http') ? href
               : `file:///${path.resolve(basePath, href || '').replace(/\\/g, '/')}`;
             return `<img src="${src}" alt="${escapeHtml(text || '')}" title="${escapeHtml(title || '')}" class="md-viewer-img" />`;
           },
           heading({ tokens, depth }) {
             const text = tokens.map(t => t.raw || t.text || '').join('');
             const id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
             return `<h${depth} id="md-h-${id}" class="md-viewer-heading">${this.parser.parseInline(tokens)}</h${depth}>`;
           },
           html() { return ''; }
         },
         tokenizer: {
           html() { return undefined; }
         },
         gfm: true,
         breaks: false
       });
       return md;
     }
     ```

  3. **Create a TOC builder function:**
     ```javascript
     function buildMdToc(content) {
       const md = new Marked();
       const tokens = md.lexer(content);
       const headings = tokens
         .filter(t => t.type === 'heading')
         .map(t => {
           const text = t.text || '';
           const id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
           return { depth: t.depth, text, id: `md-h-${id}` };
         });
       if (headings.length === 0) return '';
       return `<nav class="md-toc-nav">
         <div class="md-toc-title">${t('mdViewer.tableOfContents')}</div>
         <ul class="md-toc-list">${headings.map(h =>
           `<li class="md-toc-item md-toc-depth-${h.depth}"><a href="#${h.id}" data-toc-link="${h.id}">${escapeHtml(h.text)}</a></li>`
         ).join('')}</ul>
       </nav>`;
     }
     ```

  4. **In `openFileTab()`, add the markdown branch** — insert before the `else` text-file branch (before line ~3353 `} else {`):

     After `const isMedia = isImage || isVideo || isAudio;` add:
     ```javascript
     const isMarkdown = ext === 'md';
     ```

     Then before the text fallback `else {` branch, add an `else if (isMarkdown) {` branch:
     ```javascript
     } else if (isMarkdown) {
       const basePath = path.dirname(filePath);
       const mdRenderer = createMdRenderer(basePath);
       const renderedHtml = mdRenderer.parse(content);
       const tocHtml = buildMdToc(content);
       const tocExpanded = getSetting('mdViewerTocExpanded') !== false;
       const lineCount = content.split('\n').length;

       const sourceHighlighted = highlight(content, 'md');
       const sourceLines = content.split('\n');
       const sourceLineNums = sourceLines.map((_, i) => `<span class="line-num">${i + 1}</span>`).join('\n');

       viewerBody = `
         <div class="md-viewer-wrapper">
           <div class="md-viewer-toc${tocExpanded ? '' : ' collapsed'}" id="md-toc-${id}">
             <button class="md-toc-toggle" title="${t('mdViewer.toggleToc')}">
               <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
             </button>
             ${tocHtml}
           </div>
           <div class="md-viewer-content">
             <div class="md-viewer-body" id="md-body-${id}">${renderedHtml}</div>
             <div class="md-viewer-source" id="md-source-${id}" style="display:none">
               <div class="file-viewer-content">
                 <div class="file-viewer-lines">${sourceLineNums}</div>
                 <pre class="file-viewer-code"><code>${sourceHighlighted}</code></pre>
               </div>
             </div>
           </div>
         </div>`;

       sizeStr += ` \u00B7 ${lineCount} lines`;

       // Store extra state on termData
       termData.isMarkdown = true;
       termData.mdViewMode = 'rendered';
       termData.mdRenderer = mdRenderer;
       termData.mdCleanup = null; // Will be set by Plan 21-02 for file watcher
     }
     ```

  5. **For the markdown branch, add a header toggle button.** In the `wrapper.innerHTML` assignment (line ~3369), the header is built with the same template. For markdown files, add a toggle button and search button in the header. After `wrapper.innerHTML = ...` is set, add:
     ```javascript
     if (isMarkdown) {
       const header = wrapper.querySelector('.file-viewer-header');
       // Add toggle button (rendered/source)
       const toggleBtn = document.createElement('button');
       toggleBtn.className = 'md-viewer-toggle-btn';
       toggleBtn.title = t('mdViewer.toggleSource');
       toggleBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 18l6-6-6-6"/><path d="M8 6l-6 6 6 6"/></svg>`;
       header.appendChild(toggleBtn);

       // Toggle rendered/source
       toggleBtn.addEventListener('click', () => {
         const bodyEl = wrapper.querySelector('.md-viewer-body');
         const sourceEl = wrapper.querySelector('.md-viewer-source');
         if (termData.mdViewMode === 'rendered') {
           bodyEl.style.display = 'none';
           sourceEl.style.display = '';
           termData.mdViewMode = 'source';
           toggleBtn.classList.add('active');
           toggleBtn.title = t('mdViewer.toggleRendered');
         } else {
           bodyEl.style.display = '';
           sourceEl.style.display = 'none';
           termData.mdViewMode = 'rendered';
           toggleBtn.classList.remove('active');
           toggleBtn.title = t('mdViewer.toggleSource');
         }
       });
     }
     ```

  6. **Wire delegated event handlers on the wrapper** (after wrapper is appended to container, before `setActiveTerminal(id)`):
     ```javascript
     if (isMarkdown) {
       // Copy button handler (reuse ChatView pattern)
       wrapper.addEventListener('click', (e) => {
         const copyBtn = e.target.closest('.chat-code-copy');
         if (copyBtn) {
           const code = copyBtn.closest('.chat-code-block')?.querySelector('code')?.textContent;
           if (code) {
             navigator.clipboard.writeText(code);
             copyBtn.classList.add('copied');
             setTimeout(() => copyBtn.classList.remove('copied'), 1500);
           }
           return;
         }

         // Ctrl+click link gating
         const link = e.target.closest('[data-md-link]');
         if (link) {
           e.preventDefault();
           if (e.ctrlKey) {
             api.dialog.openExternal(link.dataset.mdLink);
           }
           return;
         }

         // TOC link smooth scroll
         const tocLink = e.target.closest('[data-toc-link]');
         if (tocLink) {
           e.preventDefault();
           const targetId = tocLink.dataset.tocLink;
           const targetEl = wrapper.querySelector(`#${targetId}`);
           if (targetEl) {
             targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
           }
           return;
         }
       });

       // TOC toggle
       const tocToggle = wrapper.querySelector('.md-toc-toggle');
       if (tocToggle) {
         tocToggle.addEventListener('click', () => {
           const tocEl = wrapper.querySelector('.md-viewer-toc');
           tocEl.classList.toggle('collapsed');
           setSetting('mdViewerTocExpanded', !tocEl.classList.contains('collapsed'));
         });
       }
     }
     ```

  7. **In `closeTerminal()`,** extend the file tab cleanup branch (line ~1341-1343). After `} else if (termData && termData.type === 'file') {`, add cleanup:
     ```javascript
     } else if (termData && termData.type === 'file') {
       if (termData.mdCleanup) termData.mdCleanup();
       removeTerminal(id);
     }
     ```

  **In en.json:**
  Add `mdViewer` keys at the appropriate level:
  ```json
  "mdViewer": {
    "tableOfContents": "Table of Contents",
    "toggleToc": "Toggle table of contents",
    "toggleSource": "View source",
    "toggleRendered": "View rendered",
    "ctrlClickToOpen": "Ctrl+click to open",
    "searchPlaceholder": "Search in document...",
    "noResults": "No results"
  }
  ```

  **In fr.json:**
  Add matching French keys:
  ```json
  "mdViewer": {
    "tableOfContents": "Table des matières",
    "toggleToc": "Afficher/masquer la table des matières",
    "toggleSource": "Voir la source",
    "toggleRendered": "Voir le rendu",
    "ctrlClickToOpen": "Ctrl+clic pour ouvrir",
    "searchPlaceholder": "Rechercher dans le document...",
    "noResults": "Aucun résultat"
  }
  ```

  **IMPORTANT:** Import `{ t }` from `../../i18n` and `{ getSetting, setSetting }` from `../../state/settings.state` at the top of TerminalManager.js if not already imported. Check first — if `t` is already imported, skip. If `getSetting`/`setSetting` are already imported, skip.
  </action>
  <verify>
    <automated>npm run build:renderer && npm test</automated>
  </verify>
  <done>
  - Single-clicking a .md file opens a rendered markdown preview tab with formatted headings, lists, code blocks, tables
  - Fenced code blocks show language label and hover copy button (reusing chat-code-block CSS)
  - Links show "Ctrl+click to open" tooltip and only navigate when Ctrl is held
  - Relative images resolve to file:// URLs and render inline
  - Collapsible TOC sidebar generated from headings with smooth scroll to anchors
  - Toggle button switches between rendered preview and raw source with line numbers
  - Clicking an already-open .md file focuses its existing tab
  - Tab close and middle-click close work correctly, calling mdCleanup if set
  - i18n keys added in both en.json and fr.json
  </done>
</task>

<task type="auto">
  <name>Task 2: Add markdown viewer CSS styles</name>
  <files>styles/terminal.css</files>
  <action>
  Add CSS rules for the markdown viewer after the existing `.file-viewer-media-audio` block (around line 1540). Use the app's dark theme variables and accent color. The styles cover:

  **1. Wrapper layout (sidebar + content):**
  ```css
  /* ===== Markdown Viewer ===== */
  .md-viewer-wrapper {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  .md-viewer-content {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  ```

  **2. TOC sidebar (collapsible):**
  ```css
  .md-viewer-toc {
    width: 240px;
    min-width: 240px;
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
    padding: 12px 0;
    display: flex;
    flex-direction: column;
    transition: width 0.2s ease, min-width 0.2s ease, padding 0.2s ease;
  }

  .md-viewer-toc.collapsed {
    width: 40px;
    min-width: 40px;
    padding: 12px 0;
  }

  .md-viewer-toc.collapsed .md-toc-nav {
    display: none;
  }

  .md-toc-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px 8px;
    margin: 0 8px 8px;
    border-radius: var(--radius-sm);
  }

  .md-toc-toggle:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
  }

  .md-toc-toggle svg {
    width: 16px;
    height: 16px;
  }

  .md-toc-title {
    font-size: var(--font-xs);
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0 16px 8px;
  }

  .md-toc-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .md-toc-item a {
    display: block;
    padding: 4px 16px;
    font-size: var(--font-xs);
    color: var(--text-secondary);
    text-decoration: none;
    border-left: 2px solid transparent;
    cursor: pointer;
  }

  .md-toc-item a:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
    border-left-color: var(--accent);
  }

  .md-toc-depth-2 a { padding-left: 28px; }
  .md-toc-depth-3 a { padding-left: 40px; }
  .md-toc-depth-4 a { padding-left: 52px; }
  .md-toc-depth-5 a { padding-left: 64px; }
  .md-toc-depth-6 a { padding-left: 76px; }
  ```

  **3. Rendered markdown body:**
  ```css
  .md-viewer-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px 32px 48px;
    color: var(--text-primary);
    font-size: var(--font-base);
    line-height: 1.7;
  }

  .md-viewer-body h1,
  .md-viewer-body h2,
  .md-viewer-body h3,
  .md-viewer-body h4,
  .md-viewer-body h5,
  .md-viewer-body h6 {
    color: var(--text-primary);
    font-weight: 600;
    margin: 1.5em 0 0.5em;
    line-height: 1.3;
  }

  .md-viewer-body h1 { font-size: 1.75rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
  .md-viewer-body h2 { font-size: 1.4rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
  .md-viewer-body h3 { font-size: 1.15rem; }
  .md-viewer-body h4 { font-size: 1rem; }
  .md-viewer-body h5 { font-size: var(--font-sm); }
  .md-viewer-body h6 { font-size: var(--font-xs); color: var(--text-secondary); }

  .md-viewer-body h1:first-child,
  .md-viewer-body h2:first-child {
    margin-top: 0;
  }

  .md-viewer-body p {
    margin: 0 0 1em;
  }

  .md-viewer-body ul,
  .md-viewer-body ol {
    margin: 0 0 1em;
    padding-left: 2em;
  }

  .md-viewer-body li {
    margin: 0.25em 0;
  }

  .md-viewer-body li > ul,
  .md-viewer-body li > ol {
    margin: 0.25em 0 0;
  }

  .md-viewer-body blockquote {
    margin: 0 0 1em;
    padding: 0.5em 1em;
    border-left: 3px solid var(--accent);
    background: var(--bg-tertiary);
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    color: var(--text-secondary);
  }

  .md-viewer-body blockquote p:last-child {
    margin-bottom: 0;
  }

  .md-viewer-body hr {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 1.5em 0;
  }

  .md-viewer-body strong {
    color: var(--text-primary);
    font-weight: 600;
  }

  .md-viewer-body em {
    font-style: italic;
  }

  .md-viewer-body a.md-viewer-link {
    color: var(--accent);
    text-decoration: none;
    cursor: pointer;
  }

  .md-viewer-body a.md-viewer-link:hover {
    text-decoration: underline;
    color: var(--accent-hover);
  }

  .md-viewer-body .md-viewer-img {
    max-width: 100%;
    border-radius: var(--radius);
    margin: 0.5em 0;
  }

  /* Reuse chat-table styles for markdown viewer tables */
  .md-viewer-body .chat-table-wrapper {
    margin: 0 0 1em;
    overflow-x: auto;
  }

  .md-viewer-body .chat-table {
    width: 100%;
  }

  /* Code blocks in markdown viewer inherit from chat-code-block CSS */
  .md-viewer-body .chat-code-block {
    margin: 0 0 1em;
  }

  .md-viewer-body .chat-inline-code {
    background: var(--bg-tertiary);
    padding: 0.15em 0.4em;
    border-radius: var(--radius-sm);
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 0.9em;
  }
  ```

  **4. Source view (reuses existing file-viewer-content styles):**
  ```css
  .md-viewer-source {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .md-viewer-source .file-viewer-content {
    flex: 1;
  }
  ```

  **5. Header toggle button:**
  ```css
  .md-viewer-toggle-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    padding: 3px 8px;
    border-radius: var(--radius-sm);
    margin-left: auto;
    gap: 4px;
    font-size: var(--font-xs);
  }

  .md-viewer-toggle-btn:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
    border-color: var(--text-muted);
  }

  .md-viewer-toggle-btn.active {
    color: var(--accent);
    border-color: var(--accent-dim);
    background: var(--accent-dim);
  }

  .md-viewer-toggle-btn svg {
    width: 14px;
    height: 14px;
  }
  ```

  **6. Search bar (prepared for Plan 21-02):**
  ```css
  .md-viewer-search {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
  }

  .md-viewer-search.visible {
    display: flex;
  }

  .md-viewer-search input {
    flex: 1;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 4px 8px;
    border-radius: var(--radius-sm);
    font-size: var(--font-sm);
    outline: none;
  }

  .md-viewer-search input:focus {
    border-color: var(--accent);
  }

  .md-viewer-search .md-search-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 2px;
    display: flex;
  }

  .md-viewer-search .md-search-close:hover {
    color: var(--text-primary);
  }

  .md-viewer-search .md-search-close svg {
    width: 14px;
    height: 14px;
  }
  ```

  **IMPORTANT:** Ensure the CSS is placed in the correct location after the file viewer media styles (after `.file-viewer-media-audio` block). Use the app's dark theme variables consistently.
  </action>
  <verify>
    <automated>npm run build:renderer</automated>
  </verify>
  <done>
  - All md-viewer-* CSS classes exist in terminal.css
  - Dark theme variables used throughout (--bg-primary, --bg-secondary, --text-primary, --accent, etc.)
  - TOC sidebar has collapsible animation, depth-based indentation, and hover states
  - Markdown body styles cover all block-level elements (headings, lists, blockquotes, tables, code, images)
  - Code blocks reuse chat-code-block CSS (no duplication)
  - Toggle button has normal, hover, and active states
  - Search bar CSS is prepared for Plan 21-02
  </done>
</task>

</tasks>

<verification>
1. `npm run build:renderer` completes without errors
2. `npm test` passes (no regressions)
3. Grep confirms `isMarkdown` branch exists in TerminalManager.js
4. Grep confirms `md-viewer-wrapper` CSS class exists in terminal.css
5. Grep confirms `mdViewer` keys exist in both en.json and fr.json
6. Grep confirms `mdCleanup` cleanup call in closeTerminal
</verification>

<success_criteria>
- .md files open as rendered markdown preview tabs with formatted content
- Toggle button switches between rendered and source view
- TOC sidebar shows with headings and smooth scroll navigation
- Code blocks have syntax highlighting and copy buttons
- Links require Ctrl+click to open
- Relative images resolve and display
- Tab system works (no duplicates, close, middle-click close)
- No regression in existing file tab, chat, or terminal functionality
</success_criteria>

<output>
After completion, create `.planning/phases/21-integrated-markdown-viewer/21-01-SUMMARY.md`
</output>
