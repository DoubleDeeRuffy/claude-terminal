---
phase: 21-integrated-markdown-viewer
plan: 02
type: execute
wave: 2
depends_on:
  - 21-01
files_modified:
  - src/main/ipc/dialog.ipc.js
  - src/main/preload.js
  - src/renderer/ui/components/TerminalManager.js
  - src/renderer/ui/components/FileExplorer.js
autonomous: true
requirements:
  - MD-VIEW-02
  - MD-VIEW-03

must_haves:
  truths:
    - "When a .md file changes on disk, the rendered preview updates automatically without losing scroll position"
    - "Ctrl+F opens a search bar within the markdown preview for in-document search"
    - "Search bar closes with Escape and supports Enter for next match / Shift+Enter for previous"
    - "File watcher is cleaned up when the markdown tab is closed (no resource leaks)"
    - "Double-clicking a .md file in the explorer opens it in the external editor"
    - "File watcher fires are debounced (300ms) to handle multi-event editor saves"
  artifacts:
    - path: "src/main/ipc/dialog.ipc.js"
      provides: "watchFile/unwatchFile IPC handlers"
      contains: "watch-file"
    - path: "src/main/preload.js"
      provides: "dialog.watchFile, dialog.unwatchFile, dialog.onFileChanged bridge methods"
      contains: "watchFile"
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "File watcher wiring, Ctrl+F search bar, debounced re-render"
      contains: "onFileChanged"
    - path: "src/renderer/ui/components/FileExplorer.js"
      provides: "Double-click handler for .md files opening in external editor"
      contains: "dblclick"
  key_links:
    - from: "dialog.ipc.js (watch-file handler)"
      to: "TerminalManager.js (onFileChanged listener)"
      via: "IPC file-changed event"
      pattern: "file-changed"
    - from: "FileExplorer.js (dblclick handler)"
      to: "api.dialog.openInEditor"
      via: "double-click on .md file"
      pattern: "dblclick"
---

<objective>
Add file watching IPC for live reload, Ctrl+F in-document search, and double-click-to-editor for `.md` files. Wire the file watcher into the markdown tab lifecycle with proper cleanup on close.

Purpose: Complete the markdown viewer experience with live reload on file changes, in-document search, and external editor access via double-click.
Output: File watcher IPC channels, live reload wiring, search bar, and double-click handler.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-integrated-markdown-viewer/21-CONTEXT.md
@.planning/phases/21-integrated-markdown-viewer/21-RESEARCH.md
@.planning/phases/21-integrated-markdown-viewer/21-01-SUMMARY.md

@src/main/ipc/dialog.ipc.js (existing IPC handlers for dialog operations)
@src/main/preload.js (existing dialog bridge ~lines 203-209)
@src/renderer/ui/components/TerminalManager.js (openFileTab markdown branch from Plan 21-01)
@src/renderer/ui/components/FileExplorer.js (lines 1090-1105: single-click handler, openFile function)

<interfaces>
<!-- From Plan 21-01 termData additions -->
termData.isMarkdown = true;
termData.mdViewMode = 'rendered' | 'source';
termData.mdRenderer = Marked instance;
termData.mdCleanup = null; // Set in THIS plan

<!-- From existing preload.js pattern -->
function createListener(channel) { ... }  // returns function(callback) that wires ipcRenderer.on

<!-- From existing dialog.ipc.js pattern -->
ipcMain.handle('select-folder', async () => { ... });
ipcMain.on('open-external', (event, url) => { ... });

<!-- From existing FileExplorer.js -->
function openFile(filePath) {
  if (callbacks.onOpenFile) callbacks.onOpenFile(filePath);
  else api.dialog.openInEditor({ editor: 'code', path: filePath });
}
// Single-click handler at line 1099-1103:
// selectFile(nodePath, e.ctrlKey, e.shiftKey);
// if (!e.ctrlKey && !e.shiftKey) openFile(nodePath);
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file watcher IPC handlers and preload bridge</name>
  <files>src/main/ipc/dialog.ipc.js, src/main/preload.js</files>
  <action>
  **In dialog.ipc.js:**

  1. Add `const fs = require('fs');` at the top if not already imported.

  2. Add a module-level Map for tracking active file watchers:
     ```javascript
     const fileWatchers = new Map(); // filePath -> { watcher: FSWatcher, refCount: number }
     ```

  3. Add two new IPC handlers inside the `module.exports = function(mainWindow)` function, alongside the existing handlers:
     ```javascript
     ipcMain.handle('watch-file', (event, filePath) => {
       if (fileWatchers.has(filePath)) {
         fileWatchers.get(filePath).refCount++;
         return;
       }
       try {
         const watcher = fs.watch(filePath, { persistent: false }, (eventType) => {
           if (eventType === 'change' || eventType === 'rename') {
             if (mainWindow && !mainWindow.isDestroyed()) {
               mainWindow.webContents.send('file-changed', filePath);
             }
           }
         });
         watcher.on('error', () => {
           // File may have been deleted or become inaccessible
           fileWatchers.delete(filePath);
         });
         fileWatchers.set(filePath, { watcher, refCount: 1 });
       } catch (e) {
         // Silently fail if file cannot be watched
       }
     });

     ipcMain.handle('unwatch-file', (event, filePath) => {
       const entry = fileWatchers.get(filePath);
       if (!entry) return;
       entry.refCount--;
       if (entry.refCount <= 0) {
         entry.watcher.close();
         fileWatchers.delete(filePath);
       }
     });
     ```

  **In preload.js:**

  1. Extend the `dialog` namespace (around line 203-209) with three new methods:
     ```javascript
     dialog: {
       selectFolder: () => ipcRenderer.invoke('select-folder'),
       selectFile: (params) => ipcRenderer.invoke('select-file', params),
       openInExplorer: (path) => ipcRenderer.send('open-in-explorer', path),
       openInEditor: (params) => ipcRenderer.send('open-in-editor', params),
       openExternal: (url) => ipcRenderer.send('open-external', url),
       watchFile: (filePath) => ipcRenderer.invoke('watch-file', filePath),
       unwatchFile: (filePath) => ipcRenderer.invoke('unwatch-file', filePath),
       onFileChanged: createListener('file-changed')
     },
     ```

  **IMPORTANT:** The `createListener` function (defined at line 69 of preload.js) creates a callback-based listener. This is the established pattern used by terminal.onData, webapp.onData, etc.
  </action>
  <verify>
    <automated>npm run build:renderer && npm test</automated>
  </verify>
  <done>
  - `watch-file` and `unwatch-file` IPC handlers exist in dialog.ipc.js
  - `dialog.watchFile`, `dialog.unwatchFile`, and `dialog.onFileChanged` exist in preload.js
  - File watcher uses `persistent: false` to not keep the process alive
  - Reference counting prevents premature close when multiple tabs watch the same file
  - Error handling prevents crashes on file deletion
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire live reload, Ctrl+F search, and double-click-to-editor</name>
  <files>src/renderer/ui/components/TerminalManager.js, src/renderer/ui/components/FileExplorer.js</files>
  <action>
  **In TerminalManager.js — extend the markdown branch in `openFileTab()`:**

  1. **Add file watcher and live reload** — after the event handlers block (after TOC toggle listener), add:
     ```javascript
     if (isMarkdown) {
       // ... (existing code from Plan 21-01: copy/link/toc handlers)

       // === File watcher for live reload ===
       let reloadTimer = null;
       const unsubscribeWatch = api.dialog.onFileChanged((changedPath) => {
         if (changedPath !== filePath) return;
         clearTimeout(reloadTimer);
         reloadTimer = setTimeout(() => {
           try {
             const newContent = fs.readFileSync(filePath, 'utf-8');
             const bodyEl = document.getElementById(`md-body-${id}`);
             if (!bodyEl) return;
             const scroll = bodyEl.scrollTop;
             bodyEl.innerHTML = mdRenderer.parse(newContent);
             bodyEl.scrollTop = scroll;
             // Update TOC
             const tocEl = document.getElementById(`md-toc-${id}`);
             if (tocEl) {
               const tocNav = tocEl.querySelector('.md-toc-nav');
               if (tocNav) {
                 const newTocHtml = buildMdToc(newContent);
                 if (newTocHtml) {
                   tocNav.outerHTML = newTocHtml;
                 }
               }
             }
             // Update source view
             const sourceEl = document.getElementById(`md-source-${id}`);
             if (sourceEl) {
               const sourceHighlighted = highlight(newContent, 'md');
               const sourceLines = newContent.split('\n');
               const lineNums = sourceLines.map((_, i) => `<span class="line-num">${i + 1}</span>`).join('\n');
               const linesEl = sourceEl.querySelector('.file-viewer-lines');
               const codeEl = sourceEl.querySelector('.file-viewer-code code');
               if (linesEl) linesEl.innerHTML = lineNums;
               if (codeEl) codeEl.innerHTML = sourceHighlighted;
             }
           } catch (e) { /* file temporarily unavailable during save */ }
         }, 300);
       });
       api.dialog.watchFile(filePath);

       // Store cleanup function on termData
       termData.mdCleanup = () => {
         unsubscribeWatch();
         api.dialog.unwatchFile(filePath);
         clearTimeout(reloadTimer);
       };

       // === Ctrl+F search bar ===
       // Insert search bar HTML into the md-viewer-content div (before the body)
       const contentEl = wrapper.querySelector('.md-viewer-content');
       const searchBarHtml = `
         <div class="md-viewer-search" id="md-search-${id}">
           <input type="text" placeholder="${t('mdViewer.searchPlaceholder')}" />
           <button class="md-search-close" title="Escape">
             <svg viewBox="0 0 12 12"><path d="M1 1l10 10M11 1L1 11" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
           </button>
         </div>`;
       contentEl.insertAdjacentHTML('afterbegin', searchBarHtml);

       const searchBar = document.getElementById(`md-search-${id}`);
       const searchInput = searchBar.querySelector('input');
       const searchClose = searchBar.querySelector('.md-search-close');

       // Ctrl+F handler on the wrapper
       wrapper.addEventListener('keydown', (e) => {
         if (e.ctrlKey && e.key === 'f') {
           e.preventDefault();
           e.stopPropagation();
           searchBar.classList.add('visible');
           searchInput.focus();
           searchInput.select();
         }
       });

       // Make wrapper focusable so it can receive keydown
       wrapper.setAttribute('tabindex', '-1');

       // Focus wrapper when tab is selected (so Ctrl+F works)
       // This is handled by setActiveTerminal — the wrapper just needs to be focusable

       searchInput.addEventListener('input', () => {
         const query = searchInput.value;
         if (query) {
           // Focus the body div first so window.find searches within it
           const bodyEl = document.getElementById(`md-body-${id}`);
           if (bodyEl && termData.mdViewMode === 'rendered') {
             window.find(query, false, false, true);
           }
         }
       });

       searchInput.addEventListener('keydown', (e) => {
         if (e.key === 'Enter') {
           e.preventDefault();
           window.find(searchInput.value, false, e.shiftKey, true);
         }
         if (e.key === 'Escape') {
           e.preventDefault();
           searchBar.classList.remove('visible');
           wrapper.focus();
         }
       });

       searchClose.addEventListener('click', () => {
         searchBar.classList.remove('visible');
         searchInput.value = '';
         wrapper.focus();
       });
     }
     ```

  **In FileExplorer.js — add double-click handler for .md files:**

  In the tree click handler (around line 1090-1105), the single-click logic is on `treeEl.onclick`. Add a `dblclick` handler for `.md` files that opens them in the external editor:

  Find the block that sets `treeEl.onclick` and after it (or after `treeEl.oncontextmenu`), add:
  ```javascript
  treeEl.ondblclick = (e) => {
    const node = e.target.closest('.fe-node');
    if (!node) return;
    const nodePath = node.dataset.path;
    const isDir = node.dataset.isDir === 'true';
    if (isDir) return; // Double-click on dirs already toggles folder

    const fileName = path.basename(nodePath);
    const ext = fileName.lastIndexOf('.') !== -1 ? fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase() : '';
    if (ext === 'md') {
      e.preventDefault();
      e.stopPropagation();
      api.dialog.openInEditor({ editor: getSetting('editor') || 'code', path: nodePath });
    }
  };
  ```

  **IMPORTANT:** Check if `getSetting` is already imported in FileExplorer.js. If not, add the import:
  ```javascript
  const { getSetting } = require('../../state/settings.state');
  ```

  If `getSetting` is not available, use the existing `callbacks` pattern or directly call `api.dialog.openInEditor({ editor: 'code', path: nodePath })` as a fallback.
  </action>
  <verify>
    <automated>npm run build:renderer && npm test</automated>
  </verify>
  <done>
  - File watcher starts when markdown tab opens and stops when tab closes
  - Editing a .md file in an external editor triggers automatic re-render in the preview
  - Scroll position is preserved during live reload
  - TOC and source view update on file change
  - Watcher callback is debounced at 300ms to handle multi-event saves
  - Ctrl+F opens search bar, Enter finds next, Shift+Enter finds previous, Escape closes
  - Double-clicking a .md file in the explorer opens it in the configured external editor
  - No watcher resource leaks on tab close (mdCleanup called in closeTerminal)
  </done>
</task>

</tasks>

<verification>
1. `npm run build:renderer` completes without errors
2. `npm test` passes (no regressions)
3. Grep confirms `watch-file` handler exists in dialog.ipc.js
4. Grep confirms `watchFile` and `onFileChanged` exist in preload.js
5. Grep confirms `onFileChanged` listener exists in TerminalManager.js
6. Grep confirms `md-viewer-search` search bar wiring in TerminalManager.js
7. Grep confirms `dblclick` handler exists in FileExplorer.js
</verification>

<success_criteria>
- Live reload: editing a .md file externally updates the preview without scroll position loss
- Search: Ctrl+F opens search bar, finds text, supports next/previous navigation
- Double-click: double-clicking .md in explorer opens in external editor
- Cleanup: closing a markdown tab stops the file watcher (no resource leak)
- No regression in existing file tab, chat, or terminal functionality
</success_criteria>

<output>
After completion, create `.planning/phases/21-integrated-markdown-viewer/21-02-SUMMARY.md`
</output>
