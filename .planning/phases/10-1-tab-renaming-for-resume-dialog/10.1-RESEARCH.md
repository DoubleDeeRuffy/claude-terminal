# Phase 19: 10.1 Tab-Renaming-For-Resume-Dialog - Research

**Researched:** 2026-02-26
**Domain:** Renderer data-merge (tab names → session dialog), CSS metadata theming
**Confidence:** HIGH

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

- Replace "Untitled conversation" with the saved tab name from app session data
- All naming sources feed into this: saved tab name (Phase 16), slash command rename (Phase 10), AI haiku naming (Phase 18)
- Sessions without a saved tab name fall back to the project name (current behavior) — NO, fall back to existing behavior (first prompt / summary / skill / "Untitled conversation")
- Session name styling stays untouched — no font/size changes, only replace the text content
- All 3 metadata elements (timestamp, branch, and any other info text) use the accent/theme color
- Merge Claude session files (source of truth for session ID, timestamps) with app's saved terminal session data (for tab names)
- Claude session files remain the primary/authoritative source
- Every tab rename triggers an immediate save to session data
- Resume dialog always shows the latest tab name, not stale data

### Claude's Discretion

None specified.

### Deferred Ideas (OUT OF SCOPE)

None — discussion stayed within phase scope
</user_constraints>

---

## Summary

Phase 19 fixes two cosmetic/data problems in the resume session dialog (opened via the Phase 14 lightbulb button or Ctrl+Shift+E):

1. **"Untitled conversation" fallback** — sessions that have a saved tab name (set by Phase 16, Phase 10 slash command, or Phase 18 AI haiku) should show that name instead of "Untitled conversation". The dialog currently has its own custom-name store (`session-names.json`, keyed by `sessionId`), but tab names from the terminal session service (`terminal-sessions.json`, keyed by project/tab index) are never written into it. The fix is to propagate tab names into `session-names.json` at rename time — specifically, in `updateTerminalTabName()`, whenever the terminal has a known `claudeSessionId`, write the name to `session-names.json` via `setSessionCustomName()`.

2. **Unreadable metadata** — `.session-meta-item` and `.session-meta-branch` use `color: var(--text-muted)` with `opacity: 0.6`, making them nearly invisible on dark backgrounds. The fix is a CSS change in `styles/projects.css` to use `var(--accent)` (for icons/SVGs) or `var(--text-secondary)` at full opacity for the text, improving readability without touching font/size.

**Primary recommendation:** In `updateTerminalTabName()`, add a call to `setSessionCustomName(td.claudeSessionId, name)` when `td.claudeSessionId` is set. In `styles/projects.css`, change `.session-meta-item` and `.session-meta-branch` color to `var(--accent)` or increase opacity.

---

## Architecture Patterns

### How Tab Names Currently Flow (Phase 16 / 18 / 10)

All three rename paths converge on `updateTerminalTabName(id, name)` in `TerminalManager.js`:

```js
// src/renderer/ui/components/TerminalManager.js ~line 1002
function updateTerminalTabName(id, name) {
  const termData = getTerminal(id);
  if (!termData) return;
  // ... slash-rename timestamp tracking ...
  updateTerminal(id, { name });  // updates in-memory state
  // ... updates DOM tab label ...
  const TerminalSessionService = require('../../services/TerminalSessionService');
  TerminalSessionService.saveTerminalSessions();  // debounced: persists name in terminal-sessions.json
}
```

For chat-mode tabs (ChatView), the `onTabRename` callback is:
```js
// src/renderer/ui/components/TerminalManager.js ~line 3475
onTabRename: (name) => {
  const nameEl = tab.querySelector('.tab-name');
  if (nameEl) nameEl.textContent = name;
  const data = getTerminal(id);
  if (data) data.name = name;  // updates in-memory state (no updateTerminalTabName call path)
  // ... remote PWA notify ...
  const TerminalSessionService = require('../../services/TerminalSessionService');
  TerminalSessionService.saveTerminalSessions();
},
```

**Note:** The chat-mode `onTabRename` handler does NOT call `updateTerminalTabName()` — it directly mutates state and saves. This means any propagation logic placed only in `updateTerminalTabName` will miss chat-mode renames.

### Data Stores Involved

| Store | File | Key | Set by | Read by |
|-------|------|-----|--------|---------|
| `terminal-sessions.json` | `~/.claude-terminal/terminal-sessions.json` | project ID → tab index → `{name, claudeSessionId}` | `TerminalSessionService.saveTerminalSessions()` | Session restore on startup |
| `session-names.json` | `~/.claude-terminal/session-names.json` | `sessionId` (UUID from Claude) | `setSessionCustomName(sessionId, name)` in TerminalManager.js | `getSessionCustomName(sessionId)` in `preprocessSessions()` |
| `session-pins.json` | `~/.claude-terminal/session-pins.json` | `sessionId` | Dialog pin button | `isSessionPinned()` in dialog |

The critical observation: **`session-names.json` is the lookup the resume dialog uses**. It is currently only written by the inline rename button inside the dialog itself (`startInlineRename` → `setSessionCustomName`). Tab names from TerminalSessionService are in `terminal-sessions.json` and never cross into `session-names.json`.

### The Linkage: `claudeSessionId`

Each terminal in state has a `claudeSessionId` field (populated by `wireSessionIdCapture` via hooks when a Claude session starts). This UUID is the same as the `sessionId` used in Claude session `.jsonl` files and in `session-names.json`. This is the bridge key:

```
terminal tab  →  td.claudeSessionId = "uuid-of-claude-session"
                                        ↕
session-names.json key = "uuid-of-claude-session" → display name in dialog
```

### Where to Hook the Propagation

Two rename paths must be covered:

**Path A — terminal-mode (OSC + slash command + input buffer)**
Flows through `updateTerminalTabName(id, name)` (TerminalManager.js line ~1002).

**Path B — chat-mode (AI haiku + ChatView onTabRename)**
Flows through the inline `onTabRename` callback in `createChatTerminal` (TerminalManager.js line ~3475).

**Simplest unified approach:** Add propagation logic to BOTH paths. The propagation guard is `td.claudeSessionId` — only write to `session-names.json` when a session ID is known.

For Path A (`updateTerminalTabName`):
```js
function updateTerminalTabName(id, name) {
  const termData = getTerminal(id);
  if (!termData) return;
  // ... existing slash-rename timestamp ...
  updateTerminal(id, { name });
  // ... existing DOM update ...
  // NEW: propagate to session-names.json if session ID is known
  if (termData.claudeSessionId) {
    setSessionCustomName(termData.claudeSessionId, name);
  }
  const TerminalSessionService = require('../../services/TerminalSessionService');
  TerminalSessionService.saveTerminalSessions();
}
```

For Path B (chat-mode `onTabRename`):
```js
onTabRename: (name) => {
  const nameEl = tab.querySelector('.tab-name');
  if (nameEl) nameEl.textContent = name;
  const data = getTerminal(id);
  if (data) data.name = name;
  // NEW: propagate to session-names.json
  if (_chatSessionId) {
    setSessionCustomName(_chatSessionId, name);
  }
  // ...remote PWA notify...
  const TerminalSessionService = require('../../services/TerminalSessionService');
  TerminalSessionService.saveTerminalSessions();
},
```

`_chatSessionId` is the closure variable already set by `onSessionStart` (line ~3472) — it's the real SDK session UUID.

### Session Data Loaded at Dialog Open

The dialog calls `api.claude.sessions(project.path)` which reads `.jsonl` files from `~/.claude/projects/{encoded-path}/`. Then `preprocessSessions()` merges in `getSessionCustomName(session.sessionId)` for each session. Since `setSessionCustomName` writes synchronously to `session-names.json`, any rename that happened before the dialog opens will appear immediately on the next dialog open. **No changes needed to the dialog's render logic** — the existing `getSessionCustomName` lookup already handles this.

### The "Immediate Save" Requirement

The context states: "Every tab rename triggers an immediate save to session data." The current `updateTerminalTabName` uses `saveTerminalSessions()` (debounced 2s) for `terminal-sessions.json`. For `session-names.json`, since `saveSessionNames()` is synchronous (a direct `fs.writeFileSync`), propagation is already immediate.

The `_namesCache` invalidation: after `setSessionCustomName` writes a new name, `_namesCache` is updated in-memory, so a subsequent `loadSessionNames()` call will use the cache. This is correct — the dialog uses `loadSessionNames()` (via `getSessionCustomName`) at render time, and the cache is fresh.

### CSS: Metadata Readability Fix

Current CSS for metadata elements (`styles/projects.css`):

```css
.session-meta-item {
  color: var(--text-muted);  /* #555 — very dark on dark bg */
  opacity: 0.6;              /* further dimmed to near-invisible */
}

.session-meta-branch {
  color: var(--text-muted);
  opacity: 0.7;
}
```

User decision: "All 3 metadata elements (timestamp, branch, and any other info text) use the accent/theme color."

The `--accent` variable is the user's chosen theme color (default `#d97706`, amber). Applying it to all metadata elements:

```css
.session-meta-item {
  color: var(--accent);
  opacity: 0.85;  /* or remove opacity for full accent brightness */
}
.session-meta-item svg {
  /* keep existing size rules; color inherits from parent */
  opacity: 1;  /* remove subdued SVG opacity */
}
.session-meta-branch {
  color: var(--accent);
  opacity: 0.85;
}
.session-meta-branch svg {
  opacity: 1;
}
```

Note: The background `var(--bg-tertiary)` on `.session-meta-branch` remains (it's a visual pill, not changed).

---

## Standard Stack

No new libraries needed. This phase is a pure in-process renderer change:

| Component | What changes | File |
|-----------|-------------|------|
| Tab name propagation | 2 call sites in TerminalManager.js | `src/renderer/ui/components/TerminalManager.js` |
| CSS metadata color | 4 rules in projects.css | `styles/projects.css` |

No IPC, no new state modules, no new files.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead |
|---------|-------------|-------------|
| Session name persistence | New file/storage | Existing `setSessionCustomName()` / `session-names.json` (already in TerminalManager.js) |
| Session ID lookup | New Map/index | Existing `td.claudeSessionId` field from terminals state |
| Dialog re-render | Force refresh | Dialog already reads from `session-names.json` at open; propagation is transparent |

---

## Common Pitfalls

### Pitfall 1: Missing the chat-mode rename path
**What goes wrong:** Only patching `updateTerminalTabName` misses chat-mode AI haiku renames (which go through `onTabRename` callback in `createChatTerminal`).
**How to avoid:** Patch BOTH `updateTerminalTabName` AND the `onTabRename` callback closure, using the appropriate session ID variable in each context (`termData.claudeSessionId` vs `_chatSessionId`).

### Pitfall 2: `_chatSessionId` may be null at rename time
**What goes wrong:** The first AI haiku name fires before `onSessionStart` has been called (before Claude actually starts the session), so `_chatSessionId` is null at the instant of the first rename.
**How to avoid:** Guard `if (_chatSessionId)` — if it's null, the name cannot be written to `session-names.json` (no session UUID to key on). This is acceptable; the second rename (async haiku result) fires later, by which time `_chatSessionId` is set. Any remaining gap is acceptable because the dialog is read at open time.

### Pitfall 3: `_namesCache` stale after external write
**What goes wrong:** `_namesCache` is a module-level singleton. If two tabs rename the same session concurrently (edge case), the second write overwrites the first. Not a real risk in practice — only one active tab per session UUID.
**How to avoid:** No special handling needed; existing cache pattern is correct.

### Pitfall 4: Applying accent color to branch pill background
**What goes wrong:** Accidentally changing `background: var(--bg-tertiary)` on `.session-meta-branch` to use accent color — makes it garish.
**How to avoid:** Only change `color` (text/icon), not `background`. The pill background stays `var(--bg-tertiary)`.

### Pitfall 5: Opacity stacking
**What goes wrong:** Parent `.session-card-meta` has no opacity but children have `opacity: 0.6/0.7`. Changing color without removing opacity leaves items still dim.
**How to avoid:** When switching to `var(--accent)`, also set `opacity: 1` (or remove the `opacity` declaration) so the full accent color shows.

---

## Code Examples

### Propagation in `updateTerminalTabName` (terminal-mode path)

```js
// src/renderer/ui/components/TerminalManager.js
function updateTerminalTabName(id, name) {
  const termData = getTerminal(id);
  if (!termData) return;

  if (name && name.startsWith('/')) {
    slashRenameTimestamps.set(id, Date.now());
  }

  updateTerminal(id, { name });

  const tab = document.querySelector(`.terminal-tab[data-id="${id}"]`);
  if (tab) {
    const nameSpan = tab.querySelector('.tab-name');
    if (nameSpan) nameSpan.textContent = name;
  }

  // Phase 19: propagate tab name to session-names.json (resume dialog)
  if (termData.claudeSessionId) {
    setSessionCustomName(termData.claudeSessionId, name);
  }

  const TerminalSessionService = require('../../services/TerminalSessionService');
  TerminalSessionService.saveTerminalSessions();
}
```

### Propagation in chat-mode `onTabRename` callback

```js
// src/renderer/ui/components/TerminalManager.js — inside createChatTerminal()
onTabRename: (name) => {
  const nameEl = tab.querySelector('.tab-name');
  if (nameEl) nameEl.textContent = name;
  const data = getTerminal(id);
  if (data) data.name = name;
  // Phase 19: propagate tab name to session-names.json (resume dialog)
  if (_chatSessionId) {
    setSessionCustomName(_chatSessionId, name);
  }
  if (_chatSessionId && api.remote?.notifyTabRenamed) {
    api.remote.notifyTabRenamed({ sessionId: _chatSessionId, tabName: name });
  }
  const TerminalSessionService = require('../../services/TerminalSessionService');
  TerminalSessionService.saveTerminalSessions();
},
```

### CSS metadata readability fix

```css
/* styles/projects.css */
.session-meta-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  color: var(--accent);   /* was: var(--text-muted) */
  opacity: 0.85;          /* was: 0.6 */
  white-space: nowrap;
}

.session-meta-item svg {
  width: 11px;
  height: 11px;
  max-width: 11px;
  max-height: 11px;
  flex-shrink: 0;
  opacity: 1;             /* was: 0.7 */
}

.session-meta-branch {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 10.5px;
  color: var(--accent);   /* was: var(--text-muted) */
  background: var(--bg-tertiary);   /* unchanged */
  padding: 2px 8px;
  border-radius: 6px;
  font-family: 'Cascadia Code', monospace;
  max-width: 140px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  opacity: 0.85;          /* was: 0.7 */
}

.session-meta-branch svg {
  width: 10px;
  height: 10px;
  max-width: 10px;
  max-height: 10px;
  opacity: 1;             /* was: 0.5 */
  flex-shrink: 0;
}
```

---

## Implementation Plan: 1 Plan, 2 Tasks

### Plan 10.1-01 (single plan, all changes)

**Task 1:** JavaScript — propagate tab names to `session-names.json`
- Modify `updateTerminalTabName()` in `TerminalManager.js` to call `setSessionCustomName(termData.claudeSessionId, name)` when `termData.claudeSessionId` is truthy
- Modify the `onTabRename` callback inside `createChatTerminal()` in the same file to call `setSessionCustomName(_chatSessionId, name)` when `_chatSessionId` is truthy
- Files: `src/renderer/ui/components/TerminalManager.js`

**Task 2:** CSS — metadata accent color
- In `styles/projects.css`, change `.session-meta-item` and `.session-meta-branch` (and their svg children) to use `var(--accent)` and full opacity
- Files: `styles/projects.css`

Both tasks can be in a single wave (no dependency between them).

---

## Open Questions

1. **Should clearing a tab name also clear from `session-names.json`?**
   - What we know: `setSessionCustomName(id, '')` already removes the key via `delete names[id]`. If a user resets a tab name, the dialog will fall back to its normal logic (first prompt / summary / "Untitled conversation").
   - Recommendation: Yes, clearing a tab name should propagate as a clear. Since `updateTerminalTabName` is called with the new name (empty string or default label), the guard `if (termData.claudeSessionId)` will still fire. However, clearing usually means reverting to the default tab label, not explicitly setting an empty string — so the propagation should only write a non-empty name. Guard: `if (termData.claudeSessionId && name)`.

2. **What happens if a tab is renamed before `claudeSessionId` is known?**
   - The first rename often fires very early (input buffer extraction before session starts). If `claudeSessionId` is null, propagation is silently skipped. When the session ID arrives (via hooks `SESSION_START`), there is no retroactive rename event. This means the dialog may miss the very first AI haiku name for new sessions where hooks are slow.
   - This is an acceptable edge case — subsequent renames (when `claudeSessionId` is populated) will propagate correctly. Addressing this would require a separate mechanism and is out of scope.

---

## Sources

### Primary (HIGH confidence)
- Direct source code inspection of `src/renderer/ui/components/TerminalManager.js` — `updateTerminalTabName`, `onTabRename`, `setSessionCustomName`, `_chatSessionId`, `session-names.json` storage pattern
- Direct source code inspection of `src/renderer/services/TerminalSessionService.js` — `claudeSessionId` field serialization
- Direct source code inspection of `styles/projects.css` — `.session-meta-item`, `.session-meta-branch` current CSS rules
- Direct source code inspection of `src/main/ipc/claude.ipc.js` — `getClaudeSessions()` return shape including `sessionId`

### Secondary (MEDIUM confidence)
- N/A — all findings are from direct codebase inspection

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — no new libraries, pure in-codebase change
- Architecture: HIGH — data flow verified by direct code reading; claudeSessionId bridge confirmed
- Pitfalls: HIGH — identified from code structure (two rename paths, null chatSessionId timing)

**Research date:** 2026-02-26
**Valid until:** 2026-03-28 (stable domain, no external dependencies)
