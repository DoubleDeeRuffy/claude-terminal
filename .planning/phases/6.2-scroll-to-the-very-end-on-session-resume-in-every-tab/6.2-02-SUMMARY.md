---
phase: 6.2-scroll-to-the-very-end-on-session-resume-in-every-tab
plan: 02
subsystem: ui
tags: [terminal, scroll, race-condition, session-restore, xterm]

# Dependency graph
requires:
  - phase: 6.2-01
    provides: Initial 200ms scroll attempt and loading->ready scrollToBottom baseline
provides:
  - scheduleScrollAfterRestore(id) in TerminalManager — silence-based polling scroll for restored terminals
  - Race-condition-free scroll after PTY replay completes (300ms silence or 8s hard fallback)
affects: [6.3-remember-active-task, any future terminal restore work]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Silence-based scroll detection via lastTerminalData polling (setInterval 50ms, 300ms silence threshold, 8s hard fallback)
    - Per-terminal independent polling instead of shared global timeout

key-files:
  created: []
  modified:
    - src/renderer/ui/components/TerminalManager.js
    - renderer.js

key-decisions:
  - "6.2-02: scheduleScrollAfterRestore polls lastTerminalData (already maintained per terminal) at 50ms intervals — 300ms silence means PTY replay done"
  - "6.2-02: 8s hard fallback ensures scroll fires even for very large session histories"
  - "6.2-02: Per-terminal polling (not a shared timer) means each tab scrolls independently when its own data stream quiets"
  - "6.2-02: TerminalManager.scheduleScrollAfterRestore(id) used directly in renderer.js since TerminalManager already imported as full object"
  - "6.2-02: Null guard (getTerminal returns null if terminal already closed) causes poller to self-clear — no memory leak on early tab close"

patterns-established:
  - "Silence-based scroll detection: poll lastTerminalData Map (id -> timestamp) at 50ms, scroll when silentFor >= SILENCE_MS or timedOut"

requirements-completed: [SESS-01]

# Metrics
duration: 8min
completed: 2026-02-26
---

# Phase 6.2 Plan 02: Silence-Based Scroll After Session Restore Summary

**scheduleScrollAfterRestore function polling lastTerminalData for 300ms PTY silence eliminates both race conditions in post-restore scrollToBottom**

## Performance

- **Duration:** ~8 min
- **Started:** 2026-02-26T17:28:00Z
- **Completed:** 2026-02-26T17:36:20Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Added `scheduleScrollAfterRestore(id)` to TerminalManager.js — polls the existing `lastTerminalData` Map at 50ms intervals, scrolls when 300ms of silence is detected or 8s hard fallback fires
- Replaced the premature `scrollToBottom()` in the `loading->ready` branch of `updateTerminalStatus` with `scheduleScrollAfterRestore(id)` — eliminates Race 2 (OSC title fires before earlier IPC batches flushed to xterm)
- Replaced the shared `setTimeout(200)` post-restore block in renderer.js with per-terminal `TerminalManager.scheduleScrollAfterRestore(id)` calls — eliminates Race 1 (fixed timer fires before unbounded PTY replay data has arrived)
- Exported `scheduleScrollAfterRestore` from TerminalManager module

## Task Commits

Each task was committed atomically:

1. **Task 1: Add scheduleScrollAfterRestore to TerminalManager and replace premature scroll in updateTerminalStatus** - `0a843c42` (feat)
2. **Task 2: Replace fixed setTimeout(200) in renderer.js with per-tab scheduleScrollAfterRestore calls** - `81127286` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified
- `src/renderer/ui/components/TerminalManager.js` - Added scheduleScrollAfterRestore function (definition + export), replaced immediate scrollToBottom in loading->ready with scheduleScrollAfterRestore call
- `renderer.js` - Replaced shared setTimeout(200) scroll block with per-terminal scheduleScrollAfterRestore calls

## Decisions Made
- `scheduleScrollAfterRestore` polls the existing `lastTerminalData` Map (already maintained per terminal by the adaptive batcher) — no new state needed
- 300ms silence threshold chosen as reliable proxy for "PTY replay done" — the adaptive batcher flushes in 4-32ms batches, so 300ms silence means no data in-flight
- 8s hard fallback ensures scroll always fires even for sessions with very large history (thousands of lines)
- `TerminalManager.scheduleScrollAfterRestore(id)` called directly in renderer.js using the existing `TerminalManager` import — no additional require needed
- Null guard inside the poller (`getTerminal(id)` returns null on closed tab) causes the interval to self-clear, preventing memory leaks

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Both scroll race conditions resolved — restored terminals and resumed Claude sessions scroll to bottom after data is actually silent
- Chat-mode tabs are unaffected (null terminal guard exits poller early for tabs without an xterm.js terminal)
- Phase 6.3 (active tab persistence) already complete and unaffected by these changes

## Self-Check: PASSED

- FOUND: src/renderer/ui/components/TerminalManager.js
- FOUND: renderer.js
- FOUND: 6.2-02-SUMMARY.md
- FOUND: commit 0a843c42 (Task 1)
- FOUND: commit 81127286 (Task 2)
- scheduleScrollAfterRestore appears 3 times in TerminalManager.js (definition, call-site, export)
- No setTimeout(200) scroll block in renderer.js
- No bare scrollToBottom in loading->ready branch

---
*Phase: 6.2-scroll-to-the-very-end-on-session-resume-in-every-tab*
*Completed: 2026-02-26*
