# Phase 6.2: Scroll to Bottom on Session Resume — Research

**Researched:** 2026-02-26
**Domain:** xterm.js scroll API + Electron renderer startup lifecycle
**Confidence:** HIGH

## Summary

When the app restores terminal sessions at startup (Phase 4/6 code in `renderer.js`), xterm.js terminals are created and data is streamed asynchronously from the PTY. Because `createTerminal` returns before any output has been written, there is no moment where an unconditional `scrollToBottom()` call made immediately after creation will land at the actual bottom — the data hasn't arrived yet.

The correct fix requires scrolling to bottom *after* data has been written to the xterm buffer. xterm.js provides the native `terminal.scrollToBottom()` method (confirmed in `@xterm/xterm` typings). The two distinct scenarios needing coverage are: (1) resumed Claude sessions (`resumeSessionId` set) which replay session history, meaning significant buffered output arrives before the prompt — scroll must be deferred until output stops or reaches "ready" state; and (2) basic/fresh terminals which emit little to no startup output — a single `scrollToBottom()` call shortly after the `fitAddon.fit()` is sufficient.

For chat-mode tabs (`mode === 'chat'`), no PTY is involved. ChatView already calls `scrollToBottom()` extensively on every message append, so chat tabs have no scroll problem to fix. The fix is scoped entirely to xterm.js PTY-backed terminal tabs.

**Primary recommendation:** After the restore loop completes in `renderer.js`, call `terminal.scrollToBottom()` on all restored terminals with a short delay (100–200ms after fit) to handle the simple case. For resumed sessions that receive large output bursts, hook `dismissLoadingOverlay` (which fires when loading→ready/working status transition occurs) to scroll to bottom at that exact moment — this ensures scroll happens after the session replay output has been written.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| `@xterm/xterm` | ^6.0.0 | Terminal emulator with `scrollToBottom()` method | Already used in project — no new dep needed |
| `@xterm/addon-fit` | ^0.11.0 | Fit terminal to container | Already used — fit must precede scroll |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| Native `setTimeout` / `requestAnimationFrame` | — | Defer scroll until after layout | Use for simple case after fit |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| `terminal.scrollToBottom()` | Manual viewport `scrollTop` manipulation | Never — xterm.js renders in a canvas/WebGL layer, DOM scrollTop is irrelevant |
| Delay-based scroll | `terminal.onData` callback | onData fires per chunk, would scroll 100s of times during replay — debouncing needed |
| `dismissLoadingOverlay` hook point | `onRender` event | `dismissLoadingOverlay` is already the status-transition point, cleaner and already in the right place |

## Architecture Patterns

### Recommended Project Structure

No structural changes — the fix lives in two existing locations:
```
renderer.js                                         # Post-restore scroll call
src/renderer/ui/components/TerminalManager.js       # dismissLoadingOverlay hook for resumed sessions
```

### Pattern 1: Simple Post-Restore Scroll (all non-resumed tabs)

**What:** After the restore loop creates all tabs and calls `filterByProject`, iterate over all restored terminal IDs and call `scrollToBottom()` with a small delay to let the fit + initial output settle.

**When to use:** All restored tabs, especially basic terminals and fresh Claude terminals (no `resumeSessionId`).

**Where:** In `renderer.js`, immediately after the `TerminalManager.filterByProject(idx)` call that ends the restore block.

```javascript
// Source: renderer.js restore block (lines 220–226), after filterByProject
setTimeout(() => {
  const terminals = terminalsState.get().terminals;
  terminals.forEach((td, id) => {
    if (td.terminal && typeof td.terminal.scrollToBottom === 'function') {
      td.terminal.scrollToBottom();
    }
  });
}, 200);
```

The 200ms delay gives `fitAddon.fit()` (which runs at +100ms inside `createTerminal`) time to complete before scroll is issued. xterm.js `scrollToBottom()` is a synchronous call — no async complications.

### Pattern 2: Post-Output Scroll for Resumed Sessions

**What:** Claude sessions with `resumeSessionId` replay session history. That output can be large and arrives asynchronously over 1–10 seconds. The `updateTerminalStatus` function already detects `loading → ready/working` transition and calls `dismissLoadingOverlay`. We call `scrollToBottom()` at the moment the loading overlay is dismissed.

**When to use:** Only for resumed terminal tabs (those with `resumeSessionId` that were created during the restore loop).

**Where:** Inside `dismissLoadingOverlay` in `TerminalManager.js` — or, preferably, inside the `updateTerminalStatus` function at the `loading → ready/working` branch where `dismissLoadingOverlay` is already called.

```javascript
// Source: TerminalManager.js updateTerminalStatus (line 1062)
if (previousStatus === 'loading' && (status === 'ready' || status === 'working')) {
  dismissLoadingOverlay(id);
  // ... existing safety timeout cleanup ...

  // Scroll to bottom now that session replay output has been written
  const td = getTerminal(id);
  if (td && td.terminal && typeof td.terminal.scrollToBottom === 'function') {
    td.terminal.scrollToBottom();
  }
}
```

This fires exactly once per terminal, at the moment Claude has written enough output that the loading overlay is dismissed — perfect timing for scroll.

### Anti-Patterns to Avoid

- **Scrolling inside `terminal.onData` callback:** Fires many times per second during session replay. Would need debouncing and still might not land at the final bottom.
- **Scrolling immediately in `createTerminal` after `terminal.open()`:** The xterm viewport has no content yet; `scrollToBottom()` at this point is a no-op.
- **Using DOM `scrollTop` on any xterm container element:** xterm.js renders via canvas/WebGL — the scrollable content is internal to xterm, not a DOM scrollable container. Only `terminal.scrollToBottom()` works.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Scroll position tracking | Custom scroll position save/restore | `terminal.scrollToBottom()` | xterm handles internal viewport; no position to save/restore |
| Output completion detection | Custom regex scan of terminal buffer | Use existing `loading → ready/working` status transition | Already built and battle-tested in Phase 4/6 |
| Deferred scroll queue | Custom async queue | Simple `setTimeout(200)` | The fit delay already exists at 100ms; 200ms covers it |

## Common Pitfalls

### Pitfall 1: Scrolling before `fitAddon.fit()` completes

**What goes wrong:** `fitAddon.fit()` is called via `setTimeout(..., 100)` inside `createTerminal`. If `scrollToBottom()` is called before that resolves, the viewport dimensions may not be set correctly, causing the scroll position to be recalculated by the fit and landing somewhere unexpected.

**Why it happens:** Both fit and scroll are setTimeout-deferred; ordering depends on call sequence.

**How to avoid:** Use `setTimeout(200)` for the post-restore scroll — this fires after the 100ms fit timers from all `createTerminal` calls have fired.

**Warning signs:** Scroll appears to work in fast machines but not on slow ones (race condition).

### Pitfall 2: Forgetting non-active tabs

**What goes wrong:** Only the active tab is visible when the restore completes. But ALL restored tabs exist in the DOM and should scroll to bottom — including tabs for the active project (non-active tabs) and all other projects' tabs.

**Why it happens:** `setActiveTerminal` only manipulates the currently visible tab. It doesn't scroll others.

**How to avoid:** Iterate `terminalsState.get().terminals` (all terminals, not just active) in the post-restore scroll setTimeout.

**Warning signs:** Users report that switching to a non-active restored tab shows a mid-session scroll position.

### Pitfall 3: Chat-mode tabs don't have `terminal` object

**What goes wrong:** Chat-mode tabs (`td.mode === 'chat'`) have `td.terminal = null` after `createChatTerminal` runs (line 3546 sets terminal: null). Calling `td.terminal.scrollToBottom()` will throw.

**Why it happens:** `createChatTerminal` replaces the xterm terminal with a ChatView component.

**How to avoid:** Guard with `td.terminal && typeof td.terminal.scrollToBottom === 'function'` before calling.

**Warning signs:** JS error: `Cannot read properties of null (reading 'scrollToBottom')`.

### Pitfall 4: Calling `scrollToBottom()` in `dismissLoadingOverlay` vs `updateTerminalStatus`

**What goes wrong:** If placed inside `dismissLoadingOverlay`, it fires for ALL overlay dismissals including non-restore ones (e.g., the first time Claude starts fresh on a new tab). This is actually fine — a scroll to bottom when Claude first becomes ready is a reasonable UX — but be aware it's broader scope.

**Why it happens:** `dismissLoadingOverlay` is called from `updateTerminalStatus` (the main path) AND from the 30s safety timeout.

**How to avoid:** Either accept the broader behavior (scroll on every loading→ready for any terminal) or gate the scroll with a flag set only during the restore loop (similar to `_skipExplorerCapture` pattern from Phase 5).

**Recommendation:** Accept the broader behavior — scrolling to bottom when Claude first becomes ready is universally correct UX, not just during restore.

## Code Examples

Verified patterns from official sources:

### xterm.js scrollToBottom API (from typings)
```typescript
// Source: node_modules/@xterm/xterm/typings/xterm.d.ts line 1227
/**
 * Scrolls the display of the terminal to the bottom.
 */
scrollToBottom(): void;
```

### Existing fit timing pattern (from TerminalManager.js)
```javascript
// Source: TerminalManager.js line 1454 — already used 100ms delay for fit
setTimeout(() => fitAddon.fit(), 100);
```

### Existing loading→ready scroll hook point (from TerminalManager.js)
```javascript
// Source: TerminalManager.js lines 1062–1068
if (previousStatus === 'loading' && (status === 'ready' || status === 'working')) {
  dismissLoadingOverlay(id);
  const safetyTimeout = loadingTimeouts.get(id);
  if (safetyTimeout) {
    clearTimeout(safetyTimeout);
    loadingTimeouts.delete(id);
  }
}
// >>> ADD scrollToBottom() HERE <<<
```

### Post-restore loop location in renderer.js
```javascript
// Source: renderer.js lines 220–226
if (sessionData.lastOpenedProjectId) {
  const idx = projects.findIndex(p => p.id === sessionData.lastOpenedProjectId);
  if (idx !== -1) {
    setSelectedProjectFilter(idx);
    TerminalManager.filterByProject(idx);
  }
}
// >>> ADD setTimeout(200) scroll-all loop AFTER THIS BLOCK <<<
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| No scroll on restore | scroll after fit delay | This phase | All tabs show most recent output |
| loading overlay dismissed without scroll | Dismiss + scrollToBottom | This phase | Resumed session lands at prompt, not history start |

## Open Questions

1. **Should scroll-on-loading-dismissed apply to ALL terminals (not just restored ones)?**
   - What we know: The `updateTerminalStatus` loading→ready path fires for every new terminal, not just restored ones.
   - What's unclear: Is scrolling to bottom when a fresh terminal first becomes ready ever unwanted?
   - Recommendation: Accept broader behavior — it's the correct default for any terminal. Simpler code, no flag needed.

2. **What about the `_skipExplorerCapture` flag pattern — should we use a similar `_restoringSession` flag?**
   - What we know: Phase 5.1 used a flag to guard against side effects during the restore loop.
   - What's unclear: Whether a narrower guard is needed to avoid scroll-on-ready for non-restore new terminals.
   - Recommendation: No flag needed. Scroll on every loading→ready is correct universal behavior.

## Sources

### Primary (HIGH confidence)
- `node_modules/@xterm/xterm/typings/xterm.d.ts` lines 1224–1227 — `scrollToBottom()` method confirmed
- `src/renderer/ui/components/TerminalManager.js` lines 1030–1070 — `dismissLoadingOverlay` and `updateTerminalStatus` logic confirmed
- `renderer.js` lines 179–230 — full restore loop confirmed
- `src/renderer/services/TerminalSessionService.js` — session data structure confirmed (tabs, claudeSessionId, mode, name)

### Secondary (MEDIUM confidence)
- Codebase pattern: `setTimeout(..., 100)` for fit already established (TerminalManager.js line 1454) — 200ms safe extension

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — `scrollToBottom()` is in shipped typings, already in project
- Architecture: HIGH — all hook points identified in actual source code
- Pitfalls: HIGH — all pitfalls derived from direct code inspection

**Research date:** 2026-02-26
**Valid until:** 2026-03-28 (stable codebase section)
