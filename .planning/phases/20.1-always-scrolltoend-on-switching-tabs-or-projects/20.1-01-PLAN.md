---
phase: 20.1-always-scrolltoend-on-switching-tabs-or-projects
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/ui/components/TerminalManager.js
  - src/renderer/ui/panels/SettingsPanel.js
  - src/renderer/i18n/locales/en.json
  - src/renderer/i18n/locales/fr.json
autonomous: true
requirements: []

must_haves:
  truths:
    - "Switching terminal tabs scrolls xterm to the bottom automatically"
    - "Switching projects scrolls the newly active xterm tab to the bottom automatically"
    - "Chat tabs do NOT auto-scroll on switch (only xterm tabs)"
    - "User can disable auto-scroll-on-switch via a toggle in Terminal settings group"
    - "Setting defaults to enabled (safe upgrade path with !== false guard)"
    - "Toggle takes effect immediately without reload (call-time getSetting read)"
  artifacts:
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "scrollToBottom call in setActiveTerminal for xterm tabs, gated by getSetting"
    - path: "src/renderer/ui/panels/SettingsPanel.js"
      provides: "autoScrollOnSwitch toggle in Terminal settings group"
    - path: "src/renderer/i18n/locales/en.json"
      provides: "i18n keys for autoScrollOnSwitch label and description"
    - path: "src/renderer/i18n/locales/fr.json"
      provides: "French i18n keys for autoScrollOnSwitch label and description"
  key_links:
    - from: "TerminalManager.js setActiveTerminal"
      to: "xterm terminal.scrollToBottom()"
      via: "getSetting('autoScrollOnSwitch') !== false guard"
      pattern: "getSetting.*autoScrollOnSwitch.*scrollToBottom"
    - from: "SettingsPanel.js"
      to: "settings.autoScrollOnSwitch"
      via: "toggle checkbox wired to saveSetting"
      pattern: "auto-scroll-on-switch-toggle"
---

<objective>
Add auto-scroll-to-bottom behavior when switching terminal tabs or projects, with a settings toggle.

Purpose: Users always see the latest terminal output when navigating between tabs/projects, matching native terminal UX expectations.
Output: Modified TerminalManager.js (scroll logic), SettingsPanel.js (toggle), en.json/fr.json (i18n keys)
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20.1-always-scrolltoend-on-switching-tabs-or-projects/20.1-CONTEXT.md

<interfaces>
<!-- Key interfaces the executor needs from TerminalManager.js -->

From src/renderer/ui/components/TerminalManager.js (setActiveTerminal, lines ~1182-1265):
- `setActiveTerminal(id)` — main function for tab switching
- At line ~1216-1226: after setting active state and toggling DOM classes, checks `termData.mode`:
  - `'chat'` → focuses chat input (NO scroll here per user decision)
  - else if not `'file'` → calls `termData.fitAddon.fit()` and `termData.terminal.focus()`
- `termData.terminal.scrollToBottom()` is the xterm API (used in `scheduleScrollAfterRestore`)
- `getSetting` is already imported at line ~30 from state

From src/renderer/ui/panels/SettingsPanel.js (Terminal group, lines ~731-755):
- Terminal group starts at line 731: `<div class="settings-group-title">${t('settings.terminalGroup')}</div>`
- Currently contains only the idle timeout dropdown
- Toggle pattern used throughout: `<div class="settings-toggle-row">` with label, desc, and `<label class="settings-toggle"><input type="checkbox" ...>`

From src/renderer/ui/components/TerminalManager.js (filterByProject, line ~2297):
- `filterByProject` calls `setActiveTerminal(targetId)` at line 2297 when switching projects
- The scroll-to-bottom will fire through `setActiveTerminal` — no separate hook needed in filterByProject
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scrollToBottom call in setActiveTerminal and settings toggle wiring</name>
  <files>
    src/renderer/ui/components/TerminalManager.js
    src/renderer/ui/panels/SettingsPanel.js
  </files>
  <action>
**TerminalManager.js — Add auto-scroll in setActiveTerminal:**

In the `setActiveTerminal(id)` function, after the existing `termData.fitAddon.fit()` and `termData.terminal.focus()` calls (around line 1224-1225), add a scroll-to-bottom call for xterm tabs only, gated by the setting:

```javascript
// After termData.fitAddon.fit(); and termData.terminal.focus();
// Auto-scroll to bottom on tab/project switch (Phase 20.1)
if (getSetting('autoScrollOnSwitch') !== false) {
  termData.terminal.scrollToBottom();
}
```

This goes inside the `else if (termData.type !== 'file')` block, right after `termData.terminal.focus()`. The `!== false` guard means undefined/missing defaults to enabled (safe upgrade path). The `getSetting` call-time read means toggling the setting takes effect on the next switch without restart.

Do NOT add scroll logic to `filterByProject` — it already calls `setActiveTerminal(targetId)` which will trigger the scroll.

Do NOT add scroll for chat tabs — the `mode === 'chat'` branch is a separate `if` that focuses chat input only. Per user decision, chat tabs keep their scroll position as-is.

**Remove scroll position save/restore for xterm tabs (Phase 20 conflict):**

The `setActiveTerminal` function currently saves the outgoing terminal's `viewportY` (lines ~1197-1199) and restores it on incoming (lines ~1240-1256 for the non-chat branch). Since Phase 20.1 always scrolls to bottom on switch, the xterm viewportY save/restore is now dead code for terminal tabs. However, the **chat tab scroll save/restore must be preserved** (it saves `scrollTop` for `.chat-messages`).

Modify the scroll restore block (around line 1240-1256): Keep the chat scroll restore path but skip the xterm viewportY restore when `autoScrollOnSwitch` is enabled. The simplest approach: in the `else if` branch (non-chat), only restore viewportY when the setting is disabled:

```javascript
// In the scroll restore block:
} else if (termData.terminal?.buffer?.active && saved.viewportY !== undefined) {
  // Only restore xterm scroll position if auto-scroll-on-switch is disabled
  if (getSetting('autoScrollOnSwitch') === false) {
    const delta = saved.viewportY - termData.terminal.buffer.active.viewportY;
    if (delta !== 0) termData.terminal.scrollLines(delta);
  }
}
```

The xterm scrollToBottom added above will override anyway, but this avoids a visible flicker from restore-then-scroll.

**SettingsPanel.js — Add toggle in Terminal settings group:**

In the Terminal settings group (after line ~731, inside the `<div class="settings-card">`), add a toggle row BEFORE the existing idle timeout dropdown row. Use the standard toggle pattern:

```javascript
<div class="settings-toggle-row">
  <div class="settings-toggle-label">
    <div>${t('settings.autoScrollOnSwitch')}</div>
    <div class="settings-toggle-desc">${t('settings.autoScrollOnSwitchDesc')}</div>
  </div>
  <label class="settings-toggle">
    <input type="checkbox" id="auto-scroll-on-switch-toggle" ${settings.autoScrollOnSwitch !== false ? 'checked' : ''}>
    <span class="settings-toggle-slider"></span>
  </label>
</div>
```

Note the `!== false` default for the checked attribute — matches the runtime guard.

Wire the change event in the settings panel's event wiring section. Find the pattern used by other toggles (e.g., `hooks-enabled-toggle`) and add:

```javascript
document.getElementById('auto-scroll-on-switch-toggle')?.addEventListener('change', (e) => {
  saveSetting('autoScrollOnSwitch', e.target.checked);
});
```
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && npx grep -c "autoScrollOnSwitch" src/renderer/ui/components/TerminalManager.js src/renderer/ui/panels/SettingsPanel.js | grep -v ":0$"</automated>
    Verify: TerminalManager.js contains `getSetting('autoScrollOnSwitch')` guard and `scrollToBottom()` call. SettingsPanel.js contains toggle with id `auto-scroll-on-switch-toggle` and `saveSetting('autoScrollOnSwitch', ...)`.
  </verify>
  <done>
    - setActiveTerminal scrolls xterm tabs to bottom when autoScrollOnSwitch !== false
    - Chat tabs are NOT scrolled (only xterm branch affected)
    - xterm viewportY restore skipped when autoScrollOnSwitch is enabled (no flicker)
    - Settings panel has toggle in Terminal group, defaults to checked
    - Toggle wired to saveSetting, takes effect immediately on next switch
  </done>
</task>

<task type="auto">
  <name>Task 2: Add i18n keys for autoScrollOnSwitch setting</name>
  <files>
    src/renderer/i18n/locales/en.json
    src/renderer/i18n/locales/fr.json
  </files>
  <action>
**en.json — Add keys in the settings section** (near the other terminal settings keys, around line 605-610):

```json
"autoScrollOnSwitch": "Auto-scroll to bottom on tab switch",
"autoScrollOnSwitchDesc": "Automatically scroll terminals to the latest output when switching tabs or projects",
```

**fr.json — Add French translations** (in the corresponding location):

```json
"autoScrollOnSwitch": "Défilement auto vers le bas au changement d'onglet",
"autoScrollOnSwitchDesc": "Défiler automatiquement les terminaux vers la dernière sortie lors du changement d'onglet ou de projet",
```

Both keys go under the `"settings"` object, near the existing `terminalGroup`, `idleTimeout` keys.
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && node -e "const en=require('./src/renderer/i18n/locales/en.json'); const fr=require('./src/renderer/i18n/locales/fr.json'); console.log('en:', !!en.settings.autoScrollOnSwitch, !!en.settings.autoScrollOnSwitchDesc); console.log('fr:', !!fr.settings.autoScrollOnSwitch, !!fr.settings.autoScrollOnSwitchDesc);"</automated>
    Both locale files have autoScrollOnSwitch and autoScrollOnSwitchDesc keys under settings.
  </verify>
  <done>
    - en.json has autoScrollOnSwitch and autoScrollOnSwitchDesc keys with English text
    - fr.json has autoScrollOnSwitch and autoScrollOnSwitchDesc keys with French text using proper UTF-8 characters
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes (no regressions)
2. `npm run build:renderer` succeeds (bundle compiles)
3. grep confirms `scrollToBottom` appears in setActiveTerminal's non-chat branch
4. grep confirms `autoScrollOnSwitch` appears in TerminalManager.js, SettingsPanel.js, en.json, fr.json
5. grep confirms `auto-scroll-on-switch-toggle` appears in SettingsPanel.js
</verification>

<success_criteria>
- Switching xterm terminal tabs scrolls to bottom automatically (not chat tabs)
- Switching projects scrolls the active xterm tab to bottom via filterByProject → setActiveTerminal chain
- Settings panel shows toggle under Terminal group, defaulting to enabled
- Toggle takes effect immediately without app restart
- `npm test` and `npm run build:renderer` pass
</success_criteria>

<output>
After completion, create `.planning/phases/20.1-always-scrolltoend-on-switching-tabs-or-projects/20.1-01-SUMMARY.md`
</output>
