# Phase 6.1: Bugfix — Save NewSessionId after Clear for Restore - Context

**Gathered:** 2026-02-25
**Status:** Ready for planning

<domain>
## Phase Boundary

Fix the bug where running `/clear` in a Claude terminal creates a new session with a new ID, but the stored session ID is not updated. On app restart, restore resumes the old (pre-clear) session instead of the current one. The fix must work correctly with multiple Claude terminal tabs per project.

</domain>

<decisions>
## Implementation Decisions

### Session ID capture timing
- Update stored session ID on SESSION_START event from hooks provider
- Overwrite the old session ID completely — no history, no fallback
- Force an immediate save to disk after updating (don't rely on debounced save) — prevents data loss on crash
- Guard against null/undefined session IDs — only update if new ID is truthy (matches Phase 6 decision: guard on e.source === 'hooks')

### Tab-scoped matching
- Each terminal tab tracks its own claudeSessionId independently (per-tab, not per-project)
- Improve on the existing findClaudeTerminalForProject heuristic (latest-terminal-ID) — instead track which Claude tab was **last active** (focused/received input) per project
- When SESSION_START fires, match it to the last-active Claude tab for that project
- This ensures /clear in one tab doesn't overwrite the session ID of another tab in the same project

### Multi-clear behavior
- Latest always wins — each /clear overwrites the previous session ID
- On restart, resume the most recent session (the one after the last /clear)
- No special "don't resume after clear" logic — /clear starts a new session, that new session is the one to resume

### Claude's Discretion
- Exact mechanism for tracking "last active tab" (focus event, input event, or combination)
- Whether to use ClaudeEventBus events or direct terminal focus tracking
- Internal data structure for the last-active-tab lookup

</decisions>

<specifics>
## Specific Ideas

- User explicitly mentioned having multiple Claude tabs open — the fix must be multi-tab safe
- The existing Phase 6 wireSessionIdCapture already handles initial session ID capture — this fix extends that to handle /clear mid-session

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 6.1-bugfix-save-newsessionid-after-clear-for-restore-to-restore-the-correct-session-not-an-old-one*
*Context gathered: 2026-02-25*
