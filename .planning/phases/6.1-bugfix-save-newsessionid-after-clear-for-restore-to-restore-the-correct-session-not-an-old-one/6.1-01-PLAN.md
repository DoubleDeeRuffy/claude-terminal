---
phase: 6.1-bugfix-save-newsessionid-after-clear-for-restore-to-restore-the-correct-session-not-an-old-one
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/services/TerminalSessionService.js
  - src/renderer/events/index.js
  - src/renderer/ui/components/TerminalManager.js
autonomous: true
requirements: []
must_haves:
  truths:
    - "Running /clear in a Claude terminal updates the stored session ID to the new session"
    - "On app restart after /clear, the terminal resumes the post-clear session (not the old one)"
    - "With multiple Claude tabs for the same project, /clear in one tab only updates that tab's session ID"
    - "Session ID is written to disk immediately after capture (crash-resilient)"
  artifacts:
    - path: "src/renderer/services/TerminalSessionService.js"
      provides: "saveTerminalSessionsImmediate export"
      contains: "saveTerminalSessionsImmediate"
    - path: "src/renderer/events/index.js"
      provides: "lastActiveClaudeTab Map and notifyTabActivated export"
      contains: "lastActiveClaudeTab"
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "notifyTabActivated call in setActiveTerminal"
      contains: "notifyTabActivated"
  key_links:
    - from: "src/renderer/ui/components/TerminalManager.js"
      to: "src/renderer/events/index.js"
      via: "lazy require calling notifyTabActivated on tab focus"
      pattern: "events\\.notifyTabActivated"
    - from: "src/renderer/events/index.js"
      to: "src/renderer/services/TerminalSessionService.js"
      via: "saveTerminalSessionsImmediate call in wireSessionIdCapture"
      pattern: "saveTerminalSessionsImmediate"
---

<objective>
Fix the bug where running `/clear` in a Claude terminal creates a new session but the stored session ID is not updated, causing app restart to resume the old (pre-clear) session instead of the current one.

Purpose: After `/clear`, the new session ID must be captured and saved immediately so that app restart resumes the correct (post-clear) session. Multi-tab scenarios must update only the tab where `/clear` was executed.

Output: Three files patched — TerminalSessionService exports immediate save, events/index.js uses last-active-tab tracking instead of latest-ID heuristic, TerminalManager reports tab activations.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/6.1-bugfix-save-newsessionid-after-clear-for-restore-to-restore-the-correct-session-not-an-old-one/6.1-CONTEXT.md
@.planning/phases/6.1-bugfix-save-newsessionid-after-clear-for-restore-to-restore-the-correct-session-not-an-old-one/6.1-RESEARCH.md
@src/renderer/services/TerminalSessionService.js
@src/renderer/events/index.js
@src/renderer/ui/components/TerminalManager.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export saveTerminalSessionsImmediate and add last-active-tab tracking with fixed wireSessionIdCapture</name>
  <files>src/renderer/services/TerminalSessionService.js, src/renderer/events/index.js</files>
  <action>
**TerminalSessionService.js — export immediate save:**
Add `saveTerminalSessionsImmediate` to the `module.exports` object. The function already exists (line ~75), it just needs to be exported. Do NOT change any logic.

**events/index.js — add last-active-tab tracking:**
1. Near the top of the file alongside other module-level state (`toolStats`, `sessionContext`), add:
   ```javascript
   const lastActiveClaudeTab = new Map(); // projectId -> terminalId
   ```

2. Add a new function `notifyTabActivated(projectId, terminalId)` that sets the entry in the Map. Guard: only set if `projectId` is truthy and `terminalId` is not undefined/null.

3. Export `notifyTabActivated` from `module.exports`.

**events/index.js — fix wireSessionIdCapture:**
4. In `wireSessionIdCapture()`, replace the line:
   ```javascript
   const terminalId = findClaudeTerminalForProject(e.projectId);
   ```
   with:
   ```javascript
   const terminalId = lastActiveClaudeTab.get(e.projectId) ?? findClaudeTerminalForProject(e.projectId);
   ```
   Keep `findClaudeTerminalForProject` as fallback for single-tab/startup edge cases.

5. Replace the debounced save call:
   ```javascript
   TerminalSessionService.saveTerminalSessions();
   ```
   with the immediate version:
   ```javascript
   TerminalSessionService.saveTerminalSessionsImmediate();
   ```

6. Update the console.debug message to indicate `(last-active)` source.

Keep ALL existing guards intact: `e.source !== 'hooks'`, `!e.data?.sessionId`, `!e.projectId`.
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && node -e "const m = require('./src/renderer/services/TerminalSessionService'); if (typeof m.saveTerminalSessionsImmediate !== 'function') throw new Error('not exported');" && echo "PASS: saveTerminalSessionsImmediate exported" && node -e "const e = require('./src/renderer/events'); if (typeof e.notifyTabActivated !== 'function') throw new Error('not exported'); console.log('PASS: notifyTabActivated exported');"</automated>
    <manual>Verify lastActiveClaudeTab Map exists in events/index.js and wireSessionIdCapture uses it with fallback</manual>
  </verify>
  <done>saveTerminalSessionsImmediate is exported from TerminalSessionService; events/index.js has lastActiveClaudeTab Map, notifyTabActivated export, and wireSessionIdCapture uses last-active-tab lookup with immediate save</done>
</task>

<task type="auto">
  <name>Task 2: Hook setActiveTerminal in TerminalManager to report last-active Claude tab</name>
  <files>src/renderer/ui/components/TerminalManager.js</files>
  <action>
In TerminalManager.js, find the `setActiveTerminal(id)` function. After the `setActiveTerminalState(id)` call, add a block that:

1. Gets the terminal data via `getTerminal(id)`
2. Checks if it's a Claude terminal: `termData.project?.id && termData.mode === 'terminal' && !termData.isBasic`
3. If so, lazy-requires `../../events` (following Phase 4/6 lazy require pattern to avoid circular deps) and calls `events.notifyTabActivated(termData.project.id, id)`
4. Wrap in try/catch — empty catch with comment `/* events module not ready */`

This MUST use lazy require (inside the function body), NOT a top-level static require. The `events/index.js` module lazy-requires TerminalManager, so a static require in the other direction would create a circular dependency at load time.

Do NOT modify any other behavior in setActiveTerminal.
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && node -e "const fs = require('fs'); const src = fs.readFileSync('src/renderer/ui/components/TerminalManager.js', 'utf8'); if (!src.includes('notifyTabActivated')) throw new Error('notifyTabActivated not found in TerminalManager'); if (!src.includes('require') && src.includes('notifyTabActivated')) throw new Error('missing require'); console.log('PASS: TerminalManager hooks notifyTabActivated');"</automated>
    <manual>Verify the lazy require is inside the function body (not top-level) and wrapped in try/catch</manual>
  </verify>
  <done>setActiveTerminal calls notifyTabActivated via lazy require for Claude terminal tabs; existing terminal switching behavior is unchanged</done>
</task>

</tasks>

<verification>
1. `saveTerminalSessionsImmediate` is exported from TerminalSessionService (node require test)
2. `notifyTabActivated` is exported from events/index.js (node require test)
3. `lastActiveClaudeTab` Map exists in events/index.js (grep)
4. `wireSessionIdCapture` uses `lastActiveClaudeTab.get(e.projectId)` with `findClaudeTerminalForProject` fallback (grep)
5. `wireSessionIdCapture` calls `saveTerminalSessionsImmediate()` not `saveTerminalSessions()` (grep)
6. TerminalManager.js contains `notifyTabActivated` call inside `setActiveTerminal` (grep)
7. The lazy require in TerminalManager is inside a function body, not at module top-level (visual inspection)
8. Build succeeds: `npm run build:renderer`
</verification>

<success_criteria>
- The three source files are patched with minimal, surgical changes
- No new dependencies or files introduced
- Existing guards (hooks source check, truthy sessionId, projectId) remain intact
- Lazy require pattern used to avoid circular dependencies
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/6.1-bugfix-save-newsessionid-after-clear-for-restore-to-restore-the-correct-session-not-an-old-one/6.1-01-SUMMARY.md`
</output>
