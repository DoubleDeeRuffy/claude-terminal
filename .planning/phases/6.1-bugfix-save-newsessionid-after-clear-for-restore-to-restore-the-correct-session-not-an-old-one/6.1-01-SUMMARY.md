---
phase: 6.1-bugfix-save-newsessionid-after-clear-for-restore-to-restore-the-correct-session-not-an-old-one
plan: "01"
subsystem: session-persistence
tags: [bugfix, session-id, multi-tab, hooks, events]
dependency_graph:
  requires: []
  provides: [correct-session-resume-after-clear]
  affects: [events/index.js, TerminalSessionService.js, TerminalManager.js]
tech_stack:
  added: []
  patterns: [lazy-require-circular-dep-avoidance, immediate-write-crash-resilience]
key_files:
  created: []
  modified:
    - src/renderer/services/TerminalSessionService.js
    - src/renderer/events/index.js
    - src/renderer/ui/components/TerminalManager.js
decisions:
  - "lastActiveClaudeTab Map in events/index.js tracks focused tab per project — eliminates latest-ID heuristic ambiguity for multi-tab setups"
  - "saveTerminalSessionsImmediate() replaces debounced saveTerminalSessions() in wireSessionIdCapture — ensures /clear new session ID is on disk before crash"
  - "Lazy require pattern in TerminalManager.setActiveTerminal avoids circular dep with events/index.js"
metrics:
  duration: ~8 minutes
  completed: 2026-02-25
  tasks_completed: 2
  files_modified: 3
---

# Phase 6.1 Plan 01: Fix /clear New Session ID Not Saved Summary

**One-liner:** Immediate-write session ID capture with last-active-tab routing replaces debounced heuristic, fixing post-/clear restart resuming the wrong session.

## What Was Built

Fixed the bug where running `/clear` in a Claude terminal creates a new session but the stored session ID is not updated, causing app restart to resume the old (pre-clear) session.

Three surgical changes across three files:

1. **`TerminalSessionService.js`** — exported `saveTerminalSessionsImmediate` so the events module can call it directly (previously only `saveTerminalSessions` was in `module.exports`).

2. **`events/index.js`** — added `lastActiveClaudeTab` Map (projectId -> terminalId) at module level, added `notifyTabActivated()` function and export, and updated `wireSessionIdCapture` to use the Map for terminal lookup (with `findClaudeTerminalForProject` as fallback) and to call `saveTerminalSessionsImmediate()` instead of the debounced `saveTerminalSessions()`.

3. **`TerminalManager.js`** — added a lazy-require block inside `setActiveTerminal()` that calls `events.notifyTabActivated(project.id, id)` whenever a non-basic terminal-mode tab is focused. Wrapped in try/catch with lazy require to avoid circular dependencies.

## Tasks Completed

| Task | Name | Commit | Files |
|------|------|--------|-------|
| 1 | Export saveTerminalSessionsImmediate and add last-active-tab tracking | d45c8d5 | TerminalSessionService.js, events/index.js |
| 2 | Hook setActiveTerminal to report last-active Claude tab | b293d80 | TerminalManager.js |

## Verification

All 7 plan verification points confirmed:
1. `saveTerminalSessionsImmediate` exported from TerminalSessionService (line 178)
2. `notifyTabActivated` exported from events/index.js (line 525)
3. `lastActiveClaudeTab` Map declared at module level (line 27)
4. `wireSessionIdCapture` uses `lastActiveClaudeTab.get(e.projectId) ?? findClaudeTerminalForProject(e.projectId)` (line 372)
5. `wireSessionIdCapture` calls `saveTerminalSessionsImmediate()` not `saveTerminalSessions()` (line 381)
6. TerminalManager.js calls `events.notifyTabActivated()` (line 1157)
7. Lazy require is inside function body at line 1156 (function starts at 1138)
8. Build passes: `npm run build:renderer` — "Build complete: dist/renderer.bundle.js"
9. Tests pass: 262/262 tests pass

## Deviations from Plan

None - plan executed exactly as written.

## Decisions Made

- **lastActiveClaudeTab over heuristic:** The existing `findClaudeTerminalForProject` used a "latest terminal ID" heuristic which fails in multi-tab scenarios. The new Map tracks the actual focused tab, so when `/clear` creates a new session and SESSION_START fires, it routes to the tab that ran `/clear`.

- **Immediate write over debounced:** The old code used a 300ms debounce before writing to disk. If the app crashed within that window after a /clear, the session ID would be lost. `saveTerminalSessionsImmediate()` writes synchronously (temp file + rename, crash-resilient), ensuring the new session ID is always persisted before any crash can occur.

- **Lazy require in TerminalManager:** `events/index.js` already lazy-requires `TerminalManager` for status updates. Adding a static require in the opposite direction would create a circular dependency at module load time. The lazy require inside `setActiveTerminal`'s function body follows the established Phase 4/6 pattern.

## Self-Check: PASSED

- `src/renderer/services/TerminalSessionService.js` — modified, saveTerminalSessionsImmediate exported
- `src/renderer/events/index.js` — modified, lastActiveClaudeTab Map, notifyTabActivated, wireSessionIdCapture patched
- `src/renderer/ui/components/TerminalManager.js` — modified, notifyTabActivated call in setActiveTerminal
- Commits d45c8d5 and b293d80 exist in git log
