# Phase 1.1: Dotfile Visibility Setting — Research

**Researched:** 2026-02-25
**Domain:** Settings state management + FileExplorer filtering + SettingsPanel UI
**Confidence:** HIGH

## Summary

Phase 1.1 re-introduces the dotfile filter that Phase 1 removed, but now as a user-configurable setting rather than a hard-coded rule. The implementation is entirely self-contained within the existing renderer codebase: a new boolean key in `settings.state.js`, a new "Explorer" group in `SettingsPanel.js`, and a runtime filter applied in `FileExplorer.js` at both the tree-render and search-index paths.

No new dependencies are required. The existing patterns for settings toggles, save handlers, and i18n keys are well-established and can be replicated exactly. The risk is low: two touch points in FileExplorer (tree and search), one settings key, one UI group with one toggle, and four i18n keys (EN + FR).

**Primary recommendation:** Add `showDotfiles: true` to `defaultSettings`, add a `.settings-toggle-row` block inside a new `settings-group` in the General tab HTML, read `getSetting('showDotfiles')` at call-time in both `readDirectoryAsync` and `collectAllFiles`, and add it to `saveSettingsHandler`. The toggle must be read at call-time (not cached at module load) so changes take effect immediately without reopening the project.

## Standard Stack

### Core

| Component | Location | Purpose |
|-----------|----------|---------|
| `settings.state.js` | `src/renderer/state/settings.state.js` | Stores `showDotfiles` boolean, provides `getSetting()` |
| `FileExplorer.js` | `src/renderer/ui/components/FileExplorer.js` | Tree and search reads — dotfile filter applied here |
| `SettingsPanel.js` | `src/renderer/ui/panels/SettingsPanel.js` | Renders toggle in General tab, collects in `saveSettingsHandler` |
| `en.json` / `fr.json` | `src/renderer/i18n/locales/` | Two i18n keys per locale |

### No New Dependencies

No npm installs needed. No new files. Pure configuration wiring across existing modules.

## Architecture Patterns

### Pattern 1: Settings Key + Default

**File:** `src/renderer/state/settings.state.js`

Add to `defaultSettings` object (line ~36 area):

```js
showDotfiles: true,   // Show dotfiles/dotfolders in file explorer (enabled by default)
```

The `loadSettings()` function merges saved data over defaults via `{ ...defaultSettings, ...saved }`, so new users get `true` and existing users who never toggled it also get `true` (safe default behavior).

No deep-merge is needed (unlike `terminalShortcuts`) because `showDotfiles` is a flat boolean.

### Pattern 2: UI Toggle in Settings General Tab

**File:** `src/renderer/ui/panels/SettingsPanel.js`

There is currently no "Explorer" group in the General tab. Looking at the existing pattern, a new group is inserted after an existing `</div>` closing a `settings-group`. The System group (lines ~413-535) already contains multiple toggles using `.settings-toggle-row` inside `.settings-card`. The new Explorer group follows the exact same pattern:

```html
<div class="settings-group">
  <div class="settings-group-title">${t('settings.explorerGroup')}</div>
  <div class="settings-card">
    <div class="settings-toggle-row">
      <div class="settings-toggle-label">
        <div>${t('settings.showDotfiles')}</div>
        <div class="settings-toggle-desc">${t('settings.showDotfilesDesc')}</div>
      </div>
      <label class="settings-toggle">
        <input type="checkbox" id="show-dotfiles-toggle" ${settings.showDotfiles !== false ? 'checked' : ''}>
        <span class="settings-toggle-slider"></span>
      </label>
    </div>
  </div>
</div>
```

The `!== false` pattern (not `=== true`) is used for all default-enabled toggles in this codebase (see `compactProjects`, `terminalContextMenu`, `updateTitleOnProjectSwitch`, `aiCommitMessages`). This ensures undefined/missing keys default to enabled — safe upgrade behavior for existing settings files.

### Pattern 3: Collecting Toggle in saveSettingsHandler

**File:** `src/renderer/ui/panels/SettingsPanel.js`, `saveSettingsHandler()` function (~line 1070)

Following the established pattern — read the DOM element, extract `.checked`, include in `newSettings`:

```js
const showDotfilesToggle = document.getElementById('show-dotfiles-toggle');
const newShowDotfiles = showDotfilesToggle ? showDotfilesToggle.checked : true;
```

Then add to `newSettings` object:

```js
showDotfiles: newShowDotfiles,
```

The autoSave event listener at line 1179 (`container.querySelectorAll('.settings-toggle input, .settings-select').forEach(el => el.addEventListener('change', autoSave))`) will automatically wire the new checkbox because it uses class `.settings-toggle` on the wrapper `<label>`.

### Pattern 4: Filter in FileExplorer — Read at Call-Time

**File:** `src/renderer/ui/components/FileExplorer.js`

There are **two** places where entries are listed and need dotfile filtering:

1. **`readDirectoryAsync(dirPath)`** — lines ~240-290, the tree view path
2. **`collectAllFiles(dirPath, maxFiles)`** — lines ~377-403, the search indexer path

In both functions, `getSetting` must be imported from settings state and called inside the function body (not cached at module level), so the setting takes effect immediately when toggled without needing to close/reopen the project.

The dotfile check is: `name.startsWith('.')`. This is the standard definition — files and folders whose names start with a dot.

**For `readDirectoryAsync`** — add inside the `for (const name of names)` loop, after the `IGNORE_PATTERNS.has(name)` check:

```js
// Check dotfile visibility setting (read at call-time for immediate effect)
const { getSetting } = require('../../state/settings.state');
if (!getSetting('showDotfiles') && name.startsWith('.')) continue;
```

Note: The require should be hoisted outside the loop (inside the function) for performance, but must remain inside the function to avoid module-load-time evaluation.

**For `collectAllFiles`** — same pattern, inside the `for (const name of names)` loop after the `IGNORE_PATTERNS.has(name)` check:

```js
const { getSetting } = require('../../state/settings.state');
if (!getSetting('showDotfiles') && name.startsWith('.')) continue;
```

The circular dependency risk is the same as `_triggerSave()` in FileExplorer which already lazy-requires `TerminalSessionService`. The `getSetting` function from `settings.state.js` has no dependency on `FileExplorer.js`, so there is no circular dependency concern here.

**Important:** The require call inside the function is fine because esbuild bundles everything into a single IIFE. The `require()` calls in the renderer are synchronous module-cache lookups after bundling — no I/O. Reading `getSetting` at call-time ensures the toggle takes immediate effect without any re-render or project reload.

### Pattern 5: i18n Key Naming Convention

Existing settings keys in `en.json` follow this structure under `"settings"`:
- Group title: `explorerGroup` → "Explorer"
- Toggle label: `showDotfiles` → "Show dotfiles"
- Toggle description: `showDotfilesDesc` → descriptive string

French (`fr.json`) must be updated simultaneously. The project convention requires both files updated together.

```json
// en.json — under "settings"
"explorerGroup": "Explorer",
"showDotfiles": "Show dotfiles",
"showDotfilesDesc": "Show hidden files and folders (starting with a dot) in the file explorer"
```

```json
// fr.json — under "settings"
"explorerGroup": "Explorateur",
"showDotfiles": "Afficher les dotfiles",
"showDotfilesDesc": "Afficher les fichiers et dossiers cachés (commençant par un point) dans l'explorateur de fichiers"
```

## Don't Hand-Roll

| Problem | Don't Build | Use Instead |
|---------|-------------|-------------|
| Persistent toggle state | Custom storage | `setSetting()` / `getSetting()` from `settings.state.js` — already debounced, atomic writes |
| Instant toggle effect | Re-init FileExplorer on save | Read `getSetting()` at call-time inside `readDirectoryAsync` and `collectAllFiles` |
| UI toggle wiring | Custom event listeners | The existing `.settings-toggle input` change listener fires `autoSave` automatically |

## Common Pitfalls

### Pitfall 1: Caching getSetting at Module Level
**What goes wrong:** `const showDotfiles = getSetting('showDotfiles')` at the top of `FileExplorer.js` captures the value at bundle-load time. Toggle changes never take effect.
**Why it happens:** Module-level variables are initialized once.
**How to avoid:** Call `getSetting('showDotfiles')` inside `readDirectoryAsync` and `collectAllFiles` bodies (not at top-level scope).
**Warning signs:** Toggle saves successfully but tree doesn't change until project is reopened.

### Pitfall 2: Forgetting the !== false Pattern
**What goes wrong:** Using `settings.showDotfiles === true` or `settings.showDotfiles ? 'checked' : ''` in the HTML template — existing settings files without the key will evaluate to falsy and hide dotfiles for all users on upgrade.
**Why it happens:** JavaScript treats `undefined` as falsy.
**How to avoid:** Use `settings.showDotfiles !== false ? 'checked' : ''` — matches the established pattern for all other default-enabled toggles in this codebase.
**Warning sign:** Users who upgrade and haven't changed the setting find dotfiles suddenly hidden.

### Pitfall 3: Only Filtering One Path
**What goes wrong:** Filtering `readDirectoryAsync` but not `collectAllFiles`. Tree hides dotfiles, but search still returns them.
**Why it happens:** The two code paths are separate — search uses `collectAllFiles`, tree uses `readDirectoryAsync`.
**How to avoid:** Update both functions. Verify with a search for ".claude" or ".git" with toggle off.

### Pitfall 4: Missing French Translation
**What goes wrong:** Keys exist in `en.json` but not `fr.json`. Users on French locale see raw key strings as labels.
**Why it happens:** Forgetting to update both locale files.
**How to avoid:** Always update both files in the same commit.

### Pitfall 5: saveSettingsHandler Does Not Persist the Setting
**What goes wrong:** The toggle is rendered and saves visually, but `showDotfiles` is not included in `newSettings` inside `saveSettingsHandler`, so `ctx.settingsState.set(newSettings)` overwrites the saved setting with `undefined`.
**Why it happens:** `saveSettingsHandler` explicitly constructs `newSettings` — new keys must be added manually.
**How to avoid:** Add `showDotfiles: newShowDotfiles` to the `newSettings` object alongside the other toggles.

## Code Examples

### Complete Filter Block in readDirectoryAsync

```js
// Source: FileExplorer.js readDirectoryAsync (line ~248 area)
async function readDirectoryAsync(dirPath) {
  try {
    const exists = await fs.promises.access(dirPath).then(() => true).catch(() => false);
    if (!exists) return [];

    const names = await fs.promises.readdir(dirPath);
    const result = [];
    let skipped = 0;
    const { getSetting } = require('../../state/settings.state');  // lazy require — safe, no circular dep
    const showDotfiles = getSetting('showDotfiles');                // read at call-time

    for (const name of names) {
      if (IGNORE_PATTERNS.has(name)) continue;
      if (!showDotfiles && name.startsWith('.')) continue;          // dotfile filter

      if (result.length >= MAX_DISPLAY_ENTRIES) {
        skipped++;
        continue;
      }
      // ... rest unchanged
    }
```

### Complete Filter Block in collectAllFiles

```js
// Source: FileExplorer.js collectAllFiles (line ~381 area)
async function collectAllFiles(dirPath, maxFiles = 5000) {
  const results = [];
  const queue = [dirPath];
  const { getSetting } = require('../../state/settings.state');  // lazy require
  const showDotfiles = getSetting('showDotfiles');               // read at call-time

  while (queue.length > 0 && results.length < maxFiles) {
    const dir = queue.shift();
    try {
      const names = await fs.promises.readdir(dir);
      for (const name of names) {
        if (IGNORE_PATTERNS.has(name)) continue;
        if (!showDotfiles && name.startsWith('.')) continue;     // dotfile filter

        const fullPath = path.join(dir, name);
        // ... rest unchanged
      }
    } catch (e) { /* skip */ }
  }
  return results;
}
```

Note: `getSetting` can be hoisted outside the while-loop but must stay inside the function. The value is captured once per call to the function — this is intentional. If the user toggles mid-search, the next search invocation will pick up the new value. This is acceptable UX.

## Implementation Checklist

The complete change set for this phase:

1. **`src/renderer/state/settings.state.js`**
   - Add `showDotfiles: true` to `defaultSettings`

2. **`src/renderer/ui/components/FileExplorer.js`**
   - In `readDirectoryAsync`: lazy-require `getSetting`, add dotfile skip after IGNORE_PATTERNS check
   - In `collectAllFiles`: same — lazy-require `getSetting`, add dotfile skip after IGNORE_PATTERNS check

3. **`src/renderer/ui/panels/SettingsPanel.js`**
   - In General tab HTML: add new `settings-group` div with "Explorer" title and `show-dotfiles-toggle` checkbox, inserted after the Quick Action Presets group (before closing `</div>` of the general panel)
   - In `saveSettingsHandler`: read `show-dotfiles-toggle` element, add `showDotfiles: newShowDotfiles` to `newSettings`

4. **`src/renderer/i18n/locales/en.json`**
   - Add `explorerGroup`, `showDotfiles`, `showDotfilesDesc` under `"settings"`

5. **`src/renderer/i18n/locales/fr.json`**
   - Add same three keys in French

6. **Build**
   - `npm run build:renderer` (required after any renderer file change)

## Open Questions

1. **Where exactly to insert the Explorer group in the General tab?**
   - The General tab currently has: Appearance → System → Quick Action Presets
   - Explorer fits logically after System (before Quick Action Presets) since it's a behavioral setting, not a preset
   - Recommendation: Insert after the System group, before Quick Action Presets

2. **Should the render re-trigger when the toggle changes?**
   - Currently SettingsPanel's `autoSave` fires on checkbox change, saves to state, but FileExplorer's open folder is NOT automatically re-rendered
   - The user would need to collapse/expand a folder or switch projects to see the change take effect
   - Acceptable for v1: dotfile filtering is a rare change; no live-refresh is needed
   - If live refresh is desired: call `FileExplorer.render()` inside `saveSettingsHandler` — but this requires exporting `render` from FileExplorer (currently not exported)

## Sources

### Primary (HIGH confidence)
- Direct codebase inspection of `src/renderer/state/settings.state.js` — `defaultSettings` shape, `getSetting`, merge pattern
- Direct codebase inspection of `src/renderer/ui/components/FileExplorer.js` — `readDirectoryAsync`, `collectAllFiles`, `IGNORE_PATTERNS`, existing lazy-require pattern in `_triggerSave`
- Direct codebase inspection of `src/renderer/ui/panels/SettingsPanel.js` — full `renderSettingsTab` HTML template, `saveSettingsHandler` construction, `autoSave` wiring
- Direct codebase inspection of `src/renderer/i18n/locales/en.json` — key naming conventions under `"settings"`

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — all changes are within existing well-understood modules
- Architecture: HIGH — follows established patterns exactly (6+ prior toggles to reference)
- Pitfalls: HIGH — identified from reading the actual codebase, not speculation

**Research date:** 2026-02-25
**Valid until:** Stable (this codebase moves intentionally, changes would be visible)
