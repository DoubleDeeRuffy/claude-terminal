---
phase: 23-remember-last-active-tab-on-tab-closing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/ui/components/TerminalManager.js
autonomous: true
requirements: []
must_haves:
  truths:
    - "Closing a tab switches to the previously-active tab within the same project, not the first tab in insertion order"
    - "Closing all tabs except one in a project correctly switches to that remaining tab"
    - "Closing the only tab for a project shows the sessions panel (existing behavior preserved)"
    - "All tab types (terminal, chat, file/markdown) participate in activation history equally"
    - "History is per-project — closing a tab in Project A never switches to a tab in Project B"
  artifacts:
    - path: "src/renderer/ui/components/TerminalManager.js"
      provides: "tabActivationHistory Map, history push in setActiveTerminal, walk-back in closeTerminal"
      contains: "tabActivationHistory"
  key_links:
    - from: "setActiveTerminal()"
      to: "tabActivationHistory"
      via: "push on every tab activation"
      pattern: "tabActivationHistory\\.get.*\\.push"
    - from: "closeTerminal()"
      to: "tabActivationHistory"
      via: "walk-back to find previous active tab"
      pattern: "tabActivationHistory\\.get.*closedProjectId"
---

<objective>
Add per-project tab activation history stack to TerminalManager.js so that closing a tab switches to the previously-active tab (browser-like behavior) instead of the first same-project tab found by insertion order.

Purpose: Match browser tab-close UX -- closing a tab returns you to where you were before, not an arbitrary tab.
Output: Modified TerminalManager.js with `tabActivationHistory` Map, push in setActiveTerminal, walk-back + prune in closeTerminal.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/renderer/ui/components/TerminalManager.js

<interfaces>
<!-- Key structures the executor needs from TerminalManager.js -->

Module-level Maps (lines 160-164):
```js
const lastActivePerProject = new Map();  // projectId -> terminalId (Phase 20)
const savedScrollPositions = new Map();  // terminalId -> scroll state
```

setActiveTerminal (line 1240-1243) - where lastActivePerProject is updated:
```js
// Record this terminal as last-active for its project
if (newProjectId) {
  lastActivePerProject.set(newProjectId, id);
}
```

closeTerminal (lines 1312-1394) - key variables at top:
```js
const closedProjectIndex = termData?.projectIndex;
const closedProjectPath = termData?.project?.path;
const closedProjectId = termData?.project?.id;
```

closeTerminal fallback scan (lines 1362-1371) - the code to replace:
```js
// Find another terminal from the same project
let sameProjectTerminalId = null;
const terminals = terminalsState.get().terminals;
if (closedProjectPath) {
  terminals.forEach((td, termId) => {
    if (!sameProjectTerminalId && td.project?.path === closedProjectPath) {
      sameProjectTerminalId = termId;
    }
  });
}
```

getTerminal(id) returns null for removed terminals - established stale-ID guard pattern.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tabActivationHistory Map and push in setActiveTerminal</name>
  <files>src/renderer/ui/components/TerminalManager.js</files>
  <action>
1. Declare `tabActivationHistory` Map at module level, immediately after the `lastActivePerProject` declaration (after line 162):

```js
// ── Per-project activation history stack (Phase 23 — browser-like tab-close behavior) ──
// Map<projectId, number[]> — most-recently-activated tab ID is the last element
const tabActivationHistory = new Map();
```

2. In `setActiveTerminal()`, immediately after the `lastActivePerProject.set(newProjectId, id)` line (after line 1242), add the history push:

```js
// Append to per-project activation history (Phase 23 — browser-like tab-close)
if (!tabActivationHistory.has(newProjectId)) {
  tabActivationHistory.set(newProjectId, []);
}
tabActivationHistory.get(newProjectId).push(id);
```

This goes inside the existing `if (newProjectId)` guard block, after the `lastActivePerProject.set` call. Do NOT modify the `lastActivePerProject.set` line — add the new code after it.

IMPORTANT: Do NOT add any cleanup of tabActivationHistory in the closeTerminal cleanup section (lines 1338-1340). Follow the same pattern as lastActivePerProject — stale IDs are handled by getTerminal() null-check during walk-back.
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && grep -n "tabActivationHistory" src/renderer/ui/components/TerminalManager.js | head -20</automated>
  </verify>
  <done>tabActivationHistory Map declared at module level; every setActiveTerminal call pushes the activated tab ID into the per-project history array</done>
</task>

<task type="auto">
  <name>Task 2: Replace forEach scan in closeTerminal with history walk-back and neighbor fallback</name>
  <files>src/renderer/ui/components/TerminalManager.js</files>
  <action>
In `closeTerminal()`, replace the block at lines 1362-1371 (the "Find another terminal from the same project" section) with the history walk-back + neighbor fallback. The replacement should be:

```js
// Walk back activation history to find the previously-active tab (Phase 23)
let sameProjectTerminalId = null;
if (closedProjectId) {
  const history = tabActivationHistory.get(closedProjectId);
  if (history) {
    // Walk from most-recent backward; skip the closed tab and already-removed tabs
    for (let i = history.length - 1; i >= 0; i--) {
      const candidateId = history[i];
      if (candidateId === id) continue;
      if (!getTerminal(candidateId)) continue;
      sameProjectTerminalId = candidateId;
      break;
    }

    // Prune closed tab from history to keep the array clean
    const pruned = history.filter(hId => hId !== id);
    if (pruned.length === 0) {
      tabActivationHistory.delete(closedProjectId);
    } else {
      tabActivationHistory.set(closedProjectId, pruned);
    }
  }
}

// Fallback: nearest neighbor in tab strip (if history exhausted or not yet populated)
if (!sameProjectTerminalId && closedProjectPath) {
  const terminals = terminalsState.get().terminals;
  terminals.forEach((td, termId) => {
    if (!sameProjectTerminalId && td.project?.path === closedProjectPath) {
      sameProjectTerminalId = termId;
    }
  });
}
```

Key points:
- The walk-back runs AFTER `removeTerminal(id)` has been called (lines 1349, 1353, 1357), so getTerminal(id) returns null for the closed tab — the `candidateId === id` check is belt-and-suspenders
- Pruning happens AFTER the walk-back reads the array, so the walk-back sees the full history
- The neighbor fallback (forEach scan) is the ORIGINAL code, kept as a safety net for edge cases where history is empty (e.g., tabs created before Phase 23 code was running)
- Everything after this replacement (lines 1373-1394: stopProject, setActiveTerminal, filterByProject, etc.) stays EXACTLY as-is
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && npm run build:renderer 2>&1 | tail -5 && npm test 2>&1 | tail -10</automated>
  </verify>
  <done>closeTerminal walks back activation history to find the previously-active tab; falls back to nearest neighbor if history is empty; all existing behavior (sessions panel on last tab close, time tracking stop, filterByProject) preserved unchanged</done>
</task>

</tasks>

<verification>
1. `grep -c "tabActivationHistory" src/renderer/ui/components/TerminalManager.js` returns at least 8 (declaration, has, set, get, push, get in closeTerminal, filter, delete, set)
2. `npm run build:renderer` succeeds without errors
3. `npm test` passes all existing tests
4. The `lastActivePerProject` Map is unchanged — same declaration, same set call, no removal
5. The code after the replaced block (stopProject, setActiveTerminal, filterByProject branches) is identical to the original
</verification>

<success_criteria>
- Closing a tab switches to the previously-active tab for the same project (not the first tab in insertion order)
- When all history entries are exhausted (all previously visited tabs closed), falls back to nearest neighbor in the tab strip
- Closing the last tab for a project shows the sessions panel (existing behavior)
- Phase 20 project-switch restore (lastActivePerProject) continues to work unchanged
- No new files, no IPC, no CSS, no i18n changes — single-file modification
</success_criteria>

<output>
After completion, create `.planning/phases/23-remember-last-active-tab-on-tab-closing/23-01-SUMMARY.md`
</output>
