---
phase: 11-explorer-natural-sorting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/state/settings.state.js
  - src/renderer/ui/panels/SettingsPanel.js
  - src/renderer/ui/components/FileExplorer.js
  - src/renderer/i18n/locales/en.json
  - src/renderer/i18n/locales/fr.json
autonomous: true
requirements: [EXPL-SORT-01]

must_haves:
  truths:
    - "File explorer sorts numeric filenames as numbers (file2 before file10) when natural sort is enabled"
    - "Directories always sort before files regardless of sort mode"
    - "Dotfiles/dotfolders sort at the top within their group (before regular items)"
    - "Special-character-prefixed names (_utils, -config) sort before alphanumeric names"
    - "Search results respect the same natural sort order as the tree view"
    - "User can toggle natural sort on/off from the Explorer settings group"
    - "Natural sort is enabled by default for new users and existing users upgrading"
  artifacts:
    - path: "src/renderer/ui/components/FileExplorer.js"
      provides: "Natural sort comparator and sorted tree + search results"
      contains: "_makeFileComparator"
    - path: "src/renderer/state/settings.state.js"
      provides: "explorerNaturalSort default setting"
      contains: "explorerNaturalSort"
    - path: "src/renderer/ui/panels/SettingsPanel.js"
      provides: "Natural sort toggle in Explorer settings group"
      contains: "explorer-natural-sort-toggle"
    - path: "src/renderer/i18n/locales/en.json"
      provides: "English i18n keys for natural sort"
      contains: "explorerNaturalSort"
    - path: "src/renderer/i18n/locales/fr.json"
      provides: "French i18n keys for natural sort"
      contains: "explorerNaturalSort"
  key_links:
    - from: "src/renderer/ui/components/FileExplorer.js"
      to: "src/renderer/state/settings.state.js"
      via: "getSetting('explorerNaturalSort') call-time read"
      pattern: "getSetting.*explorerNaturalSort"
    - from: "src/renderer/ui/panels/SettingsPanel.js"
      to: "src/renderer/state/settings.state.js"
      via: "saveSettings persists explorerNaturalSort from toggle"
      pattern: "explorer-natural-sort-toggle"
---

<objective>
Add natural sort to the file explorer so numeric filenames sort as numbers (file2 before file10), with a settings toggle in the Explorer group.

Purpose: Match Windows Explorer's natural sort behavior for a familiar file browsing experience.
Output: Natural sort comparator in FileExplorer.js, toggle in SettingsPanel.js, setting default and i18n keys.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-explorer-natural-sorting/11-RESEARCH.md
@.planning/phases/1.1-dotfile-visibility-setting/1.1-01-SUMMARY.md
@src/renderer/ui/components/FileExplorer.js
@src/renderer/ui/panels/SettingsPanel.js
@src/renderer/state/settings.state.js
@src/renderer/i18n/locales/en.json
@src/renderer/i18n/locales/fr.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add explorerNaturalSort setting, toggle UI in Explorer group, i18n keys, and save handler</name>
  <files>
    src/renderer/state/settings.state.js
    src/renderer/ui/panels/SettingsPanel.js
    src/renderer/i18n/locales/en.json
    src/renderer/i18n/locales/fr.json
  </files>
  <action>
    1. **settings.state.js** — Add `explorerNaturalSort: true` to the `defaultSettings` object, near the existing `showDotfiles: true` entry.

    2. **SettingsPanel.js** — Inside the Explorer `settings-group` `settings-card` (the one containing the `show-dotfiles-toggle`), append a new toggle row AFTER the showDotfiles row:
       ```html
       <div class="settings-toggle-row">
         <div class="settings-toggle-label">
           <div>${t('settings.explorerNaturalSort')}</div>
           <div class="settings-toggle-desc">${t('settings.explorerNaturalSortDesc')}</div>
         </div>
         <label class="settings-toggle">
           <input type="checkbox" id="explorer-natural-sort-toggle" ${settings.explorerNaturalSort !== false ? 'checked' : ''}>
           <span class="settings-toggle-slider"></span>
         </label>
       </div>
       ```
       Use `!== false` guard so undefined/missing defaults to checked (natural sort ON).

    3. **SettingsPanel.js saveSettings()** — After the existing `showDotfilesToggle` block, add:
       ```js
       const explorerNaturalSortToggle = document.getElementById('explorer-natural-sort-toggle');
       const newExplorerNaturalSort = explorerNaturalSortToggle ? explorerNaturalSortToggle.checked : true;
       ```
       Add `explorerNaturalSort: newExplorerNaturalSort` to the `newSettings` object.

    4. **en.json** — Add after `showDotfilesDesc`:
       ```json
       "explorerNaturalSort": "Natural sort",
       "explorerNaturalSortDesc": "Sort filenames with numbers as values (file2 before file10). Matches Windows Explorer behavior."
       ```

    5. **fr.json** — Add after `showDotfilesDesc`:
       ```json
       "explorerNaturalSort": "Tri naturel",
       "explorerNaturalSortDesc": "Trie les noms de fichiers en traitant les chiffres comme des valeurs (fichier2 avant fichier10). Correspond au comportement de l'Explorateur Windows."
       ```
  </action>
  <verify>
    <automated>npm test</automated>
    <manual>Verify settings.state.js has explorerNaturalSort default, SettingsPanel has toggle HTML and save handler, both i18n files have keys</manual>
  </verify>
  <done>explorerNaturalSort in defaultSettings, toggle renders in Explorer group with correct default, saveSettings persists the value, EN+FR i18n keys present</done>
</task>

<task type="auto">
  <name>Task 2: Add natural sort comparator to FileExplorer, sort tree and search results, build renderer</name>
  <files>
    src/renderer/ui/components/FileExplorer.js
  </files>
  <action>
    1. **FileExplorer.js — Module-level comparator functions** (add near top of file, after imports/constants):

       Create two `Intl.Collator` instances at module level (NOT inside functions):
       ```js
       const _collatorNatural = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
       const _collatorAlpha = new Intl.Collator(undefined, { sensitivity: 'base' });
       ```

       Add priority function:
       ```js
       function _getNamePriority(name) {
         if (name.startsWith('.')) return 0;             // dotfiles/dotfolders first
         if (/^[^a-zA-Z0-9\u00C0-\u024F]/.test(name)) return 1; // special chars (_,-,#,@) second
         return 2;                                        // normal alphanumeric last
       }
       ```

       Add comparator factory:
       ```js
       function _makeFileComparator(naturalSort) {
         const collator = naturalSort ? _collatorNatural : _collatorAlpha;
         return (a, b) => {
           // Directories always before files
           if (a.isDirectory && !b.isDirectory) return -1;
           if (!a.isDirectory && b.isDirectory) return 1;
           // Within same type: priority tier first
           const pa = _getNamePriority(a.name);
           const pb = _getNamePriority(b.name);
           if (pa !== pb) return pa - pb;
           // Same priority: name comparison
           return collator.compare(a.name, b.name);
         };
       }
       ```

    2. **FileExplorer.js — Replace sort in `readDirectoryAsync`** — Find the existing sort block:
       ```js
       result.sort((a, b) => {
         if (a.isDirectory && !b.isDirectory) return -1;
         if (!a.isDirectory && b.isDirectory) return 1;
         return a.name.localeCompare(b.name, undefined, { sensitivity: 'base' });
       });
       ```
       Replace with:
       ```js
       const explorerNaturalSort = getSetting('explorerNaturalSort');
       result.sort(_makeFileComparator(explorerNaturalSort !== false));
       ```
       Note: `getSetting` is already lazy-required earlier in the same function (from Phase 1.1's dotfiles pattern). Reuse the same reference if available, or add a second `getSetting('explorerNaturalSort')` call after the existing `getSetting('showDotfiles')` call.

    3. **FileExplorer.js — Sort search results in `performSearch`** — After the existing filter line:
       ```js
       searchResults = allFiles.filter(f => f.name.toLowerCase().includes(query));
       ```
       Add sort:
       ```js
       const explorerNaturalSort = getSetting('explorerNaturalSort');
       const _searchCollator = (explorerNaturalSort !== false) ? _collatorNatural : _collatorAlpha;
       searchResults.sort((a, b) => _searchCollator.compare(a.name, b.name));
       ```
       Note: Search results are files only (no directories), so no directory-first or priority tier logic is needed — just name comparison. Lazy-require `getSetting` from `../../state/settings.state` if not already available in this scope.

    4. **Build renderer** — Run `npm run build:renderer` to bundle changes into `dist/renderer.bundle.js`.

    5. **Run tests** — Run `npm test` to confirm no regressions.
  </action>
  <verify>
    <automated>npm run build:renderer && npm test</automated>
    <manual>Grep for _makeFileComparator, _collatorNatural, _getNamePriority in FileExplorer.js to confirm all pieces present</manual>
  </verify>
  <done>FileExplorer tree sorts with natural sort comparator when enabled and alphabetical when disabled; search results sorted consistently; renderer builds; all tests pass</done>
</task>

</tasks>

<verification>
1. `grep -c "explorerNaturalSort" src/renderer/state/settings.state.js` returns >= 1
2. `grep -c "explorer-natural-sort-toggle" src/renderer/ui/panels/SettingsPanel.js` returns >= 2 (toggle HTML + save handler)
3. `grep -c "_makeFileComparator" src/renderer/ui/components/FileExplorer.js` returns >= 2 (definition + usage)
4. `grep -c "_collatorNatural" src/renderer/ui/components/FileExplorer.js` returns >= 2 (definition + usage in search)
5. `grep -c "explorerNaturalSort" src/renderer/i18n/locales/en.json` returns >= 2
6. `grep -c "explorerNaturalSort" src/renderer/i18n/locales/fr.json` returns >= 2
7. `npm test` passes with 0 failures
8. `npm run build:renderer` succeeds
</verification>

<success_criteria>
- explorerNaturalSort defaults to true in settings.state.js
- Toggle renders in Explorer settings group (alongside showDotfiles toggle)
- saveSettings persists the toggle state
- FileExplorer tree uses natural sort comparator (Intl.Collator numeric) when enabled
- Dotfiles sort before regular items within each group
- Special-character-prefixed names sort before alphanumeric names
- Search results sorted with same comparator
- EN and FR i18n keys present
- Renderer builds successfully
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-explorer-natural-sorting/11-01-SUMMARY.md`
</output>
