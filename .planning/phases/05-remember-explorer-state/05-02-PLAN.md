---
phase: 05-remember-explorer-state
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - renderer.js
autonomous: true
requirements: [EXPL-01, EXPL-02]

must_haves:
  truths:
    - "On project switch, expanded folders from the previous session are restored"
    - "On app restart, the last project's expanded folders reappear as saved"
    - "Panel visibility is per-project — hiding panel on project A does not affect project B"
    - "Missing folders on disk are silently skipped during restore"
  artifacts:
    - path: "renderer.js"
      provides: "Explorer state restore on project switch via setRootPath(path, explorerState)"
      contains: "explorer"
  key_links:
    - from: "renderer.js"
      to: "src/renderer/ui/components/FileExplorer.js"
      via: "setRootPath(project.path, explorerState)"
      pattern: "setRootPath.*explorer"
    - from: "renderer.js"
      to: "src/renderer/services/TerminalSessionService.js"
      via: "loadSessionData() to read saved explorer state"
      pattern: "loadSessionData.*explorer"
---

<objective>
Wire explorer state restore into the renderer.js project-switch subscriber so saved expanded folders and panel visibility are applied whenever the user switches projects or the app starts up.

Purpose: Plan 05-01 created the save/load infrastructure. This plan closes the loop by reading saved state and passing it to FileExplorer.setRootPath() on project switch.
Output: renderer.js passes saved explorer state to setRootPath on every project switch, including the initial startup restore.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-remember-explorer-state/05-RESEARCH.md
@.planning/phases/05-remember-explorer-state/05-01-PLAN.md
@renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pass saved explorer state to FileExplorer.setRootPath in project-switch subscriber</name>
  <files>renderer.js</files>
  <action>
Modify the `projectsState.subscribe()` callback near line 1509 that calls `FileExplorer.setRootPath()`. This is the single hook that fires on every project switch AND on startup (when setSelectedProjectFilter is called during the Phase 4 restore).

**Current code (around line 1509-1519):**
```js
projectsState.subscribe(() => {
  const state = projectsState.get();
  const selectedFilter = state.selectedProjectFilter;
  const projects = state.projects;

  if (selectedFilter !== null && projects[selectedFilter]) {
    FileExplorer.setRootPath(projects[selectedFilter].path);
  } else {
    FileExplorer.hide();
  }
});
```

**Replace with:**
```js
projectsState.subscribe(() => {
  const state = projectsState.get();
  const selectedFilter = state.selectedProjectFilter;
  const projects = state.projects;

  if (selectedFilter !== null && projects[selectedFilter]) {
    const project = projects[selectedFilter];
    // Load saved explorer state for this project (expanded folders, panel visibility)
    const sessionData = loadSessionData();
    const explorerState = sessionData?.projects?.[project.id]?.explorer || null;
    FileExplorer.setRootPath(project.path, explorerState);
  } else {
    FileExplorer.hide();
  }
});
```

**Key points:**
- `loadSessionData()` is already imported at the top of renderer.js (from Phase 4 restore code). Verify it is available at this scope — it should be since Phase 4 added `const { loadSessionData, ... } = require(...)` at file top level.
- The `explorerState` object has shape `{ expandedPaths: string[], panelVisible: boolean }` or `null` if no saved state exists.
- When `explorerState` is `null`, `setRootPath()` defaults to showing the panel (new project behavior, per Plan 05-01).
- This works for both project switch (user clicks a different project) AND app startup (Phase 4 restore calls `setSelectedProjectFilter` which triggers this subscriber).
- No separate startup restore code is needed — the existing subscription path handles everything.

**Verify `loadSessionData` import exists** — search for `loadSessionData` in the top of renderer.js. If imported from TerminalSessionService, it's ready. If not, add:
```js
const { loadSessionData } = require('./src/renderer/services/TerminalSessionService');
```
(But Phase 4 already added this import — just confirm.)
  </action>
  <verify>
    <automated>npm run build:renderer 2>&1 | tail -5</automated>
    <manual>Verify the projectsState.subscribe callback near line 1509 passes explorerState to setRootPath</manual>
  </verify>
  <done>Project-switch subscriber reads saved explorer state from terminal-sessions.json and passes it to FileExplorer.setRootPath, restoring expanded folders and panel visibility on every project switch and app startup</done>
</task>

<task type="auto">
  <name>Task 2: Build renderer and run tests to verify no regressions</name>
  <files>dist/renderer.bundle.js</files>
  <action>
Run the full build and test suite to verify all changes from both Plan 05-01 and Plan 05-02 work together:

1. `npm run build:renderer` — must complete with exit code 0
2. `npm test` — all existing tests must pass (expect 262+ tests, 0 failures)

If build fails, fix any syntax errors in the modified files (FileExplorer.js, TerminalSessionService.js, renderer.js).
If tests fail, check for:
- Circular dependency issues (lazy require not working)
- Missing exports in FileExplorer.js module.exports
- Incorrect variable names in TerminalSessionService.js merge logic
  </action>
  <verify>
    <automated>npm run build:renderer && npm test 2>&1 | tail -20</automated>
  </verify>
  <done>Build succeeds, all tests pass, no regressions introduced by Phase 5 changes</done>
</task>

</tasks>

<verification>
1. `npm run build:renderer` exits 0
2. `npm test` all suites pass
3. `grep -n "explorerState\|explorer" renderer.js` shows explorer state loaded and passed to setRootPath
4. The project-switch subscription reads from loadSessionData and passes explorer object
5. No separate startup restore code — the existing subscriber path covers startup via Phase 4's setSelectedProjectFilter call
</verification>

<success_criteria>
- Project switch restores expanded folders by reading saved explorer state from terminal-sessions.json
- App startup restores explorer state via the same subscriber path (no separate startup code)
- Panel visibility is per-project (hiding panel on project A, switching to project B shows panel if B had it visible)
- Build and all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-remember-explorer-state/05-02-SUMMARY.md`
</output>
