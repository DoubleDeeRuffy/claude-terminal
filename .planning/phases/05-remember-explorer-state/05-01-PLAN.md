---
phase: 05-remember-explorer-state
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/ui/components/FileExplorer.js
  - src/renderer/services/TerminalSessionService.js
autonomous: true
requirements: [EXPL-01, EXPL-02, EXPL-03, EXPL-04]

must_haves:
  truths:
    - "FileExplorer exposes getState() returning { expandedPaths, panelVisible }"
    - "FileExplorer exposes restoreState({ expandedPaths, panelVisible }) that re-expands folders and sets panel visibility"
    - "setRootPath accepts optional savedState parameter and calls restoreState when provided"
    - "TerminalSessionService reads FileExplorer.getState() during save and writes explorer key per project"
    - "Existing terminal session data for other projects is preserved when saving (merge-before-write)"
    - "toggleFolder, show, and hide trigger a debounced save via saveTerminalSessions"
  artifacts:
    - path: "src/renderer/ui/components/FileExplorer.js"
      provides: "getState, restoreState functions and save triggers in toggleFolder/show/hide"
      contains: "function getState"
    - path: "src/renderer/services/TerminalSessionService.js"
      provides: "Explorer state merged into terminal-sessions.json per project"
      contains: "FileExplorer.getState"
  key_links:
    - from: "src/renderer/ui/components/FileExplorer.js"
      to: "src/renderer/services/TerminalSessionService.js"
      via: "lazy require of saveTerminalSessions in toggleFolder/show/hide"
      pattern: "saveTerminalSessions"
    - from: "src/renderer/services/TerminalSessionService.js"
      to: "src/renderer/ui/components/FileExplorer.js"
      via: "lazy require of FileExplorer.getState in saveTerminalSessionsImmediate"
      pattern: "FileExplorer.*getState"
---

<objective>
Add explorer state persistence infrastructure: export getState/restoreState from FileExplorer.js, extend TerminalSessionService to merge explorer state into terminal-sessions.json, and hook save triggers into FileExplorer's state-changing operations.

Purpose: This plan creates the save/load plumbing so explorer state can be persisted. Plan 05-02 wires the restore path into renderer.js.
Output: FileExplorer.js gains getState/restoreState/setRootPath(path, savedState), TerminalSessionService writes explorer data per project, toggleFolder/show/hide trigger saves.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-remember-explorer-state/05-RESEARCH.md
@src/renderer/ui/components/FileExplorer.js
@src/renderer/services/TerminalSessionService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getState, restoreState, and extended setRootPath to FileExplorer.js; add save triggers</name>
  <files>src/renderer/ui/components/FileExplorer.js</files>
  <action>
Add three new functions and modify three existing ones in FileExplorer.js:

**1. Add `getState()` function** (before `module.exports`):
```js
function getState() {
  return {
    expandedPaths: [...expandedFolders.keys()].filter(p => {
      const entry = expandedFolders.get(p);
      return entry && entry.loaded;
    }),
    panelVisible: isVisible
  };
}
```
Only persist paths where `entry.loaded === true` (skip in-flight loads).

**2. Add `restoreState(savedState)` function** (after getState):
```js
function restoreState(savedState) {
  const { expandedPaths = [], panelVisible = true } = savedState;
  if (!panelVisible) {
    manuallyHidden = true;
    const panel = document.getElementById('file-explorer-panel');
    if (panel) { panel.style.display = 'none'; isVisible = false; }
  } else {
    manuallyHidden = false;
    show();
  }
  for (const folderPath of expandedPaths) {
    try {
      if (!fs.existsSync(folderPath)) continue;
      if (!isPathSafe(folderPath)) continue;
      getOrLoadFolder(folderPath);
    } catch (e) { /* silently skip */ }
  }
}
```
Key: reset `manuallyHidden` from saved state to prevent cross-project bleed. Use `isPathSafe()` as security guard. Fire all `getOrLoadFolder` calls synchronously (each async-loads and re-renders on completion).

**3. Modify `setRootPath(projectPath)` to accept optional `savedState` parameter:**
Change signature to `setRootPath(projectPath, savedState = null)`. After the existing clears (selectedFiles, expandedFolders, gitStatusMap, searchQuery, searchResults), replace the current `if (rootPath && !manuallyHidden)` block:
```js
if (!rootPath) return;
if (savedState) {
  restoreState(savedState);
} else {
  manuallyHidden = false;
  show();
  render();
}
updateSearchBarVisibility();
```
This ensures new projects (no saved state) default to panel visible, while projects with saved state respect their saved panel visibility.

**4. Add `_triggerSave()` helper** (module-level, before getState):
```js
function _triggerSave() {
  try {
    const { saveTerminalSessions } = require('../../services/TerminalSessionService');
    saveTerminalSessions();
  } catch (e) { /* ignore — circular dep protection */ }
}
```
Uses lazy require to avoid circular dependency at module load time. saveTerminalSessions is already debounced at 300ms, so no additional debounce needed.

**5. Add save trigger calls** in three existing functions:
- `toggleFolder(folderPath)`: Add `_triggerSave();` after the if/else-if block (after line 1112, before the comment about still loading).
- `show()`: Add `_triggerSave();` at the end of the function body (after `updateSearchBarVisibility()`).
- `hide()`: Add `_triggerSave();` at the end of the function body (after `stopGitStatusPolling()`).

**6. Update `module.exports`** to include `getState` and `restoreState`:
```js
module.exports = {
  setCallbacks,
  setRootPath,
  show,
  hide,
  toggle,
  init,
  getState,
  restoreState
};
```
  </action>
  <verify>
    <automated>npm run build:renderer 2>&1 | tail -5</automated>
    <manual>Check that getState, restoreState, _triggerSave are defined and exported</manual>
  </verify>
  <done>FileExplorer.js exports getState() and restoreState(), setRootPath accepts savedState parameter, toggleFolder/show/hide each call _triggerSave()</done>
</task>

<task type="auto">
  <name>Task 2: Extend TerminalSessionService to persist explorer state with merge-before-write</name>
  <files>src/renderer/services/TerminalSessionService.js</files>
  <action>
Modify `saveTerminalSessionsImmediate()` in TerminalSessionService.js to also persist explorer state:

**1. Add lazy require for FileExplorer** at the top of the function (after existing lazy requires):
```js
const FileExplorer = require('../ui/components/FileExplorer');
```

**2. After the `projectsMap` is built from terminals, add merge-before-write logic** to preserve other projects' explorer state. Insert before the `lastOpenedProjectId` resolution:

```js
// Merge existing explorer state from disk (preserve state for projects not currently active)
const existingData = loadSessionData();
for (const [pid, existing] of Object.entries(existingData.projects || {})) {
  if (existing.explorer) {
    if (!projectsMap[pid]) {
      projectsMap[pid] = { tabs: [], activeCwd: null };
    }
    projectsMap[pid].explorer = existing.explorer;
  }
}
```

**3. After the merge, override current project's explorer with live state** (insert after the merge block, before `lastOpenedProjectId`):

```js
// Override current project's explorer state with live data
const projectsStateData = projectsState.get();
const idx = projectsStateData.selectedProjectFilter;
const currentProject = (idx !== null && idx !== undefined) ? projectsStateData.projects[idx] : null;
if (currentProject) {
  if (!projectsMap[currentProject.id]) {
    projectsMap[currentProject.id] = { tabs: [], activeCwd: null };
  }
  try {
    projectsMap[currentProject.id].explorer = FileExplorer.getState();
  } catch (e) {
    // FileExplorer not initialized yet — skip
  }
}
```

**4. Update the `lastOpenedProjectId` resolution** to reuse `currentProject` instead of re-reading projectsState. The existing lines that compute `projectsStateData`, `idx`, and `lastOpenedProjectId` should be refactored — `projectsStateData` and `idx` are now read earlier (step 3). Move the `lastOpenedProjectId` computation to use the already-resolved `currentProject`:

```js
const lastOpenedProjectId = currentProject ? currentProject.id : null;
```

Remove the duplicate `projectsStateData` and `idx` declarations that previously existed at this location.

**Important:** The `loadSessionData()` call inside the save function is necessary to merge existing explorer state for inactive projects. Without it, switching projects would lose the previous project's saved explorer state because the terminal scan only captures terminals (not explorer data) for the new project.
  </action>
  <verify>
    <automated>npm run build:renderer 2>&1 | tail -5</automated>
    <manual>Verify that saveTerminalSessionsImmediate reads FileExplorer.getState and merges existing explorer data</manual>
  </verify>
  <done>TerminalSessionService persists explorer: { expandedPaths, panelVisible } per project in terminal-sessions.json, preserving other projects' explorer state via merge-before-write</done>
</task>

</tasks>

<verification>
1. `npm run build:renderer` completes without errors
2. `npm test` passes all existing tests (no regressions)
3. `grep -n "getState\|restoreState\|_triggerSave" src/renderer/ui/components/FileExplorer.js` shows all three functions defined
4. `grep -n "FileExplorer.getState\|existing.explorer\|explorer:" src/renderer/services/TerminalSessionService.js` shows explorer integration in save
5. `grep -n "getState\|restoreState" src/renderer/ui/components/FileExplorer.js | grep "module.exports" -A 10` confirms both are exported
</verification>

<success_criteria>
- FileExplorer.js exports getState() and restoreState()
- setRootPath(path, savedState) applies saved state when provided
- toggleFolder, show, hide each trigger debounced save via TerminalSessionService
- TerminalSessionService merges existing explorer state before writing (other projects' state preserved)
- Current project's explorer state is written from live FileExplorer.getState()
- Build and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-remember-explorer-state/05-01-SUMMARY.md`
</output>
