---
phase: 24-shift-return-race-condition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/ui/components/ChatView.js
  - styles/chat.css
autonomous: true
requirements: []

must_haves:
  truths:
    - "Shift+Return always inserts a newline in the chat input — never submits"
    - "Return without Shift always submits the message"
    - "Newlines inserted by Shift+Return produce single-spaced lines (no excessive gap)"
    - "Shift key state resets correctly after window blur (no sticky-shift bug)"
  artifacts:
    - path: "src/renderer/ui/components/ChatView.js"
      provides: "Tracked shiftHeld boolean with keydown/keyup/blur listeners replacing e.shiftKey in Enter handler"
      contains: "shiftHeld"
    - path: "styles/chat.css"
      provides: "Tighter line-height on .chat-input textarea for single-spaced multiline"
      contains: "line-height"
  key_links:
    - from: "wrapperEl keydown/keyup listeners"
      to: "inputEl Enter keydown handler"
      via: "shiftHeld closure variable"
      pattern: "shiftHeld"
---

<objective>
Fix the Shift+Return race condition in the chat input and reduce the excessive line gap when multiline input is used.

Purpose: Shift+Return randomly fires as plain Return (submitting the message) due to `e.shiftKey` being unreliable in fast keydown sequences. The fix tracks Shift key state independently via keydown/keyup listeners. The line gap fix reduces CSS line-height to produce visually single-spaced lines.

Output: Reliable Shift+Return newline insertion and tighter multiline line spacing in the chat textarea.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-shift-return-race-condition/24-RESEARCH.md
@src/renderer/ui/components/ChatView.js
@styles/chat.css

<interfaces>
<!-- From ChatView.js lines 466-474 — existing capture-phase wrapperEl keydown listener -->
wrapperEl.addEventListener('keydown', (e) => {
  if (e.ctrlKey && !e.shiftKey && !e.altKey) {
    if (e.key === 'ArrowLeft' && onSwitchTerminal) { e.preventDefault(); e.stopPropagation(); onSwitchTerminal('left'); return; }
    if (e.key === 'ArrowRight' && onSwitchTerminal) { e.preventDefault(); e.stopPropagation(); onSwitchTerminal('right'); return; }
    if (e.key === 'ArrowUp' && onSwitchProject) { e.preventDefault(); e.stopPropagation(); onSwitchProject('up'); return; }
    if (e.key === 'ArrowDown' && onSwitchProject) { e.preventDefault(); e.stopPropagation(); onSwitchProject('down'); return; }
  }
}, true);

<!-- From ChatView.js lines 542-545 — current Enter handler (race condition site) -->
if (e.key === 'Enter' && !e.shiftKey) {
  e.preventDefault();
  handleSend();
}

<!-- From chat.css lines 2385-2398 — current .chat-input styles -->
.chat-input {
  flex: 1;
  background: transparent;
  border: none;
  padding: 12px 16px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: inherit;
  resize: none;
  min-height: 22px;
  max-height: 200px;
  line-height: 1.5;
  outline: none;
}
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Track Shift key state independently and replace e.shiftKey in Enter handler</name>
  <files>src/renderer/ui/components/ChatView.js</files>
  <action>
In `src/renderer/ui/components/ChatView.js`, inside the `createChatView` function scope (near the existing event listeners around line 466):

1. **Declare a tracked variable** in the closure scope (before the wrapperEl keydown listener):
   ```javascript
   let shiftHeld = false;
   ```

2. **Add Shift tracking to the existing wrapperEl capture-phase keydown listener** (line 466). Inside the existing listener body, BEFORE the `if (e.ctrlKey ...)` block, add:
   ```javascript
   if (e.key === 'Shift') shiftHeld = true;
   ```
   This goes inside the already-existing `wrapperEl.addEventListener('keydown', (e) => { ... }, true)` — do NOT create a second keydown listener on wrapperEl.

3. **Add a keyup listener on wrapperEl** (capture phase) right after the existing keydown listener:
   ```javascript
   wrapperEl.addEventListener('keyup', (e) => {
     if (e.key === 'Shift') shiftHeld = false;
   }, true);
   ```

4. **Add a blur listener on window** to reset shiftHeld when the app loses focus (prevents sticky-shift after Alt+Tab):
   ```javascript
   window.addEventListener('blur', () => { shiftHeld = false; });
   ```
   Place this right after the keyup listener.

5. **Replace `e.shiftKey` with `shiftHeld`** in the Enter handler at line 542. Change:
   ```javascript
   if (e.key === 'Enter' && !e.shiftKey) {
   ```
   to:
   ```javascript
   if (e.key === 'Enter' && !shiftHeld) {
   ```

**Why:** The Shift keydown event always fires before the Enter keydown event (OS guarantees modifier keys fire first), so `shiftHeld` is set to `true` before the Enter handler reads it. This eliminates the timing window where `e.shiftKey` may be stale/false during fast Shift+Enter sequences.

**Do NOT:**
- Create a separate keydown listener on wrapperEl — reuse the existing one at line 466
- Touch any code in TerminalManager.js — the PTY terminal Shift+Enter was fixed in Quick Task 1
- Call `e.preventDefault()` when shiftHeld is true — let the browser's native textarea newline insertion handle it (current behavior, preserved)
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && grep -n "shiftHeld" src/renderer/ui/components/ChatView.js | head -10</automated>
    Expect: `shiftHeld` appears in at least 5 locations (declaration, keydown set, keyup reset, blur reset, Enter guard).
    Also verify `e.shiftKey` no longer appears in the Enter handler: `grep -n "e.shiftKey" src/renderer/ui/components/ChatView.js` should NOT show line 542's Enter guard.
  </verify>
  <done>
    - `shiftHeld` boolean declared in createChatView closure
    - Shift tracking added to existing wrapperEl capture keydown listener
    - keyup listener on wrapperEl resets shiftHeld
    - window blur listener resets shiftHeld
    - Enter handler uses `!shiftHeld` instead of `!e.shiftKey`
    - No changes to TerminalManager.js
  </done>
</task>

<task type="auto">
  <name>Task 2: Reduce line-height on .chat-input for tighter multiline spacing</name>
  <files>styles/chat.css</files>
  <action>
In `styles/chat.css`, find the `.chat-input` rule (around line 2385-2398).

1. **Change `line-height`** from `1.5` to `1.4`:
   ```css
   line-height: 1.4;
   ```

   With `font-size: 13px`, this changes per-line height from 19.5px to 18.2px — a subtle tightening that brings multiline Shift+Enter text closer to single-spaced appearance without cramping readability.

**Why 1.4 and not lower:** The chat input should visually match the line density of chat message bubbles (`.chat-msg` uses `line-height: 1.5`). Going to 1.4 provides noticeably tighter spacing while remaining close to the bubble density. Going below 1.4 would look cramped for a text input.

**Do NOT:**
- Change the `padding` values (12px 16px) — these affect the overall input box size, not per-line spacing
- Change the auto-resize JavaScript logic in ChatView.js — the `scrollHeight`-based resize is correct
- Change `min-height` or `max-height`
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && grep "line-height" styles/chat.css | grep "chat-input" -A2 || grep -A5 "\.chat-input {" styles/chat.css | grep "line-height"</automated>
    Expect: `line-height: 1.4;` in the .chat-input rule.
  </verify>
  <done>
    - `.chat-input` line-height changed from 1.5 to 1.4
    - No other CSS properties modified
    - Multiline text in chat input appears single-spaced (tighter than before)
  </done>
</task>

</tasks>

<verification>
1. `grep -c "shiftHeld" src/renderer/ui/components/ChatView.js` returns >= 5
2. `grep "Enter.*shiftHeld" src/renderer/ui/components/ChatView.js` shows the Enter guard uses shiftHeld
3. `grep "e\.shiftKey" src/renderer/ui/components/ChatView.js` does NOT appear in the Enter handler line (may still appear in the Ctrl+Arrow guard at line 468 — that is correct and unchanged)
4. `grep "line-height: 1.4" styles/chat.css` matches within the .chat-input rule
5. `npm run build:renderer` succeeds
6. `npm test` passes
</verification>

<success_criteria>
- Shift+Return in chat input always inserts a newline (never submits)
- Return without Shift always submits the message
- Multiline lines in the chat input appear single-spaced (no excessive gap)
- No regressions: Ctrl+Arrow terminal/project switching still works, mention/slash dropdowns still work
- Build and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/24-shift-return-race-condition/24-01-SUMMARY.md`
</output>
