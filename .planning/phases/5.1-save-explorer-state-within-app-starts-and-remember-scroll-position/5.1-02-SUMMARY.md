---
phase: 5.1-save-explorer-state-within-app-starts-and-remember-scroll-position
plan: 02
subsystem: renderer
tags: [file-explorer, scroll-persistence, cold-start-fix, quit-flush]
dependency_graph:
  requires: [5.1-01 (_skipExplorerCapture flag, saveTerminalSessionsImmediate, scrollTop in FileExplorer.getState)]
  provides: [setSkipExplorerCapture wired around restore loop, saveTerminalSessionsImmediate in quit handlers]
  affects: [renderer.js]
tech_stack:
  added: []
  patterns: [lazy require inside callback, guard flag around restore loop]
key_files:
  created: []
  modified:
    - renderer.js
decisions:
  - setSkipExplorerCapture(false) placed inside the sessionData.projects block (not in catch) — only called when restore ran, so the flag is always paired with the matching true call
  - saveTerminalSessionsImmediate called after saveAndShutdown in both quit handlers — time tracking flushes first, explorer flush follows; order is inconsequential but consistent
metrics:
  duration: ~3 minutes
  completed: 2026-02-25
  tasks_completed: 2
  files_modified: 1
---

# Phase 5.1 Plan 02: Wire skipExplorerCapture and Quit Flush in renderer.js Summary

**One-liner:** Wired `setSkipExplorerCapture(true/false)` around the startup terminal restore loop and added `saveTerminalSessionsImmediate()` to both quit handlers so scroll position and explorer state survive app restarts.

## What Was Built

### Task 1: Wrap terminal restore loop with setSkipExplorerCapture flag

In `renderer.js`, inside the terminal restore `try` block (after the `sessionData.projects` null check), added a lazy require of `setSkipExplorerCapture` from `TerminalSessionService` and set it to `true` before the `for (const projectId of ...)` loop begins.

After the loop and the `lastOpenedProjectId` restore (inside the same `if (sessionData && sessionData.projects)` block), set the flag back to `false`.

This ensures that every `saveTerminalSessions()` call triggered by `TerminalManager.createTerminal()` during startup does NOT overwrite the explorer state on disk with the empty live state. The saved explorer state (including `scrollTop`, expanded folders, selected path) is preserved until the normal projectsState subscriber fires after restore completes.

### Task 2: Add before-quit flush for explorer state including scroll position

Added `saveTerminalSessionsImmediate()` calls in both quit handlers in `renderer.js`:

- `onWillQuit` handler: after the existing `saveAndShutdown()` call
- `beforeunload` handler: after the existing `saveAndShutdown()` call

Both use the lazy require pattern (require inside the callback) consistent with other Phase 4/5 patterns. This ensures that any debounced scroll position changes (500ms debounce from FileExplorer's scroll listener) that haven't been written yet are flushed atomically to `terminal-sessions.json` before the process exits.

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| Task 1 | `47005ad` | feat(5.1-02): wrap terminal restore loop with setSkipExplorerCapture flag |
| Task 2 | `3d4e6b6` | feat(5.1-02): flush explorer state including scrollTop on quit |

## Deviations from Plan

None — plan executed exactly as written.

## Decisions Made

1. **`setSkipExplorerCapture(false)` inside `if (sessionData && sessionData.projects)` block** — The flag is only set to `true` when the restore block executes. Placing the reset inside the same conditional ensures exact pairing without a try/finally structure. The catch block does not need to reset it since it was never set if the data check failed.

2. **`saveTerminalSessionsImmediate` after `saveAndShutdown` in both handlers** — Order is inconsequential for correctness (they write to different files), but calling time-tracking flush first and explorer flush second is logically consistent with the comment "TIME TRACKING SAVE ON QUIT".

## Self-Check: PASSED

- `renderer.js` modified — contains `setSkipExplorerCapture(true)` at line 186, `setSkipExplorerCapture(false)` at line 230, `saveTerminalSessionsImmediate` at lines 3757-3758 (onWillQuit) and 3765-3766 (beforeunload)
- Commits `47005ad` and `3d4e6b6` exist in git log
- `npm run build:renderer` passes
- `npm test` — 262/262 tests pass
