---
phase: 5.1-save-explorer-state-within-app-starts-and-remember-scroll-position
plan: 02
type: execute
wave: 2
depends_on: ["5.1-01"]
files_modified:
  - renderer.js
autonomous: true
requirements: [EXPL-01, EXPL-03]

must_haves:
  truths:
    - "Terminal restore loop does not overwrite saved explorer state on disk"
    - "Explorer state is flushed to disk on app quit (before-quit and beforeunload)"
    - "Scroll position included in the flushed state on quit"
  artifacts:
    - path: "renderer.js"
      provides: "setSkipExplorerCapture(true) before restore loop, setSkipExplorerCapture(false) after; saveTerminalSessionsImmediate in onWillQuit and beforeunload handlers"
      contains: "setSkipExplorerCapture"
  key_links:
    - from: "renderer.js"
      to: "src/renderer/services/TerminalSessionService.js"
      via: "setSkipExplorerCapture call wrapping terminal restore loop"
      pattern: "setSkipExplorerCapture\\(true\\)"
    - from: "renderer.js"
      to: "src/renderer/services/TerminalSessionService.js"
      via: "saveTerminalSessionsImmediate call in quit handlers"
      pattern: "saveTerminalSessionsImmediate"
---

<objective>
Wire the cold-start fix into renderer.js by setting _skipExplorerCapture around the terminal restore loop, and add before-quit flush to persist scroll position on app close.

Purpose: Plan 01 added the _skipExplorerCapture guard to TerminalSessionService and scrollTop to FileExplorer. This plan activates the guard during the startup terminal restore loop (preventing explorer state overwrite) and ensures explorer+scroll state is flushed to disk on quit.

Output: renderer.js with skipExplorerCapture flag set during restore loop, and saveTerminalSessionsImmediate called in onWillQuit + beforeunload handlers.
</objective>

<execution_context>
@C:/Users/uhgde/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/uhgde/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/5.1-save-explorer-state-within-app-starts-and-remember-scroll-position/5.1-RESEARCH.md
@.planning/phases/5.1-save-explorer-state-within-app-starts-and-remember-scroll-position/5.1-01-SUMMARY.md
@renderer.js
@src/renderer/services/TerminalSessionService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wrap terminal restore loop with setSkipExplorerCapture flag</name>
  <files>renderer.js</files>
  <action>
Find the terminal restore loop in renderer.js (the startup code that creates terminals from saved sessions — around lines 179-229, the section that iterates over saved tabs and calls createTerminal, ending with the setSelectedProjectFilter call).

Before the restore loop begins (before the `for` loop or the code that reads session data for terminal restoration), add:
```js
const { setSkipExplorerCapture } = require('./src/renderer/services/TerminalSessionService');
setSkipExplorerCapture(true);
```

After the restore loop completes (after `setSelectedProjectFilter(idx)` and the last-opened-project restoration), add:
```js
setSkipExplorerCapture(false);
```

This ensures that any `saveTerminalSessions()` calls triggered during terminal creation do NOT overwrite the saved explorer state on disk. Once restore is complete and the projectsState subscriber fires with the correct explorerState from disk, normal save behavior resumes.

Note: Use the lazy-require pattern (require inside the function) consistent with existing Phase 4 patterns in renderer.js. The require can be at the top of the restore block.
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && npm run build:renderer 2>&1 | tail -3 && npm test 2>&1 | tail -5</automated>
    <manual>Grep renderer.js for setSkipExplorerCapture — should appear twice: (true) before restore loop, (false) after</manual>
  </verify>
  <done>Terminal restore loop is bracketed with setSkipExplorerCapture(true/false) — saveTerminalSessionsImmediate preserves saved explorer state during startup terminal creation</done>
</task>

<task type="auto">
  <name>Task 2: Add before-quit flush for explorer state including scroll position</name>
  <files>renderer.js</files>
  <action>
Find the existing `onWillQuit` handler in renderer.js (around line 3749, where `saveAndShutdown()` is called for time tracking). Add a call to `saveTerminalSessionsImmediate()` in the same handler to flush any pending explorer state (including the newly added scrollTop) to disk:

```js
// In the onWillQuit handler, after the existing saveAndShutdown() call:
const { saveTerminalSessionsImmediate } = require('./src/renderer/services/TerminalSessionService');
saveTerminalSessionsImmediate();
```

Also find the `beforeunload` handler (if it exists) and add the same flush call there. If no `beforeunload` handler exists, add one:

```js
window.addEventListener('beforeunload', () => {
  const { saveTerminalSessionsImmediate } = require('./src/renderer/services/TerminalSessionService');
  saveTerminalSessionsImmediate();
});
```

This ensures that any debounced scroll position changes that haven't been flushed yet are written to disk before the app closes. Uses the existing `saveTerminalSessionsImmediate` which calls `FileExplorer.getState()` (now including scrollTop) and writes to terminal-sessions.json atomically.

Use lazy require (require inside the callback) consistent with existing patterns.
  </action>
  <verify>
    <automated>cd C:/Users/uhgde/source/repos/claude-terminal && npm run build:renderer 2>&1 | tail -3 && npm test 2>&1 | tail -5</automated>
    <manual>Grep renderer.js for saveTerminalSessionsImmediate — should appear in onWillQuit handler and beforeunload handler</manual>
  </verify>
  <done>onWillQuit and beforeunload both call saveTerminalSessionsImmediate to flush explorer state (including scrollTop) before app closes</done>
</task>

</tasks>

<verification>
1. `npm run build:renderer` succeeds
2. `npm test` — all tests pass
3. Grep renderer.js for `setSkipExplorerCapture(true)` — appears before terminal restore loop
4. Grep renderer.js for `setSkipExplorerCapture(false)` — appears after terminal restore loop
5. Grep renderer.js for `saveTerminalSessionsImmediate` — appears in onWillQuit and beforeunload handlers
</verification>

<success_criteria>
- Terminal restore loop bracketed with setSkipExplorerCapture(true/false)
- onWillQuit handler calls saveTerminalSessionsImmediate after existing saveAndShutdown
- beforeunload handler calls saveTerminalSessionsImmediate
- Build and all tests pass
- Cold start no longer overwrites explorer state — folders and scroll position survive restart
</success_criteria>

<output>
After completion, create `.planning/phases/5.1-save-explorer-state-within-app-starts-and-remember-scroll-position/5.1-02-SUMMARY.md`
</output>
